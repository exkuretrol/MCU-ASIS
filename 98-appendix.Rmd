\cleardoublepage

# (APPENDIX) é™„éŒ„ {.unnumbered}

# ç›¸é—œè»Ÿé«”

<!-- å› ç‚ºå…§å®¹å¤ªå¤šï¼Œæ›¸æœ¬ç¯‡æ”¶éŒ„çš„æœƒè®Šå¾—å¤ªæ··é›œï¼Œæ‰€ä»¥æˆ‘æŠŠä¸€äº›å…§å®¹æ”¾åˆ°é€™è£¡ã€‚ -->

<!-- ## ç”± Windows 10 ç³»çµ±é€²å…¥ BIOS {.unnumbered .hidden} -->

<!-- ## Windows Terminal -->

## PuTTY

ä½¿ç”¨ PuTTY é€£ç·šè‡³ OpenSSH ä¼ºæœå™¨

### ä»¥ PuTTY ç”¢ç”Ÿ key

å¦ä¸€å€‹æ–¹æ³•ä¸æœƒéœ€è¦ä½ æ‰‹å‹•å®‰è£ OpenSSH Clientï¼Œä¸éã€ä¸€æ¨£åœ°ï¼Œè¦å®‰è£PuTTY ç¨‹å¼ã€‚

#### Step 1 --- å®‰è£ PuTTY

åˆ°é–‹ç™¼è€…çš„ç¶²ç«™ï¼Œç„¶å¾Œä¸‹è¼‰é©åˆä½  Windows çš„ç‰ˆæœ¬ (å‰¯æª”åç‚º \*.msi çš„å®‰è£ç¨‹å¼)

-   <https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html>

æ ¹æ“šä½ çš„éœ€æ±‚è¨­å®šå®‰è£ç¨‹å¼

![](figures/putty-installer-configuration.png){.figure}

å¾…å®‰è£ç¨‹å¼å®‰è£å®Œæˆ

![](figures/putty-installer-finish.png){.figure}

å®‰è£å®Œæˆå¾Œï¼Œé»é¸ã€Œé–‹å§‹ã€ï¼Œæ‰¾åˆ° PuTTYgené–‹å•Ÿï¼Œæˆ–æ˜¯é»é¸ã€Œé–‹å§‹ã€ï¼Œéµå…¥ `puttygen` å¾ŒæŒ‰ Enterâ†©

#### Step 2 --- ç¶“ç”± PuTTYgen ç”¢ç”Ÿ ssh key pairs

è·Ÿ OpenSSH Client ä¸€æ¨£åœ°ï¼Œä½ å¯ä»¥åœ¨ä¸‹æ–¹çš„ Types é¸æ“‡ä½ åå¥½çš„åŠ å¯†æ–¹å¼ã€‚é»é¸ã€ŒGenerateã€é–‹å§‹ç”¢ç”Ÿ keyï¼Œæ­¤æ™‚ä¸è¦å‚»å‚»åœ°åœ¨é‚£é‚Šç­‰ï¼Œè¦åœ¨ç¨‹å¼é€²åº¦æ¢ä¸‹æ–¹ç©ºç™½è™•éš¨æ„ç§»å‹•ä½ çš„æ»‘é¼ é¼ æ¨™ã€‚

![](figures/puttygen-genkey.png){.figure}

å®Œæˆå¾Œï¼Œå¯ä»¥åœ¨ Comment çš„è¼¸å…¥æ¡†è¨»è§£ä¸€ä¸‹é€™å€‹ key æ˜¯å¾å“ªè£¡ä¾†çš„ï¼Œä»¥å¾Œæ“æœ‰å¤šå€‹ key pairs æ™‚æ‰ä¸æœƒææ··ã€‚ç•¶ç„¶ä½ ä¹Ÿå¯ä»¥ç”¨å¯†ç¢¼ä¿è­·é€™å€‹ key pairsï¼Œå¦‚æœæœ‰éœ€è¦åœ¨ Key passphrase èˆ‡ Confirm passphrase è¼¸å…¥ä¸€æ¨¡ä¸€æ¨£çš„å¯†ç¢¼ã€‚

![](figures/puttygen-genkey-finish.png){.figure}

#### Step 3 --- å¦¥å–„ä¿å­˜å¥½ç”¢ç”Ÿçš„ Key

åˆ†åˆ¥æŒ‰ä¸‹ã€ŒSave public keyã€èˆ‡ã€ŒSave private keyã€æ‰¾åˆ°é©åˆçš„åœ°æ–¹å„²å­˜å®ƒã€‚

### ä¸Šå‚³ ssh key pairs

PuTTY ç”¢ç”Ÿçš„ public key èˆ‡ private key æ ¼å¼æ¯”è¼ƒç‰¹åˆ¥ï¼Œä¸¦ä¸èƒ½ç›´æ¥æŠŠ public key è£¡é¢çš„æ–‡å­—ç›´æ¥è²¼åˆ°é ç«¯é›»è…¦çš„ `~/.ssh/authorized_keys` æª”æ¡ˆè£¡é¢ï¼Œéœ€è¦ç¶“ç”± PuTTYgen.exe è®€å– \*.ppk æ‰èƒ½å¾—åˆ°æ­£ç¢ºæ ¼å¼çš„ public keyã€‚é¦–å…ˆæŠŠ PuTTYgen ç¨‹å¼æ‰“é–‹ã€‚

![](figures/puttygen-menu.png){.figure}

æ¥è‘—æŒ‰ã€ŒLoadã€æŠŠå‰›å‰›ç”¢ç”Ÿçš„ \*.ppk æª”æ¡ˆè®€å–é€²ä¾†ã€‚æœƒçœ‹åˆ°ä¸€è¡Œå­—ã€ŒPublic key for pasting into OpenSSH authorized_keys fileã€ä¸‹é¢çš„å¯è¤‡è£½å€åŸŸå°±æ˜¯ public keyï¼ŒæŠŠå®ƒæ•´æ®µè¤‡è£½èµ·ä¾†ã€‚

![](figures/puttygen-load-ppk.png){.figure}

æ¥è‘—æ‰“é–‹ã€ŒPowerShellã€æˆ–æ˜¯ã€Œå‘½ä»¤æç¤ºå­—å…ƒã€ï¼Œè¼¸å…¥:

``` {.powershell .prefixed_powershell}
echo "<YOUR_PUBLIC_KEY>" | ssh asis@192.168.0.13 "cat >> ~/.ssh/authorized_keys"
```

-   å°‡ `<YOUR_PUBLIC_KEY>` æ›¿æ›æˆè‡ªå·±çš„ public key

-   é€™è£¡çš„ `asis` ç‚ºç¬¬ä¸€ç« çš„[ä½¿ç”¨è€…è¨­å®š](#ä½¿ç”¨è€…è¨­å®š)çš„é è¨­ä½¿ç”¨è€…

-   `192.168.0.13` ç‚ºæˆ‘è™›æ“¬ä¸»æ©Ÿçš„ ip ä½å€ï¼ŒæŸ¥è©¢ ip ä½å€å¯ä»¥å…ˆæ‰‹å‹•ç™»å…¥è™›æ“¬ä¸»æ©Ÿå¾Œï¼Œç”¨ `hostname -I` æˆ–æ˜¯ `ip addr show` æŒ‡ä»¤æŸ¥è©¢

æ¥è‘—æŒ‰ Enterâ†©ï¼Œè·³å‡ºè¼¸å…¥å¯†ç¢¼æç¤ºï¼Œé€™è£¡è¼¸å…¥é è¨­çš„ä½¿ç”¨è€…å¯†ç¢¼ `asis`

``` console_output
asis@192.168.0.13's password:
```

è¼¸å…¥å®Œæˆä¸æœƒå‡ºç¾ä»»ä½•è¨Šæ¯æ˜¯æ­£å¸¸çš„ï¼Œä»£è¡¨æ“ä½œæ²’æœ‰å•é¡Œä¸”å·²ç¶“å¯ä»¥ä½¿ç”¨ PuTTY é€£ç·šäº†ã€‚

### PuTTYgen ç”¢ç”Ÿçš„ key pairs çš„é€£ç·šæ–¹å¼:

SSH é€£ç·šæ–¹å¼å¤§åŒå°ç•°:

-   é¦–å…ˆé»é¸ã€Œé–‹å§‹ã€ï¼Œéµå…¥ `PuTTY` æ‰“é–‹å®¢æˆ¶ç«¯

-   åœ¨å·¦é‚Šçš„ ã€ŒCategory:ã€ ä¸‹ï¼Œé¸å– ã€ŒSessionã€

-   æ–¼ Host Name è¼¸å…¥ã€Œä½¿ç”¨è€…\@ç›®çš„åœ° IPã€ï¼Œåƒæ˜¯ã€Œ`asis@192.168.0.13`ã€

    ::: {.infobox .info}
    ä½ å¯ä»¥é»é¸ä¸‹é¢çš„ã€ŒDefault Settingsã€å¾Œï¼Œæ¥è‘—æŒ‰ã€ŒSaveã€æœƒæŠŠå‰›å‰›è¼¸å…¥çš„ IP èˆ‡ Port å„²å­˜è‡³ã€ŒDefault Settingsã€å…§ï¼Œç•¶ç„¶ä½ ä¹Ÿå¯ä»¥è‡ªå·±å–ä¸€å€‹æ–°çš„åå­—ã€‚
    :::

-   æ¥è‘—å±•é–‹å·¦é‚Š ã€ŒCategory:ã€ ä¸‹çš„ã€ŒConnectionã€ âœ é»é¸ã€ŒSSHã€ âœ å†é»é¸ã€ŒAuthã€ï¼Œæ–¼æœ€ä¸‹é¢çš„ã€ŒPrivate key file for authentication:ã€é»é¸ã€ŒBrowse...ã€é¸å– `*.ppk` æª”æ¡ˆä½ç½®

-   å®Œæˆå¾Œé»é¸ã€ŒOpenã€é€£ç·š

èˆ‡ä½¿ç”¨ ssh æŒ‡ä»¤é€£ç·šç›¸åŒï¼Œéƒ½æœƒå…ˆæé†’ä½ ç›®çš„åœ°æ˜¯å¦æ­£ç¢ºã€‚ç¢ºèªç„¡èª¤æŒ‰ä¸‹ã€ŒAcceptã€

![](figures/putty-security-alert.png){.figure}

é€£æ¥æˆåŠŸ!

![](figures/putty-connection-success.png){.figure}

<!-- ## æ–‡æœ¬ç·¨è¼¯å™¨ -->

<!-- ### vim -->

<!-- ### nano -->

# å¸³è™Ÿç®¡ç†

## æ¦‚è¿°

## manage-users.sh

``` bash
#!/bin/bash
# author: kuaz
# created date: 2022.02.24
# last modified: 2022.07.10
# 
# This script is used to:
# 1. Create user accounts from /depts/dept.txt files (one student ID per line).

# ç’°å¢ƒè®Šæ•¸
depts_dir='depts'       # æ”¾ç½®ç”¨ä¾†å»ºç½® linux å¸³è™Ÿçš„ç³»è³‡æ–™å¤¾
# pass_dir='passwd'       # æ”¾ç½®å»ºç½®å®Œæˆçš„ linux å¸³è™Ÿå¯†ç¢¼çš„è³‡æ–™å¤¾
gp=false                # æ˜¯å¦ç”¢ç”Ÿæ–°å¯†ç¢¼
new=true                # æ˜¯å¦æ˜¯æ–°ç‰ˆçš„ shiny app é€£çµæ–¹å¼ï¼›å¦‚æœè¨­ç‚º trueï¼Œ
                        # å°‡ä¸æœƒä½¿ç”¨ systemetic link çš„æ–¹å¼é€£çµ
dryrun=false            # è©¦é‹è¡Œï¼›å¦‚æœè¨­ç‚º trueï¼Œå°‡ä¸æœƒå‰µç«‹å¸³è™Ÿ
                        # useradd æ˜¯å¦æ”¯æ´ badname
badname_supported=$(useradd 2>&1 | grep -q "badname"; echo $?)    

check_permission() {
    if [ ${dryrun} == true ]; then
        :
    else
        if [ $(id -u) -ne 0 ]; then
            echo "å¿…é ˆä»¥ root æ¬Šé™åŸ·è¡Œæ­¤è…³æœ¬ï¼";
            exit 1;
        fi
    fi
}

user_exists() { 
    id "$1" &> /dev/null 
}

check_depts_dir() {
    if [ -d ${depts_dir} ]; then
        grps="$(ls ./${depts_dir} | grep ".txt" | cut -d "." -f 1)"
        for grp in ${grps}
        do
            # https://stackoverflow.com/questions/28038633/wc-l-is-not-counting-last-of-the-file-if-it-does-not-have-end-of-line-character
            count=$(awk 'END{print NR}' ./${depts_dir}/${grp}.txt)
            file=$(realpath ./${depts_dir}/${grp}.txt)
            if [ $count -lt 1 ]; then
                echo "è«‹å†æª¢æŸ¥ä¸€æ¬¡ ${depts_dir} å…§æ˜¯å¦å«æœ‰æ­£ç¢ºæ ¼å¼çš„å­¸è™Ÿæª”æ¡ˆï¼"
                echo "æœ‰å•é¡Œçš„æª”æ¡ˆ: $file"
                exit 1
            else
                echo "æ–¼ $file ç™¼ç¾äº† $count å€‹å­¸ç”Ÿ"
            fi
        done
    else
        echo "ç³»è³‡æ–™å¤¾ ${depts_dir} ä¸å­˜åœ¨ï¼è«‹å…ˆæ‰‹å‹•å‰µå»ºæˆ–æ˜¯ç”±é¸é … -c, --generate-configuration å»ºç«‹ã€‚"
        exit 1;
    fi
}

# create_pass_dir() {
#     if [ ! -d ${pass_dir} ]; then
#         echo "å­˜æ”¾å¯†ç¢¼çš„ ${pass_dir} è³‡æ–™å¤¾ä¸å­˜åœ¨ï¼Œå°‡å»ºç«‹ ${pass_dir} è³‡æ–™å¤¾"
#         mkdir ${pass_dir}
#     else
#         read -p "å­˜æ”¾å¯†ç¢¼çš„ ${pass_dir} è³‡æ–™å¤¾å·²å­˜åœ¨ï¼æ˜¯å¦è¦å°‡å…¶ç§»é™¤å¾Œç¹¼çºŒå»ºç«‹å¸³è™Ÿ? (yes/No)" yn
#         case $yn in
#             [Yy]* ) 
#                 rm -rf ${pass_dir}
#                 make_pass_dir
#             ;;
#             [Nn]* ) exit 1;;
#         esac
#     fi
# }

create_users() {
    # å¦‚æœæœ‰ç”¢ç”Ÿå¯†ç¢¼çš„éœ€æ±‚
    # if [ ${gp} = true ]; then
    #     create_pass_dir
    # fi

    for grp in ${grps}
    do
        # ç¢ºèªä½¿ç”¨è€…ç¾¤çµ„æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å°‡è‡ªå‹•å»ºç«‹
        if $(grep -q "^${grp}:" /etc/group); then
            :
        else
            # éè©¦é‹è¡Œ
            if [ ${dryrun} = false ]; then
                groupadd ${grp}
            fi
            echo "å·²å»ºç«‹ ${grp} ä½¿ç”¨è€…ç¾¤çµ„"
        fi
    done

    for grp in ${grps}
    do 
        # ä½¿ç”¨èˆŠæ–¹æ³•é€£çµ ShinyApps
        if [ ${new} = false ] && [ ! -d /srv/shiny-server/${grp} ]; then
            echo "/srv/shiny-server/${grp} è³‡æ–™å¤¾ä¸å­˜åœ¨ï¼Œå°‡å»ºç«‹ç¾¤çµ„è³‡æ–™å¤¾"
            # éè©¦é‹è¡Œ
            if [ ${dryrun} = false ]; then
                mkdir /srv/shiny-server/${grp}
            fi
        fi

        created=0
        skip=0

        # é€è¡Œè®€å–å­¸è™Ÿ
        while IFS= read -r stu || [ -n "$stu" ];
        do
            cur_user=${stu}

            if user_exists "${cur_user}"; then
                (( skip += 1 ))
            
            elif [ ${dryrun} = false ]; then
                # å¦‚æœä¸æ”¯æ´ badname
                if [ ${badname_supported} == false ]; then
                    useradd -N -g stu -G ${grp} -m ${cur_user}
                else
                    useradd --badnames -N -g stu -G ${grp} -m ${cur_user}
                fi

                # ç”¢ç”Ÿéš¨æ©Ÿå¯†ç¢¼
                if [ ${gp} = false ]; then
                    cur_user_password=${cur_user}
                else
                    cur_user_password=$(openssl rand -base64 6)
                fi
                
                # ä»¥ root æ¬Šé™å‰µç«‹ä½¿ç”¨è€…å¸³è™Ÿï¼Œä¸¦è¨­å®šå¯†ç¢¼
                echo "${cur_user}:${cur_user_password}" | chpasswd

                # å°‡è¨­å®šçš„å¸³è™Ÿå¯†ç¢¼å„²å­˜ä¸€ä»½åˆ°è³‡æ–™å¤¾ä¸­
                # echo "${cur_user},${cur_user_password}"| tee -a ./${pass_dir}/${grp}.csv > /dev/null 2>&1

                # å°‡ ShinyApp è»Ÿé€£çµè‡³ä½¿ç”¨è€…è³‡æ–™å¤¾
                if [ ${new} = false ]; then
                    # éœ€è¦å…ˆåœ¨ /etc/skel/ å»ºç«‹ ShinyApps è³‡æ–™å¤¾ï¼Œæ‰å¯æˆåŠŸé€£çµ
                    ln -s /home/${cur_user}/ShinyApps /srv/shiny-server/${grp}/${cur_user}
                fi

                (( created += 1 ))
            else
                # å¦‚æœç‚ºè©¦é‹è¡Œæ¨¡å¼
                (( created += 1 ))
            fi

        done < ./${depts_dir}/${grp}.txt

        echo "æˆåŠŸå¾ç¾¤çµ„ ${grp} å»ºç«‹äº† ${created} å€‹å¸³è™Ÿï¼Œå¿½ç•¥äº† ${skip} å€‹å·²å­˜åœ¨å¸³è™Ÿã€‚"
    done
}

delete_users() {
    for grp in ${grps}
    do 
        skip=0
        deleted=0
        while IFS= read -r stu || [ -n "$stu" ];
        do
            cur_user=${stu}
            if user_exists "${cur_user}"; then
                userdel -r ${cur_user} > /dev/null 2>&1
                if [ ${new} = false ]; then
                    rm -rf /srv/shiny-server/${grp}/${stu}
                fi
                (( deleted += 1 ))
            else
                (( skip += 1 ))
            fi
        done < ./${depts_dir}/${grp}.txt
        echo "æˆåŠŸå¾ç¾¤çµ„ ${grp} ç§»é™¤äº† ${deleted} å€‹å¸³è™Ÿï¼Œå…¶ä¸­å…±æœ‰ ${skip} å€‹å¸³è™Ÿä¸å­˜åœ¨ã€‚"
    done
    # read -p "ä½¿ç”¨è€…å·²ç§»é™¤ï¼Œæ˜¯å¦è¦é †ä¾¿ç§»é™¤å­˜æ”¾å¯†ç¢¼çš„è³‡æ–™å¤¾ ${pass_dir}? (yes/No)" yn

    # case $yn in
    #     [Yy]* ) 
    #         rm -rf ${pass_dir}
    #     ;;
    #     [No]* ) exit 0;;
    # esac
}

create_prompt() {
    read -p "å³å°‡å»ºç«‹ä½¿ç”¨è€…å¸³æˆ¶ï¼Œç¢ºèªä½¿ç”¨è€…è³‡æ–™æ˜¯å¦ç„¡èª¤?ï¼ˆYes/Noï¼‰" yn
    echo 

    case $yn in
        [Yy]* ) create_users;;
        [Nn]* ) exit 0;;
    esac
}

delete_prompt() {
    read -p "å³å°‡ 'åˆªé™¤' ä½¿ç”¨è€…å¸³æˆ¶ï¼Œæ–¼ /home/<ä½¿ç”¨è€…> çš„è³‡æ–™å°‡æœƒæ¶ˆå¤±ï¼Œæ˜¯å¦åŸ·è¡Œ?ï¼ˆYes/Noï¼‰" yn
    case $yn in
        [Yy]* ) delete_users;;
        [Nn]* ) exit 0;;
    esac
}

generate_configuration() {
    if [ -d ${depts_dir} ]; then
        echo "è³‡æ–™å¤¾å·²å­˜åœ¨ï¼è«‹å…ˆåˆªé™¤ ${depts_dir} è³‡æ–™å¤¾"
    else
        mkdir ${depts_dir}
        touch ${depts_dir}/asis.txt
        touch ${depts_dir}/eco.txt
        echo 08170875 > ${depts_dir}/asis.txt
        echo 08220855 > ${depts_dir}/eco.txt
        echo "è¨­å®šæª”æ¡ˆå»ºç«‹å®Œæˆ"
    fi
    exit 0;
}

display_help() {
    cat << EOF
ä½¿ç”¨æ–¹æ³•: $0 [é¸é …...] <create>

é¸é …: 
    -h, --help                      ç”¢ç”Ÿæ­¤èªªæ˜æ–‡å­—
    -d, --dry-run                   è©¦é‹è¡Œè…³æœ¬ï¼Œä¸å¯¦éš›åŸ·è¡Œ
    -c, --generate-configuration    ç”¢ç”Ÿç¯„ä¾‹è¨­å®š
    -o, --old-shiny-server          ShinyApps å°‡ä½¿ç”¨è»Ÿé€£çµçš„æ–¹å¼é€£çµï¼ˆä¸æ¨è–¦ï¼‰
EOF
}

while :
do
    case "$1" in
        -h | --help)
            display_help
            exit 0
        ;;
        -d | --dry-run)
            dryrun=true
            shift 1
            break
        ;;
        # -p | --generate-password)
        #     gp=true
        #     shift 1
        #     break
        # ;;
        -c | --generate-configuration)
            generate_configuration
            exit 0
        ;;
        -o | --old-shiny-server)
            new=false
            shift 1
            break
        ;;
        -*)
            echo "éŒ¯èª¤ï¼šæœªçŸ¥çš„é¸é …ï¼š$1"
            display_help
            exit 1
        ;;
        *)
            break
        ;;
    esac
done

case "$1" in
    create)
        check_permission
        check_depts_dir
        create_prompt
    ;;
    delete)
        check_permission
        check_depts_dir
        delete_prompt
    ;;
    *)
        echo "éŒ¯èª¤ï¼Œè«‹åƒè€ƒä¸‹åˆ—æŒ‡ä»¤èªªæ˜ï¼š"
        echo 
        display_help
        exit 1
    ;;
esac
```

## generate-sql.sh

``` bash
#!/bin/bash
# author: kuaz
# last modified: 2021.09.13
# 
# é€™å€‹è…³æœ¬è¢«ç”¨ä¾†:
# 1. æ ¹æ“šå·²çŸ¥çš„å¸³è™Ÿå¯†ç¢¼å»ºç«‹ MySQL å¸³æˆ¶
# 2. æ ¹æ“šå¸³è™Ÿå»ºç«‹è³‡æ–™åº«ï¼Œç·¨ç¢¼ç‚º 'utf8mb4'
# 3. ä»¥ä¸ŠæŒ‡ä»¤æœƒå„²å­˜åœ¨ç•¶å‰è³‡æ–™å¤¾çš„ create-account.sql è£¡é¢
# 4. æ ¹æ“šå·²çŸ¥çš„å¸³è™Ÿåˆªé™¤è©² MySQL å¸³æˆ¶èˆ‡è³‡æ–™åº«
# 5. è‹¥åŠ ä¸Š -r, --run å³å¯é †ä¾¿åŸ·è¡Œè©²è…³æœ¬


# ç’°å¢ƒè®Šæ•¸
pass_dir='passwd'       # æ”¾ç½®å¯†ç¢¼çš„è³‡æ–™å¤¾ï¼Œç”±å¦ä¸€å€‹è…³æœ¬ ./create-users.sh ç”¢ç”Ÿ
filename='-accounts.sql'  # create/drop-accounts.sql æª”æ¡ˆå‰ç¶´æœƒæ ¹æ“šé¸é …è®ŠåŒ–
run=false           # é è¨­ç”¢ç”Ÿè…³æœ¬å¾Œä¸æœƒåŸ·è¡Œ

check_pass_dir() {
  if [ -d ${pass_dir} ]; then
        grps="$(ls ${pass_dir} | grep ".csv" | cut -d "." -f 1)"
  else
        echo "å¯†ç¢¼è³‡æ–™å¤¾ ${pass_dir} ä¸å­˜åœ¨ï¼è«‹å…ˆåŸ·è¡Œéå»ºç«‹å¸³è™Ÿè…³æœ¬ï¼ˆcreate-users.shï¼‰å¾Œï¼Œå†åŸ·è¡Œä¸€æ¬¡æ­¤è…³æœ¬ã€‚"
        exit 1;
  fi
}

write_to_mysql_db() {
  if [ ${run} = true ]; then
        echo "è«‹è¼¸å…¥ MySQL å¸³æˆ¶ root çš„å¯†ç¢¼: ğŸ‘‡"
        mysql -u root -p < ${filename}
        clean_sql_script
  else
        echo "å·²æ–¼ $(pwd) ç”¢ç”Ÿ ${filename} ğŸ‰"
  fi
}

create_users_and_databases() {
  echo "set global validate_password.policy=LOW;" | tee -a ${filename} > /dev/null 2>&1;
  for grp in ${grps}
    do 
        while read line;
        do
            stu="$(echo ${line} | cut -d ',' -f 1)"
            pass="$(echo ${line} | cut -d ',' -f 2)"
            echo "create user '${stu}'@'localhost' identified by '${pass}';" \
                | tee -a ${filename} > /dev/null 2>&1
            echo "create database \`${stu}\` character set utf8mb4 collate utf8mb4_unicode_ci;" \
                | tee -a ${filename} > /dev/null 2>&1
            echo "grant all privileges on \`${stu}\`.* to '${stu}'@'localhost';" \
                | tee -a ${filename} > /dev/null 2>&1
        done < ${pass_dir}/${grp}.csv
  done
  echo "flush privileges;" | tee -a ${filename} > /dev/null 2>&1;
  write_to_mysql_db
}

drop_users_and_databases() {
  for grp in ${grps}
    do 
        while read line;
        do
            stu="$(echo ${line} | cut -d ',' -f 1)"
            echo "drop user '${stu}'@'localhost';" \
                | tee -a ${filename} > /dev/null 2>&1
            echo "drop database \`${stu}\`;" \
                | tee -a ${filename} > /dev/null 2>&1
        done < ${pass_dir}/${grp}.csv
  done
  write_to_mysql_db
}

display_help() {
  echo "é€™å€‹è…³æœ¬è¢«ç”¨ä¾†:"
  echo "1. æ ¹æ“šå·²çŸ¥çš„å¸³è™Ÿå¯†ç¢¼å»ºç«‹ MySQL å¸³æˆ¶"
  echo "2. æ ¹æ“šå¸³è™Ÿå»ºç«‹è³‡æ–™åº«ï¼Œç·¨ç¢¼ç‚º 'utf8mb4'"
  echo "3. ä»¥ä¸ŠæŒ‡ä»¤æœƒå„²å­˜åœ¨ç•¶å‰è³‡æ–™å¤¾çš„ create-account.sql è£¡é¢"
  echo "4. æ ¹æ“šå·²çŸ¥çš„å¸³è™Ÿåˆªé™¤è©² MySQL å¸³æˆ¶èˆ‡è³‡æ–™åº«"
  echo "5. è‹¥åŠ ä¸Š -r, --run å³å¯é †ä¾¿åŸ·è¡Œè©²è…³æœ¬"
  echo
  echo "ä½¿ç”¨æ–¹æ³•: $0 [option...] {create|drop}"
  echo
  echo "options: "
  echo "  -r, --run  åŸ·è¡Œè…³æœ¬"
  echo "  -h, --help  é¡¯ç¤ºèªªæ˜"
  echo "  æ²’æœ‰åŠ ä»»ä½•é¸é …: åƒ…ç”¢ç”Ÿ .sql è…³æœ¬"
  echo
  exit 0
}

clean_sql_script() {
  read -p "æ˜¯å¦è¦æ¸…é™¤ ${filename}? (Yes/No)" yn
  case $yn in
        [Yy]* ) rm ${filename} ;;
        [Nn]* ) exit 0;;
  esac
  echo "DONE ğŸ‰"
}

while :
do
  case "$1" in
        -r | --run)
            run=true
            shift 1
            ;;
        -h | --help)
            display_help
            exit 0
            ;;
        --)
            shift
            break
            ;;
        -*)
            echo "éŒ¯èª¤: æœªçŸ¥çš„é¸é …: $1" >&2
            display_help
            exit 1
            ;;
        *)
            break
            ;;
    esac
done
case "$1" in
  create)
        check_pass_dir
        if [ $? -ne 1 ]; then
            filename="$1$filename"
            create_users_and_databases
        fi
        ;;
    drop)
        check_pass_dir
        if [ $? -ne 1 ]; then
            filename="$1$filename"
            drop_users_and_databases
        fi
        ;;
    *)
        display_help
        exit 0
        ;;
esac
```

# å…¶ä»–

## æ›´æ”¹é è¨­çš„æ–‡æœ¬ç·¨è¼¯å™¨

é€™å€‹æŒ‡ä»¤å¯ä»¥è®Šæ›´ç³»çµ±ç·¨è¼¯æ–‡ä»¶æ‰€ç”¨çš„ç¨‹å¼

``` bash
sudo update-alternatives --config editor
```

æŒ‰äº† Enterâ†© ä¹‹å¾Œï¼Œæœƒå‡ºç¾ç¾åœ¨å¯ç”¨çš„ç·¨è¼¯å™¨ï¼Œè¼¸å…¥å°æ‡‰çš„ç·¨è™Ÿå³å¯è®Šæ›´ã€‚æœ‰æ¨™ `*` è™Ÿçš„ç·¨è¼¯å™¨ç‚ºç›®å‰è¨­å®šçš„é è¨­ç·¨è¼¯å™¨ã€‚

``` console_output
There are 4 choices for the alternative editor (providing /usr/bin/editor).

  Selection    Path                Priority   Status
------------------------------------------------------------
  0            /bin/nano            40        auto mode
  1            /bin/ed             -100       manual mode
  2            /bin/nano            40        manual mode
* 3            /usr/bin/vim.basic   30        manual mode
  4            /usr/bin/vim.tiny    15        manual mode

Press <enter> to keep the current choice[*], or type selection number: 3
```

<!--# TODO: åˆ©ç”¨ SSH  å‚³è¼¸æª”æ¡ˆ -->

## Mysql 8.0 root å¯†ç¢¼é‡è¨­

å…ˆå»ºç«‹ä¸€å€‹å«æœ‰æ”¹è®Š root å¯†ç¢¼çš„ sql èªæ³•æ–‡å­—æª”æ¡ˆ

``` {.bash .prefixed}
vim mysql-init
```

``` sqlmysql
ALTER USER 'root'@'localhost' IDENTIFIED with caching_sha2_password by '<æ–°çš„ root å¯†ç¢¼>';
```

å¦‚å­˜å¥½å¾Œå°‡æ“æœ‰è€…èˆ‡ä½¿ç”¨è€…ç¾¤çµ„æ”¹æˆ `mysql` å¾Œï¼Œç§»è‡³ `/tmp` è³‡æ–™å¤¾ï¼Œä½¿ mysql ä½¿ç”¨è€…å¯ä»¥å­˜å–ã€‚

``` {.bash .prefixed}
chown mysql.mysql mysql-init && mv mysql-init /tmp
```

åˆ‡æ›è‡³ root ä½¿ç”¨è€…é€²è¡Œå¾ŒçºŒæ“ä½œ

``` {.bash .prefixed}
sudo su -
```

å°‡ç›®å‰çš„ mysql é—œé–‰

``` {.bash .prefixed_root}
killall -9 mysqld
```

æˆ–æ˜¯ä½¿ç”¨ `systemctl` æŒ‡ä»¤é—œé–‰ mysql æœå‹™

`{.bash prefixed} systemctl stop mysql.service`

æ¥è‘—ä½¿ç”¨ mysqld æŒ‡ä»¤å•Ÿå‹• mysql ä¸¦æŒ‡å®š `--user`ã€`--defaults-file` èˆ‡ `--init-file` åƒæ•¸ã€‚

``` {.bash .prefixed_root}
mysqld --defaults-file=/etc/mysql/mysql.conf.d/mysqld.cnf \ 
--user=mysql \ 
--init-file=/tmp/mysql-init &
```

-   `--defaults-file`: MySQL é è¨­å•Ÿå‹•çš„è¨­å®šæª”æ¡ˆ

-   `--user`: ä»¥ä½¿ç”¨è€… `mysql` åŸ·è¡Œ

-   `--init-file`: åˆå§‹åŒ–æ™‚ï¼ŒåŸ·è¡Œ `/tmp/mysql-init` æŒ‡ä»¤ï¼Œè®Šæ›´å¯†ç¢¼

-   `&`: å°‡ mysql deamon æ”¾è‡³èƒŒæ™¯åŸ·è¡Œã€‚

æ­¤æ™‚ï¼Œæ‡‰è©²å¯ä»¥æ­£å¸¸ç™»å…¥äº†ã€‚

::: {.infobox .caution}
å¦‚æœä¸è¡Œçš„è©±ï¼Œè«‹æª¢æŸ¥ä½æ–¼ `/var/log/mysql/error.log` çš„éŒ¯èª¤ç´€éŒ„ï¼Œå¦‚æœæœ‰çœ‹åˆ°é¡ä¼¼ `/var/run/mysqld` çš„éŒ¯èª¤ï¼Œéœ€è¦æ‰‹å‹•å»ºç«‹è³‡æ–™å¤¾ï¼Œä¸¦æŠŠæ¬Šé™è®Šæ›´ç‚º `mysql` ç”¨æˆ¶çš„æ¬Šé™ã€‚ æ“ä½œå®Œä¹‹å¾Œå†å¾é—œé–‰ mysql æœå‹™é–‹å§‹ï¼Œå†å˜—è©¦ä¸€æ¬¡ã€‚

åƒè€ƒæŒ‡ä»¤å¦‚ä¸‹ï¼š

``` {.bash .prefixed_root}
mkdir /var/run/mysqld && chown mysql.mysql /var/run/mysqld
```
:::

æœ€å¾Œä»¥æ­£å¸¸çš„æœå‹™å•Ÿå‹• mysqlï¼š

``` {.bash .prefixed_root}
systemctl restart mysql.service
```

é€€å‡º root å¸³è™Ÿ

``` {.bash .prefixed_root}
exit
```

è©¦ä»¥æ–°å¯†ç¢¼ç™»å…¥ mysql root å¸³è™Ÿï¼š

``` {.bash .prefixed}
mysql -u root -p
```

æˆåŠŸ ğŸŠ

``` console_output
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 17
Server version: 8.0.26-0ubuntu0.20.04.3 (Ubuntu)

Copyright (c) 2000, 2021, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> 
```
