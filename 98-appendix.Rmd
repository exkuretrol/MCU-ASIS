# é™„éŒ„ {.unnumbered}

å› ç‚ºå…§å®¹å¤ªå¤šï¼Œæ›¸æœ¬ç¯‡æ”¶éŒ„çš„æœƒè®Šå¾—å¤ªæ··é›œï¼Œæ‰€ä»¥æˆ‘æŠŠä¸€äº›å…§å®¹æ”¾åˆ°é€™è£¡ã€‚

## ç”± Windows 10 ç³»çµ±é€²å…¥ BIOS {.unnumbered}

## Windows Terminal {.unnumbered}

## PuTTY {.unnumbered}

ä½¿ç”¨ PuTTY é€£ç·šè‡³ OpenSSH ä¼ºæœå™¨

### ä»¥ PuTTY ç”¢ç”Ÿ key {.unnumbered}

å¦ä¸€å€‹æ–¹æ³•ä¸æœƒéœ€è¦ä½ æ‰‹å‹•å®‰è£ OpenSSH Clientï¼Œä¸éã€ä¸€æ¨£åœ°ï¼Œè¦å®‰è£PuTTY ç¨‹å¼ã€‚

#### Step 1 --- å®‰è£ PuTTY {.unnumbered}

åˆ°é–‹ç™¼è€…çš„ç¶²ç«™ï¼Œç„¶å¾Œä¸‹è¼‰é©åˆä½  Windows çš„ç‰ˆæœ¬ (å‰¯æª”åç‚º \*.msi çš„å®‰è£ç¨‹å¼)

-   <https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html>

æ ¹æ“šä½ çš„éœ€æ±‚è¨­å®šå®‰è£ç¨‹å¼

![](figures/putty-installer-configuration.png){.figure}

å¾…å®‰è£ç¨‹å¼å®‰è£å®Œæˆ

![](figures/putty-installer-finish.png){.figure}

å®‰è£å®Œæˆå¾Œï¼Œé»é¸ã€Œé–‹å§‹ã€ï¼Œæ‰¾åˆ° PuTTYgené–‹å•Ÿï¼Œæˆ–æ˜¯é»é¸ã€Œé–‹å§‹ã€ï¼Œéµå…¥ `puttygen` å¾ŒæŒ‰ Enterâ†©

#### Step 2 --- ç¶“ç”± PuTTYgen ç”¢ç”Ÿ ssh key pairs {.unnumbered}

è·Ÿ OpenSSH Client ä¸€æ¨£åœ°ï¼Œä½ å¯ä»¥åœ¨ä¸‹æ–¹çš„ Types é¸æ“‡ä½ åå¥½çš„åŠ å¯†æ–¹å¼ã€‚é»é¸ã€ŒGenerateã€é–‹å§‹ç”¢ç”Ÿ keyï¼Œæ­¤æ™‚ä¸è¦å‚»å‚»åœ°åœ¨é‚£é‚Šç­‰ï¼Œè¦åœ¨ç¨‹å¼é€²åº¦æ¢ä¸‹æ–¹ç©ºç™½è™•éš¨æ„ç§»å‹•ä½ çš„æ»‘é¼ é¼ æ¨™ã€‚

![](figures/puttygen-genkey.png){.figure}

å®Œæˆå¾Œï¼Œå¯ä»¥åœ¨ Comment çš„è¼¸å…¥æ¡†è¨»è§£ä¸€ä¸‹é€™å€‹ key æ˜¯å¾å“ªè£¡ä¾†çš„ï¼Œä»¥å¾Œæ“æœ‰å¤šå€‹ key pairs æ™‚æ‰ä¸æœƒææ··ã€‚ç•¶ç„¶ä½ ä¹Ÿå¯ä»¥ç”¨å¯†ç¢¼ä¿è­·é€™å€‹ key pairsï¼Œå¦‚æœæœ‰éœ€è¦åœ¨ Key passphrase èˆ‡ Confirm passphrase è¼¸å…¥ä¸€æ¨¡ä¸€æ¨£çš„å¯†ç¢¼ã€‚

![](figures/puttygen-genkey-finish.png){.figure}

#### Step 3 --- å¦¥å–„ä¿å­˜å¥½ç”¢ç”Ÿçš„ Key {.unnumbered}

åˆ†åˆ¥æŒ‰ä¸‹ã€ŒSave public keyã€èˆ‡ã€ŒSave private keyã€æ‰¾åˆ°é©åˆçš„åœ°æ–¹å„²å­˜å®ƒã€‚

### ä¸Šå‚³ä»¥ PuTTY ç”¢ç”Ÿçš„ ssh key pairs {.unnumbered}

PuTTY ç”¢ç”Ÿçš„ public key èˆ‡ private key æ ¼å¼æ¯”è¼ƒç‰¹åˆ¥ï¼Œä¸¦ä¸èƒ½ç›´æ¥æŠŠ public key è£¡é¢çš„æ–‡å­—ç›´æ¥è²¼åˆ°é ç«¯é›»è…¦çš„ `~/.ssh/authorized_keys` æª”æ¡ˆè£¡é¢ï¼Œéœ€è¦ç¶“ç”± PuTTYgen.exe è®€å– \*.ppk æ‰èƒ½å¾—åˆ°æ­£ç¢ºæ ¼å¼çš„ public keyã€‚é¦–å…ˆæŠŠ PuTTYgen ç¨‹å¼æ‰“é–‹ã€‚

![](figures/puttygen-menu.png){.figure}

æ¥è‘—æŒ‰ã€ŒLoadã€æŠŠå‰›å‰›ç”¢ç”Ÿçš„ \*.ppk æª”æ¡ˆè®€å–é€²ä¾†ã€‚æœƒçœ‹åˆ°ä¸€è¡Œå­—ã€ŒPublic key for pasting into OpenSSH authorized_keys fileã€ä¸‹é¢çš„å¯è¤‡è£½å€åŸŸå°±æ˜¯ public keyï¼ŒæŠŠå®ƒæ•´æ®µè¤‡è£½èµ·ä¾†ã€‚

![](figures/puttygen-load-ppk.png){.figure}

æ¥è‘—æ‰“é–‹ã€ŒPowerShellã€æˆ–æ˜¯ã€Œå‘½ä»¤æç¤ºå­—å…ƒã€ï¼Œè¼¸å…¥:

``` {.powershell .prefixed_powershell}
echo "<YOUR_PUBLIC_KEY>" | ssh asis@192.168.0.13 "cat >> ~/.ssh/authorized_keys"
```

-   å°‡ `<YOUR_PUBLIC_KEY>` æ›¿æ›æˆè‡ªå·±çš„ public key

-   é€™è£¡çš„ `asis` ç‚ºç¬¬ä¸€ç« çš„[ä½¿ç”¨è€…è¨­å®š](#ä½¿ç”¨è€…è¨­å®š)çš„é è¨­ä½¿ç”¨è€…

-   `192.168.0.13` ç‚ºæˆ‘è™›æ“¬ä¸»æ©Ÿçš„ ip ä½å€ï¼ŒæŸ¥è©¢ ip ä½å€å¯ä»¥å…ˆæ‰‹å‹•ç™»å…¥è™›æ“¬ä¸»æ©Ÿå¾Œï¼Œç”¨ `hostname -I` æˆ–æ˜¯ `ip addr show` æŒ‡ä»¤æŸ¥è©¢

æ¥è‘—æŒ‰ Enterâ†©ï¼Œè·³å‡ºè¼¸å…¥å¯†ç¢¼æç¤ºï¼Œé€™è£¡è¼¸å…¥é è¨­çš„ä½¿ç”¨è€…å¯†ç¢¼ `asis`

``` {.console_output}
asis@192.168.0.13's password:
```

è¼¸å…¥å®Œæˆä¸æœƒå‡ºç¾ä»»ä½•è¨Šæ¯æ˜¯æ­£å¸¸çš„ï¼Œä»£è¡¨æ“ä½œæ²’æœ‰å•é¡Œä¸”å·²ç¶“å¯ä»¥ä½¿ç”¨ PuTTY é€£ç·šäº†ã€‚

### PuTTYgen ç”¢ç”Ÿçš„ key pairs çš„é€£ç·šæ–¹å¼: {.unnumbered}

SSH é€£ç·šæ–¹å¼å¤§åŒå°ç•°:

-   é¦–å…ˆé»é¸ã€Œé–‹å§‹ã€ï¼Œéµå…¥ `PuTTY` æ‰“é–‹å®¢æˆ¶ç«¯

-   åœ¨å·¦é‚Šçš„ ã€ŒCategory:ã€ ä¸‹ï¼Œé¸å– ã€ŒSessionã€

-   æ–¼ Host Name è¼¸å…¥ã€Œä½¿ç”¨è€…\@ç›®çš„åœ° IPã€ï¼Œåƒæ˜¯ã€Œ`asis@192.168.0.13`ã€

    ::: {.infobox .info}
    ä½ å¯ä»¥é»é¸ä¸‹é¢çš„ã€ŒDefault Settingsã€å¾Œï¼Œæ¥è‘—æŒ‰ã€ŒSaveã€æœƒæŠŠå‰›å‰›è¼¸å…¥çš„ IP èˆ‡ Port å„²å­˜è‡³ã€ŒDefault Settingsã€å…§ï¼Œç•¶ç„¶ä½ ä¹Ÿå¯ä»¥è‡ªå·±å–ä¸€å€‹æ–°çš„åå­—ã€‚
    :::

-   æ¥è‘—å±•é–‹å·¦é‚Š ã€ŒCategory:ã€ ä¸‹çš„ã€ŒConnectionã€ âœ é»é¸ã€ŒSSHã€ âœ å†é»é¸ã€ŒAuthã€ï¼Œæ–¼æœ€ä¸‹é¢çš„ã€ŒPrivate key file for authentication:ã€é»é¸ã€ŒBrowse...ã€é¸å– `*.ppk` æª”æ¡ˆä½ç½®

-   å®Œæˆå¾Œé»é¸ã€ŒOpenã€é€£ç·š

èˆ‡ä½¿ç”¨ ssh æŒ‡ä»¤é€£ç·šç›¸åŒï¼Œéƒ½æœƒå…ˆæé†’ä½ ç›®çš„åœ°æ˜¯å¦æ­£ç¢ºã€‚ç¢ºèªç„¡èª¤æŒ‰ä¸‹ã€ŒAcceptã€

![](figures/putty-security-alert.png){.figure}

é€£æ¥æˆåŠŸ!

![](figures/putty-connection-success.png){.figure}

## æ–‡æœ¬ç·¨è¼¯å™¨ {.unnumbered}

### vim {.unnumbered}

### nano {.unnumbered}

### æ›´æ”¹é è¨­çš„æ–‡æœ¬ç·¨è¼¯å™¨ {.unnumbered}

é€™å€‹æŒ‡ä»¤å¯ä»¥è®Šæ›´ç³»çµ±ç·¨è¼¯æ–‡ä»¶æ‰€ç”¨çš„ç¨‹å¼

``` {.bash}
sudo update-alternatives --config editor
```

æŒ‰äº† Enterâ†© ä¹‹å¾Œï¼Œæœƒå‡ºç¾ç¾åœ¨å¯ç”¨çš„ç·¨è¼¯å™¨ï¼Œè¼¸å…¥å°æ‡‰çš„ç·¨è™Ÿå³å¯è®Šæ›´ã€‚æœ‰æ¨™ `*` è™Ÿçš„ç·¨è¼¯å™¨ç‚ºç›®å‰è¨­å®šçš„é è¨­ç·¨è¼¯å™¨ã€‚

``` {.console_output}
There are 4 choices for the alternative editor (providing /usr/bin/editor).

  Selection    Path                Priority   Status
------------------------------------------------------------
  0            /bin/nano            40        auto mode
  1            /bin/ed             -100       manual mode
  2            /bin/nano            40        manual mode
* 3            /usr/bin/vim.basic   30        manual mode
  4            /usr/bin/vim.tiny    15        manual mode

Press <enter> to keep the current choice[*], or type selection number: 3
```

## å¸³è™Ÿç®¡ç† {.unnumbered}

### users.sh {.unnumbered}

``` {.bash}
#!/bin/bash
# author: kuaz
# last modified: 2021.09.13
# 
# This is script is used to:
# 1. Create Accounts via ./depts/${dept}.txt (one student ID per line).
# 2. Remove Accounts via ./depts/${dept}.txt

# ç’°å¢ƒè®Šæ•¸
depts_dir='depts'		# æ”¾ç½®ç”¨ä¾†å»ºç½® linux å¸³è™Ÿçš„ç³»è³‡æ–™å¤¾
pass_dir='passwd'		# æ”¾ç½®å»ºç½®å®Œæˆçš„ linux å¸³è™Ÿå¯†ç¢¼çš„è³‡æ–™å¤¾ï¼Œå»ºåˆ¶å®Œå¾Œ
				# å¯æ­é…å»ºç½® MySQL å¸³è™Ÿèˆ‡è³‡æ–™åº«è…³æœ¬ï¼ˆgenerate-sql.shï¼‰ä½¿ç”¨
gp=false			# ä¸éœ€è¦ç”¨éš¨æ©Ÿå¯†ç¢¼å»ºç«‹å¸³è™Ÿçš„æ——æ¨™
new=false

check_permission() {
	if [ $(id -u) -ne 0 ]; then
		echo "å¿…é ˆä»¥ root æ¬Šé™åŸ·è¡Œæ­¤è…³æœ¬ï¼";
		exit 1;
	fi
}

check_depts_dir() {
  if [ -d ${depts_dir} ]; then
		grps="$(ls ./${depts_dir} | grep ".txt" | cut -d "." -f 1)"
		for grp in ${grps}
		do
			table=$(wc -l ./${depts_dir}/${grp}.txt)
			file=$(echo $table | cut -d ' ' -f 2)
			count=$(echo $table | cut -d ' ' -f 1)
			if [ $count -lt 1 ]; then
				echo "å†æª¢æŸ¥ä¸€æ¬¡ ./${depts_dir}/ å…§æ˜¯å¦å«æœ‰æ­£ç¢ºæ ¼å¼çš„å­¸è™Ÿæª”æ¡ˆï¼"
				echo "æœ‰å•é¡Œçš„æª”æ¡ˆ: $file"
				exit 1
			else
				echo "æ–¼ $file ç™¼ç¾äº† $count å€‹å­¸ç”Ÿ"
			fi
		done
	else
		echo "ç³»è³‡æ–™å¤¾ ${depts_dir} ä¸å­˜åœ¨ï¼è«‹å†ç¢ºèªä¸€æ¬¡ã€‚"
		exit 1;
	fi
}

make_pass_dir() {
	if [ ! -d ${pass_dir} ]; then
		echo "å­˜æ”¾å¯†ç¢¼çš„ ${pass_dir} è³‡æ–™å¤¾ä¸å­˜åœ¨ï¼Œå°‡å»ºç«‹ ${pass_dir} è³‡æ–™å¤¾"
		mkdir ${pass_dir}
	else
		read -p "å­˜æ”¾å¯†ç¢¼çš„ ${pass_dir} è³‡æ–™å¤¾å·²å­˜åœ¨ï¼æ˜¯å¦è¦å°‡å…¶ç§»é™¤å¾Œç¹¼çºŒå»ºç«‹å¸³è™Ÿ? (yes/No)" yn
		case $yn in
			[Yy]* ) 
				rm -rf ${pass_dir}
				make_pass_dir
			;;
			[No]* ) exit 1;;
		esac
	fi
}

create_users() {
	make_pass_dir
	for grp in ${grps}
	do 
		if $(grep -q "^${grp}" /etc/group); then
			echo "ç¾¤çµ„ '${grp}' å·²å­˜åœ¨ï¼Œä¸éœ€å†å»ºç«‹ã€‚"
		else
			groupadd ${grp}
		fi

		if [ ${new} = false ] &&  [ ! -d /srv/shiny-server/${grp} ]; then
			echo "/srv/shiny-server/${grp} è³‡æ–™å¤¾ä¸å­˜åœ¨ï¼Œå°‡å»ºç«‹ç¾¤çµ„è³‡æ–™å¤¾"
			mkdir /srv/shiny-server/${grp}		
		fi

		# create user
		while read stu;
		do
			cur_user=${stu}
			if $(id "${cur_user}" > /dev/null 2>&1); then
				echo "ä½¿ç”¨è€… '${cur_user}' å·²å­˜åœ¨ã€‚"
			else
				useradd --badnames -N -g ${grp} -m ${cur_user}

				if [ ${gp} = false ]; then
					cur_user_password=${cur_user}
				else
					cur_user_password=$(openssl rand -base64 6)
				fi

				echo "${cur_user}:${cur_user_password}" | chpasswd
				echo "${cur_user},${cur_user_password}" | tee -a ./${pass_dir}/${grp}.csv > /dev/null 2>&1
				if [ ${new} = false ]; then
					# éœ€è¦å…ˆåœ¨ /etc/skel/ å»ºç«‹ ShinyApps è³‡æ–™å¤¾ï¼Œæ‰å¯æˆåŠŸé€£çµ
  				ln -s /home/${cur_user}/ShinyApps /srv/shiny-server/${grp}/${cur_user}
				fi
			fi
		done < ./${depts_dir}/${grp}.txt

	done
}

delete_users() {
  for grp in ${grps}
	do 
		while read stu;
		do
			userdel -r ${stu} > /dev/null 2>&1	
			if [ ${new} = false ]; then
				rm -rf /srv/shiny-server/${grp}/${stu}
			fi
		done < ./${depts_dir}/${grp}.txt
	done
	read -p "ä½¿ç”¨è€…å·²ç§»é™¤ï¼Œæ˜¯å¦è¦é †ä¾¿ç§»é™¤å­˜æ”¾å¯†ç¢¼çš„è³‡æ–™å¤¾ ${pass_dir}? (yes/No)" yn
	case $yn in
		[Yy]* ) 
			rm -rf ${pass_dir}
		;;
		[No]* ) exit 0;;
	esac
}

create_prompt() {
	if [ ${new} = false ]; then
		read -p "å³å°‡å»ºç«‹ä½¿ç”¨è€…å¸³æˆ¶ï¼Œç¢ºèªä½¿ç”¨è€…è³‡æ–™æ˜¯å¦ç„¡èª¤? (Yes/No)" yn
	else
		read -p "å³å°‡ä»¥æ–°çš„ shiny-server æ¨¡å¼å»ºç«‹ä½¿ç”¨è€…å¸³æˆ¶ï¼Œç¢ºèªä½¿ç”¨è€…è³‡æ–™æ˜¯å¦ç„¡èª¤? (Yes/No)" yn
	fi
	case $yn in
		[Yy]* ) create_users;;
		[Nn]* ) exit;;
	esac
}

delete_prompt() {
	read -p "å³å°‡ 'åˆªé™¤' ä½¿ç”¨è€…å¸³æˆ¶ï¼Œæ–¼ /home/<ä½¿ç”¨è€…> çš„è³‡æ–™å°‡æœƒæ¶ˆå¤±ï¼Œæ˜¯å¦åŸ·è¡Œ? (Yes/No)" yn
	case $yn in
		[Yy]* ) delete_users;;
		[Nn]* ) exit;;
	esac
}

display_help() {
	echo "ä½¿ç”¨æ–¹æ³•: $0 [é¸é …...] {create|delete}"
	echo 
	echo "é¸é …: "
	echo "	-gp, --generate-password	ä»¥ openssl ç”¢ç”Ÿéš¨æ©Ÿçš„ä½¿ç”¨è€…å¯†ç¢¼"
	echo "	-n, --new-shiny-server		åªå»ºç«‹ä½¿ç”¨è€…ï¼Œä¸è»Ÿé€£çµè‡³ /srv/shiny-server/ è³‡æ–™å¤¾ï¼›æ–°çš„ shiny-server ä¸ä½¿ç”¨è»Ÿé€£çµ"
	echo
	echo "æ­¤è…³æœ¬è¢«ç”¨ä¾†: "
	echo "1. æ ¹æ“š ./${depts_dir}/ è£¡é¢çš„ <ç³»æ‰€åç¨±.txt> å»ºç«‹å¸³è™Ÿï¼Œ"
	echo "	ç³»æ‰€åç¨±æœƒè¢«ç”¨ä¾†ç•¶ä½œ linux ä½¿ç”¨è€…çš„ä½¿ç”¨è€…ä¸»è¦ç¾¤çµ„ï¼ˆprimary groupï¼‰ï¼Œ"
	echo "	<ç³»æ‰€åç¨±.txt> å…§çš„æ ¼å¼ç‚ºä¸€å€‹å­¸è™Ÿä½”ç”¨ä¸€è¡Œã€‚"
	echo
	echo "	æ¨¹ç‹€çµæ§‹:"
	echo "	./depts/"
	echo "	â”œâ”€â”€ asis.txt"
	echo "	â””â”€â”€ ecofin.txt"
	echo
	echo "	asis.txt æª”æ¡ˆçµæ§‹"
	echo "	â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	echo "	       â”‚ ./depts/asis.txt "
	echo "	â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	echo "	   1   â”‚ 08170875"
	echo "	   2   â”‚ 08170396"
	echo "	   3   â”‚ ..."
	echo "	â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	echo "2. æ ¹æ“š ./${depts_dir}/ è£¡é¢çš„ <ç³»æ‰€åç¨±.txt> åˆªé™¤ä½¿ç”¨è€…çš„å®¶è³‡æ–™å¤¾èˆ‡å¸³è™Ÿç›¸é—œè³‡æ–™"
}
while :
do
  case "$1" in
		-h | --help)
			display_help
			exit 0
		;;
		-gp | --generate-password)
			gp=true
			shift 1
			break
		;;
		-n | --new-shiny-server)
			new=true
			shift 1
			break
		;;
		--)
			shift
			break
		;;
		-*)
			echo "éŒ¯èª¤: æœªçŸ¥çš„é¸é …: $1" >&2
			display_help
			exit 1
		;;
		*)
			break
		;;
	esac
done

case "$1" in
  create)
		check_permission
		check_depts_dir
		create_prompt
	;;
	delete)
		check_permission
		check_depts_dir
		delete_prompt
	;;
	*)
		display_help
		exit 1
	;;
esac
```

### generate-sql.sh {.unnumbered}

``` {.bash}
#!/bin/bash
# author: kuaz
# last modified: 2021.09.13
# 
# é€™å€‹è…³æœ¬è¢«ç”¨ä¾†:
# 1. æ ¹æ“šå·²çŸ¥çš„å¸³è™Ÿå¯†ç¢¼å»ºç«‹ MySQL å¸³æˆ¶
# 2. æ ¹æ“šå¸³è™Ÿå»ºç«‹è³‡æ–™åº«ï¼Œç·¨ç¢¼ç‚º 'utf8mb4'
# 3. ä»¥ä¸ŠæŒ‡ä»¤æœƒå„²å­˜åœ¨ç•¶å‰è³‡æ–™å¤¾çš„ create-account.sql è£¡é¢
# 4. æ ¹æ“šå·²çŸ¥çš„å¸³è™Ÿåˆªé™¤è©² MySQL å¸³æˆ¶èˆ‡è³‡æ–™åº«
# 5. è‹¥åŠ ä¸Š -r, --run å³å¯é †ä¾¿åŸ·è¡Œè©²è…³æœ¬


# ç’°å¢ƒè®Šæ•¸
pass_dir='passwd'		# æ”¾ç½®å¯†ç¢¼çš„è³‡æ–™å¤¾ï¼Œç”±å¦ä¸€å€‹è…³æœ¬ ./create-users.sh ç”¢ç”Ÿ
filename='-accounts.sql'  # create/drop-accounts.sql æª”æ¡ˆå‰ç¶´æœƒæ ¹æ“šé¸é …è®ŠåŒ–
run=false			# é è¨­ç”¢ç”Ÿè…³æœ¬å¾Œä¸æœƒåŸ·è¡Œ

check_pass_dir() {
  if [ -d ${pass_dir} ]; then
		grps="$(ls ${pass_dir} | grep ".csv" | cut -d "." -f 1)"
  else
		echo "å¯†ç¢¼è³‡æ–™å¤¾ ${pass_dir} ä¸å­˜åœ¨ï¼è«‹å…ˆåŸ·è¡Œéå»ºç«‹å¸³è™Ÿè…³æœ¬ï¼ˆcreate-users.shï¼‰å¾Œï¼Œå†åŸ·è¡Œä¸€æ¬¡æ­¤è…³æœ¬ã€‚"
		exit 1;
  fi
}

write_to_mysql_db() {
  if [ ${run} = true ]; then
		echo "è«‹è¼¸å…¥ MySQL å¸³æˆ¶ root çš„å¯†ç¢¼: ğŸ‘‡"
		mysql -u root -p < ${filename}
		clean_sql_script
  else
		echo "å·²æ–¼ $(pwd) ç”¢ç”Ÿ ${filename} ğŸ‰"
  fi
}

create_users_and_databases() {
  echo "set global validate_password.policy=LOW;" | tee -a ${filename} > /dev/null 2>&1;
  for grp in ${grps}
	do 
		while read line;
		do
			stu="$(echo ${line} | cut -d ',' -f 1)"
			pass="$(echo ${line} | cut -d ',' -f 2)"
			echo "create user '${stu}'@'localhost' identified by '${pass}';" \
				| tee -a ${filename} > /dev/null 2>&1
			echo "create database \`${stu}\` character set utf8mb4 collate utf8mb4_unicode_ci;" \
				| tee -a ${filename} > /dev/null 2>&1
			echo "grant all privileges on \`${stu}\`.* to '${stu}'@'localhost';" \
				| tee -a ${filename} > /dev/null 2>&1
		done < ${pass_dir}/${grp}.csv
  done
  echo "flush privileges;" | tee -a ${filename} > /dev/null 2>&1;
  write_to_mysql_db
}

drop_users_and_databases() {
  for grp in ${grps}
	do 
		while read line;
		do
			stu="$(echo ${line} | cut -d ',' -f 1)"
			echo "drop user '${stu}'@'localhost';" \
				| tee -a ${filename} > /dev/null 2>&1
			echo "drop database \`${stu}\`;" \
				| tee -a ${filename} > /dev/null 2>&1
		done < ${pass_dir}/${grp}.csv
  done
  write_to_mysql_db
}

display_help() {
  echo "é€™å€‹è…³æœ¬è¢«ç”¨ä¾†:"
  echo "1. æ ¹æ“šå·²çŸ¥çš„å¸³è™Ÿå¯†ç¢¼å»ºç«‹ MySQL å¸³æˆ¶"
  echo "2. æ ¹æ“šå¸³è™Ÿå»ºç«‹è³‡æ–™åº«ï¼Œç·¨ç¢¼ç‚º 'utf8mb4'"
  echo "3. ä»¥ä¸ŠæŒ‡ä»¤æœƒå„²å­˜åœ¨ç•¶å‰è³‡æ–™å¤¾çš„ create-account.sql è£¡é¢"
  echo "4. æ ¹æ“šå·²çŸ¥çš„å¸³è™Ÿåˆªé™¤è©² MySQL å¸³æˆ¶èˆ‡è³‡æ–™åº«"
  echo "5. è‹¥åŠ ä¸Š -r, --run å³å¯é †ä¾¿åŸ·è¡Œè©²è…³æœ¬"
  echo
  echo "ä½¿ç”¨æ–¹æ³•: $0 [option...] {create|drop}"
  echo
  echo "options: "
  echo "  -r, --run  åŸ·è¡Œè…³æœ¬"
  echo "  -h, --help  é¡¯ç¤ºèªªæ˜"
  echo "  æ²’æœ‰åŠ ä»»ä½•é¸é …: åƒ…ç”¢ç”Ÿ .sql è…³æœ¬"
  echo
  exit 0
}

clean_sql_script() {
  read -p "æ˜¯å¦è¦æ¸…é™¤ ${filename}? (Yes/No)" yn
  case $yn in
		[Yy]* ) rm ${filename} ;;
		[Nn]* ) exit 0;;
  esac
  echo "DONE ğŸ‰"
}

while :
do
  case "$1" in
		-r | --run)
			run=true
			shift 1
			;;
		-h | --help)
			display_help
			exit 0
			;;
		--)
			shift
			break
			;;
		-*)
			echo "éŒ¯èª¤: æœªçŸ¥çš„é¸é …: $1" >&2
			display_help
			exit 1
			;;
		*)
			break
			;;
	esac
done
case "$1" in
  create)
		check_pass_dir
		if [ $? -ne 1 ]; then
			filename="$1$filename"
			create_users_and_databases
		fi
		;;
	drop)
		check_pass_dir
		if [ $? -ne 1 ]; then
			filename="$1$filename"
			drop_users_and_databases
		fi
		;;
	*)
		display_help
		exit 0
		;;
esac
```
