\cleardoublepage

# (APPENDIX) 附錄 {-}

# 相關軟體

<!-- 因為內容太多，書本篇收錄的會變得太混雜，所以我把一些內容放到這裡。 -->

<!-- ## 由 Windows 10 系統進入 BIOS {.unnumbered .hidden} -->

<!-- ## Windows Terminal -->

## PuTTY

使用 PuTTY 連線至 OpenSSH 伺服器

### 以 PuTTY 產生 key

另一個方法不會需要你手動安裝 OpenSSH Client，不過、一樣地，要安裝PuTTY 程式。

#### Step 1 --- 安裝 PuTTY

到開發者的網站，然後下載適合你 Windows 的版本 (副檔名為 \*.msi 的安裝程式)

-   <https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html>

根據你的需求設定安裝程式

![](figures/putty-installer-configuration.png){.figure}

待安裝程式安裝完成

![](figures/putty-installer-finish.png){.figure}

安裝完成後，點選「開始」，找到 PuTTYgen開啟，或是點選「開始」，鍵入 `puttygen` 後按 Enter↩

#### Step 2 --- 經由 PuTTYgen 產生 ssh key pairs {.unnumbered}

跟 OpenSSH Client 一樣地，你可以在下方的 Types 選擇你偏好的加密方式。點選「Generate」開始產生 key，此時不要傻傻地在那邊等，要在程式進度條下方空白處隨意移動你的滑鼠鼠標。

![](figures/puttygen-genkey.png){.figure}

完成後，可以在 Comment 的輸入框註解一下這個 key 是從哪裡來的，以後擁有多個 key pairs 時才不會搞混。當然你也可以用密碼保護這個 key pairs，如果有需要在 Key passphrase 與 Confirm passphrase 輸入一模一樣的密碼。

![](figures/puttygen-genkey-finish.png){.figure}

#### Step 3 --- 妥善保存好產生的 Key {.unnumbered}

分別按下「Save public key」與「Save private key」找到適合的地方儲存它。

### 上傳以 PuTTY 產生的 ssh key pairs {.unnumbered}

PuTTY 產生的 public key 與 private key 格式比較特別，並不能直接把 public key 裡面的文字直接貼到遠端電腦的 `~/.ssh/authorized_keys` 檔案裡面，需要經由 PuTTYgen.exe 讀取 \*.ppk 才能得到正確格式的 public key。首先把 PuTTYgen 程式打開。

![](figures/puttygen-menu.png){.figure}

接著按「Load」把剛剛產生的 \*.ppk 檔案讀取進來。會看到一行字「Public key for pasting into OpenSSH authorized_keys file」下面的可複製區域就是 public key，把它整段複製起來。

![](figures/puttygen-load-ppk.png){.figure}

接著打開「PowerShell」或是「命令提示字元」，輸入:

``` {.powershell .prefixed_powershell}
echo "<YOUR_PUBLIC_KEY>" | ssh asis@192.168.0.13 "cat >> ~/.ssh/authorized_keys"
```

-   將 `<YOUR_PUBLIC_KEY>` 替換成自己的 public key

-   這裡的 `asis` 為第一章的[使用者設定](#使用者設定)的預設使用者

-   `192.168.0.13` 為我虛擬主機的 ip 位址，查詢 ip 位址可以先手動登入虛擬主機後，用 `hostname -I` 或是 `ip addr show` 指令查詢

接著按 Enter↩，跳出輸入密碼提示，這裡輸入預設的使用者密碼 `asis`

``` {.console_output}
asis@192.168.0.13's password:
```

輸入完成不會出現任何訊息是正常的，代表操作沒有問題且已經可以使用 PuTTY 連線了。

### PuTTYgen 產生的 key pairs 的連線方式: {.unnumbered}

SSH 連線方式大同小異:

-   首先點選「開始」，鍵入 `PuTTY` 打開客戶端

-   在左邊的 「Category:」 下，選取 「Session」

-   於 Host Name 輸入「使用者\@目的地 IP」，像是「`asis@192.168.0.13`」

    ::: {.infobox .info}
    你可以點選下面的「Default Settings」後，接著按「Save」會把剛剛輸入的 IP 與 Port 儲存至「Default Settings」內，當然你也可以自己取一個新的名字。
    :::

-   接著展開左邊 「Category:」 下的「Connection」 ➜ 點選「SSH」 ➜ 再點選「Auth」，於最下面的「Private key file for authentication:」點選「Browse...」選取 `*.ppk` 檔案位置

-   完成後點選「Open」連線

與使用 ssh 指令連線相同，都會先提醒你目的地是否正確。確認無誤按下「Accept」

![](figures/putty-security-alert.png){.figure}

連接成功!

![](figures/putty-connection-success.png){.figure}

<!-- ## 文本編輯器 {.unnumbered} -->

<!-- ### vim {.unnumbered} -->

<!-- ### nano {.unnumbered} -->

### 更改預設的文本編輯器 {.unnumbered}

這個指令可以變更系統編輯文件所用的程式

``` {.bash}
sudo update-alternatives --config editor
```

按了 Enter↩ 之後，會出現現在可用的編輯器，輸入對應的編號即可變更。有標 `*` 號的編輯器為目前設定的預設編輯器。

``` {.console_output}
There are 4 choices for the alternative editor (providing /usr/bin/editor).

  Selection    Path                Priority   Status
------------------------------------------------------------
  0            /bin/nano            40        auto mode
  1            /bin/ed             -100       manual mode
  2            /bin/nano            40        manual mode
* 3            /usr/bin/vim.basic   30        manual mode
  4            /usr/bin/vim.tiny    15        manual mode

Press <enter> to keep the current choice[*], or type selection number: 3
```

## 帳號管理 {.unnumbered}

Work in Process 並不是最新版本

### users.sh {.unnumbered}

``` {.bash}
#!/bin/bash
# author: kuaz
# last modified: 2022.02.24
# 
# This script is used to:
# 1. Create Accounts via ./depts/${dept}.txt (one student ID per line).
# 2. Remove Accounts via ./depts/${dept}.txt
# Issue: https://stackoverflow.com/questions/12916352/shell-script-read-missing-last-line

# 環境變數
depts_dir='depts'       # 放置用來建置 linux 帳號的系資料夾
pass_dir='passwd'       # 放置建置完成的 linux 帳號密碼的資料夾，建制完後
                        # 可搭配建置 MySQL 帳號與資料庫腳本（generate-sql.sh）使用
gp=false                # 不需要用隨機密碼建立帳號的旗標
new=false               # 是否是新版的 shiny app 連結方式，如果為 new，將不會使用 systemetic link 的方式連結
dryrun=false
# ubuntu_version=$(lsb_release -rs | cut -d '.' -f 1)

check_permission() {
    if [ $(id -u) -ne 0 ]; then
        echo "必須以 root 權限執行此腳本！";
        exit 1;
    fi
}

check_depts_dir() {
    if [ -d ${depts_dir} ]; then
        grps="$(ls ./${depts_dir} | grep ".txt" | cut -d "." -f 1)"
        for grp in ${grps}
        do
            # https://stackoverflow.com/questions/28038633/wc-l-is-not-counting-last-of-the-file-if-it-does-not-have-end-of-line-character
            count=$(awk 'END{print NR}' ./${depts_dir}/${grp}.txt)
            file=$(realpath ./${depts_dir}/${grp}.txt)
            if [ $count -lt 1 ]; then
                echo "請再檢查一次 ./${depts_dir}/ 內是否含有正確格式的學號檔案！"
                echo "有問題的檔案: $file"
                exit 1
            else
                echo "於 $file 發現了 $count 個學生"
            fi
        done
    else
        echo "系資料夾 ${depts_dir} 不存在！請先手動創建或是由選項 --generate-configuration 建立。"
        exit 1;
    fi
}

create_pass_dir() {
    if [ ! -d ${pass_dir} ]; then
        echo "存放密碼的 ${pass_dir} 資料夾不存在，將建立 ${pass_dir} 資料夾"
        mkdir ${pass_dir}
    else
        read -p "存放密碼的 ${pass_dir} 資料夾已存在！是否要將其移除後繼續建立帳號? (yes/No)" yn
        case $yn in
            [Yy]* ) 
                rm -rf ${pass_dir}
                make_pass_dir
            ;;
            [Nn]* ) exit 1;;
        esac
    fi
}

create_users() {
    # 如果有產生密碼的需求
    if [ ${gp} = true ]; then
        create_pass_dir
    fi

    for grp in ${grps}
    do 
        # 確認使用者群組是否存在，如果不存在將自動建立
        if $(grep -q "^${grp}" /etc/group); then
            echo "使用者群組 '${grp}' 已存在，不需再建立。"
        else
            # 如果不正式建立帳號
            if [ ${dryrun} = false ]; then
                groupadd ${grp}
            fi
            echo "已建立 ${grp} 使用者群組"
        fi

        # 使用舊方法連結 ShinyApps
        if [ ${new} = false ] && [ ! -d /srv/shiny-server/${grp} ]; then
            echo "/srv/shiny-server/${grp} 資料夾不存在，將建立群組資料夾"
            if [ ${dryrun} = false ]; then
                mkdir /srv/shiny-server/${grp}
            fi
        fi

        # 逐行讀取學號
        while IFS= read -r stu || [ -n "$stu" ];
        do
            cur_user=${stu}
            if $(id "${cur_user}" > /dev/null 2>&1); then
                echo "使用者 '${cur_user}' 已存在，略過此使用者。"
            elif [ ${dryrun} = false ]; then
                # TODO: 更好的方法？ 例如檢查 useradd 版本，不過不知道 badnames 是哪版加的
                # 在 Ubuntu 16.04 版本的 useradd 沒有 --badnames 選項
                # if [ ${ubuntu_version} == "16" ]; then
                #     su - -c "useradd -N -g ${grp} -m ${cur_user}"
                # else
                #     su - -c "useradd --badnames -N -g ${grp} -m ${cur_user}"
                # fi
	    	useradd --badnames -N -g ${grp} -m ${cur_user}

                # 產生隨機密碼
                if [ ${gp} = false ]; then
                    cur_user_password=${cur_user}
                else
                    cur_user_password=$(openssl rand -base64 6)
                fi
                
                # 以 root 權限創立使用者帳號，並設定密碼
                echo "${cur_user}:${cur_user_password}" | chpasswd

                # 將設定的帳號密碼儲存一份到資料夾中
                echo "${cur_user},${cur_user_password}" | tee -a ./${pass_dir}/${grp}.csv > /dev/null 2>&1
                # 將 ShinyApp 軟連結至使用者資料夾
                if [ ${new} = false ]; then
                    # 需要先在 /etc/skel/ 建立 ShinyApps 資料夾，才可成功連結
                    ln -s /home/${cur_user}/ShinyApps /srv/shiny-server/${grp}/${cur_user}
                fi
            else
                # 如果僅執行
                echo "建立了 ${cur_user} 的使用者帳戶" 
            fi
        done < ./${depts_dir}/${grp}.txt
    done
}

delete_users() {
    for grp in ${grps}
    do 
        while IFS= read -r stu || [ -n "$stu" ];
        do
            userdel -r ${stu} > /dev/null 2>&1
            if [ ${new} = false ]; then
                rm -rf /srv/shiny-server/${grp}/${stu}
            fi
        done < ./${depts_dir}/${grp}.txt
    done
    read -p "使用者已移除，是否要順便移除存放密碼的資料夾 ${pass_dir}? (yes/No)" yn
    case $yn in
        [Yy]* ) 
            rm -rf ${pass_dir}
        ;;
        [No]* ) exit 0;;
    esac
}

create_prompt() {
    if [ ${new} = false ]; then
        read -p "即將建立使用者帳戶，確認使用者資料是否無誤? (Yes/No)" yn
    else
        read -p "即將以新的 shiny-server 模式建立使用者帳戶，確認使用者資料是否無誤? (Yes/No)" yn
    fi
    case $yn in
        [Yy]* ) create_users;;
        [Nn]* ) exit 0;;
    esac
}

delete_prompt() {
    read -p "即將 '刪除' 使用者帳戶，於 /home/<使用者> 的資料將會消失，是否執行? (Yes/No)" yn
    case $yn in
        [Yy]* ) delete_users;;
        [Nn]* ) exit 0;;
    esac
}

generate_configuration() {
    if [ -d ${depts_dir} ]; then
        echo "資料夾已存在！"
    else
        mkdir ${depts_dir}
        touch ${depts_dir}/asisstuc.txt
        touch ${depts_dir}/defstu.txt
        echo 08170875 > ${depts_dir}/asisstuc.txt
        echo 08220000 > ${depts_dir}/defstu.txt
        echo "設定檔案建立完成"
    fi
    exit 0;
}

display_help() {
    echo "使用方法: $0 [選項...] {create|delete}"
    echo 
    echo "選項: "
    echo "  -gp, --generate-password    以 openssl 產生隨機的使用者密碼"
    echo "  -n, --new-shiny-server      只建立使用者，不軟連結至 /srv/shiny-server/ 資料夾；新的 shiny-server 不使用軟連結"
    echo
    echo "此腳本被用來: "
    echo "1. 根據 ./${depts_dir}/ 裡面的 <系所名稱.txt> 建立帳號，"
    echo "  系所名稱會被用來當作 linux 使用者的使用者主要群組（primary group），"
    echo "  <系所名稱.txt> 內的格式為一個學號佔用一行。"
    echo
    echo "  樹狀結構:"
    echo "  ./depts/"
    echo "  ├── asis.txt"
    echo "  └── ecofin.txt"
    echo
    echo "  asis.txt 檔案結構"
    echo "  ───────┬──────────────────"
    echo "         │ ./depts/asis.txt "
    echo "  ───────┼──────────────────"
    echo "     1   │ 08170875"
    echo "     2   │ 08170396"
    echo "     3   │ ..."
    echo "  ───────┴──────────────────"
    echo "2. 根據 ./${depts_dir}/ 裡面的 <系所名稱.txt> 刪除使用者的家資料夾與帳號相關資料"
}
while :
do
    case "$1" in
        -h | --help)
            display_help
            exit 0
        ;;
        -d | --dry-run)
            dryrun=true
            shift 1
            break
        ;;
        -p | --generate-password)
            gp=true
            shift 1
            break
        ;;
        -c | --generate-configuration)
            generate_configuration
            exit 0
        ;;
        -n | --new-shiny-server)
            new=true
            shift 1
            break
        ;;
        -*)
            echo "錯誤: 未知的選項: $1" >&2
            display_help
            exit 1
        ;;
        *)
            break
        ;;
    esac
done

case "$1" in
    create)
	check_permission
        check_depts_dir
        create_prompt
    ;;
    delete)
	check_permission
        check_depts_dir
        delete_prompt
    ;;
    *)
	echo "使用附加選項 -h 或是 --help 查詢指令的使用方法。" 
        exit 1
    ;;
esac
```

### generate-sql.sh {.unnumbered}

``` {.bash}
#!/bin/bash
# author: kuaz
# last modified: 2021.09.13
# 
# 這個腳本被用來:
# 1. 根據已知的帳號密碼建立 MySQL 帳戶
# 2. 根據帳號建立資料庫，編碼為 'utf8mb4'
# 3. 以上指令會儲存在當前資料夾的 create-account.sql 裡面
# 4. 根據已知的帳號刪除該 MySQL 帳戶與資料庫
# 5. 若加上 -r, --run 即可順便執行該腳本


# 環境變數
pass_dir='passwd'       # 放置密碼的資料夾，由另一個腳本 ./create-users.sh 產生
filename='-accounts.sql'  # create/drop-accounts.sql 檔案前綴會根據選項變化
run=false           # 預設產生腳本後不會執行

check_pass_dir() {
  if [ -d ${pass_dir} ]; then
        grps="$(ls ${pass_dir} | grep ".csv" | cut -d "." -f 1)"
  else
        echo "密碼資料夾 ${pass_dir} 不存在！請先執行過建立帳號腳本（create-users.sh）後，再執行一次此腳本。"
        exit 1;
  fi
}

write_to_mysql_db() {
  if [ ${run} = true ]; then
        echo "請輸入 MySQL 帳戶 root 的密碼: 👇"
        mysql -u root -p < ${filename}
        clean_sql_script
  else
        echo "已於 $(pwd) 產生 ${filename} 🎉"
  fi
}

create_users_and_databases() {
  echo "set global validate_password.policy=LOW;" | tee -a ${filename} > /dev/null 2>&1;
  for grp in ${grps}
    do 
        while read line;
        do
            stu="$(echo ${line} | cut -d ',' -f 1)"
            pass="$(echo ${line} | cut -d ',' -f 2)"
            echo "create user '${stu}'@'localhost' identified by '${pass}';" \
                | tee -a ${filename} > /dev/null 2>&1
            echo "create database \`${stu}\` character set utf8mb4 collate utf8mb4_unicode_ci;" \
                | tee -a ${filename} > /dev/null 2>&1
            echo "grant all privileges on \`${stu}\`.* to '${stu}'@'localhost';" \
                | tee -a ${filename} > /dev/null 2>&1
        done < ${pass_dir}/${grp}.csv
  done
  echo "flush privileges;" | tee -a ${filename} > /dev/null 2>&1;
  write_to_mysql_db
}

drop_users_and_databases() {
  for grp in ${grps}
    do 
        while read line;
        do
            stu="$(echo ${line} | cut -d ',' -f 1)"
            echo "drop user '${stu}'@'localhost';" \
                | tee -a ${filename} > /dev/null 2>&1
            echo "drop database \`${stu}\`;" \
                | tee -a ${filename} > /dev/null 2>&1
        done < ${pass_dir}/${grp}.csv
  done
  write_to_mysql_db
}

display_help() {
  echo "這個腳本被用來:"
  echo "1. 根據已知的帳號密碼建立 MySQL 帳戶"
  echo "2. 根據帳號建立資料庫，編碼為 'utf8mb4'"
  echo "3. 以上指令會儲存在當前資料夾的 create-account.sql 裡面"
  echo "4. 根據已知的帳號刪除該 MySQL 帳戶與資料庫"
  echo "5. 若加上 -r, --run 即可順便執行該腳本"
  echo
  echo "使用方法: $0 [option...] {create|drop}"
  echo
  echo "options: "
  echo "  -r, --run  執行腳本"
  echo "  -h, --help  顯示說明"
  echo "  沒有加任何選項: 僅產生 .sql 腳本"
  echo
  exit 0
}

clean_sql_script() {
  read -p "是否要清除 ${filename}? (Yes/No)" yn
  case $yn in
        [Yy]* ) rm ${filename} ;;
        [Nn]* ) exit 0;;
  esac
  echo "DONE 🎉"
}

while :
do
  case "$1" in
        -r | --run)
            run=true
            shift 1
            ;;
        -h | --help)
            display_help
            exit 0
            ;;
        --)
            shift
            break
            ;;
        -*)
            echo "錯誤: 未知的選項: $1" >&2
            display_help
            exit 1
            ;;
        *)
            break
            ;;
    esac
done
case "$1" in
  create)
        check_pass_dir
        if [ $? -ne 1 ]; then
            filename="$1$filename"
            create_users_and_databases
        fi
        ;;
    drop)
        check_pass_dir
        if [ $? -ne 1 ]; then
            filename="$1$filename"
            drop_users_and_databases
        fi
        ;;
    *)
        display_help
        exit 0
        ;;
esac
```

## Mysql 8.0 root 密碼重設 {.unnumbered}

先建立一個含有改變 root 密碼的 sql 語法文字檔案

``` {.bash .prefixed}
vim mysql-init
```

``` {.sqlmysql}
ALTER USER 'root'@'localhost' IDENTIFIED with caching_sha2_password by '<新的 root 密碼>';
```

如存好後將擁有者與使用者群組改成 `mysql` 後，移至 `/tmp` 資料夾，使 mysql 使用者可以存取。

``` {.bash .prefixed}
chown mysql.mysql mysql-init && mv mysql-init /tmp
```

切換至 root 使用者進行後續操作

``` {.bash .prefixed}
sudo su -
```

將目前的 mysql 關閉

``` {.bash .prefixed_root}
killall -9 mysqld
```

或是使用 `systemctl` 指令關閉 mysql 服務

`{.bash prefixed} systemctl stop mysql.service`

接著使用 mysqld 指令啟動 mysql 並指定 `--user`、`--defaults-file` 與 `--init-file` 參數。

``` {.bash .prefixed_root}
mysqld --defaults-file=/etc/mysql/mysql.conf.d/mysqld.cnf \ 
--user=mysql \ 
--init-file=/tmp/mysql-init &
```

-   `--defaults-file`: MySQL 預設啟動的設定檔案

-   `--user`: 以使用者 `mysql` 執行

-   `--init-file`: 初始化時，執行 `/tmp/mysql-init` 指令，變更密碼

-   `&`: 將 mysql deamon 放至背景執行。

此時，應該可以正常登入了。

::: {.infobox .caution}
如果不行的話，請檢查位於 `/var/log/mysql/error.log` 的錯誤紀錄，如果有看到類似 `/var/run/mysqld` 的錯誤，需要手動建立資料夾，並把權限變更為 `mysql` 用戶的權限。 操作完之後再從關閉 mysql 服務開始，再嘗試一次。

參考指令如下：

``` {.bash .prefixed_root}
mkdir /var/run/mysqld && chown mysql.mysql /var/run/mysqld
```
:::

最後以正常的服務啟動 mysql：

``` {.bash .prefixed_root}
systemctl restart mysql.service
```

退出 root 帳號

``` {.bash .prefixed_root}
exit
```

試以新密碼登入 mysql root 帳號：

``` {.bash .prefixed}
mysql -u root -p
```

成功 🎊

``` {.console_output}
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 17
Server version: 8.0.26-0ubuntu0.20.04.3 (Ubuntu)

Copyright (c) 2000, 2021, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> 
```
