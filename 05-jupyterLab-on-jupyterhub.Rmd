# JupyterLab on JupyterHub

æœ¬ç¯‡æ•™å­¸å®Œå…¨ç…§è‘—[@mangecoeur_elena_vuong_luria_rk_2021]æ‰€å¯«çš„æ•™å­¸æ“ä½œã€‚æ—¨åœ¨å»ºç«‹ Jupyterhub ç’°å¢ƒã€‚

## äº‹å‰æº–å‚™

å…ˆç¢ºèªç›®å‰çš„ä½¿ç”¨è€… asis æ“æœ‰ sudo çš„æ¬Šé™ã€‚

## è¨­ç½® Python 3 ç’°å¢ƒ

é¦–å…ˆï¼Œä¸€æ¨£åœ°ï¼Œåªè¦å®‰è£å¥—ä»¶éƒ½éœ€è¦å…ˆæ›´æ–°å¥—ä»¶ä¾†æºã€‚é€™è£¡æˆ‘å€‘ç”¨ `&&` é€£æ¥å…©å€‹æŒ‡ä»¤ï¼Œè®“æ›´æ–°èˆ‡å®‰è£ä¾åºåŸ·è¡Œã€‚

``` {.bash .prefixed}
sudo apt update && sudo apt install python3-pip --yes
```

å®‰è£ `python3-venv` ï¼Œå¾ŒçºŒå»ºç«‹ python è™›æ“¬ç’°å¢ƒæ™‚æœƒç”¨åˆ°

``` {.bash .prefixed}
sudo apt install python3-venv --yes
```

ç›®å‰ Ubuntu 22.04 ç³»çµ±å…§å»ºçš„ Python ç‚º Python 3.10ï¼Œæˆ‘å€‘é‚„æ˜¯å¯ä»¥å¤šè£ä¸€å€‹å«åš `python-is-python3` çš„å¥—ä»¶ï¼Œå°‡ `python` è¨­ç‚º `python3` çš„åˆ¥åï¼Œæ‰“æŒ‡ä»¤æ™‚ä¸ç”¨å¤šæ‰“ä¸€å€‹ 3ã€‚

``` {.bash .prefixed}
sudo apt install python-is-python3 --yes
```

## JupyterLab èˆ‡ JupyterHub

### æ¦‚è¿°

### æ–¼è™›æ“¬ç’°å¢ƒä¸­è¨­ç½® JupyterLab èˆ‡ JupyterHub

``` {.bash .prefixed}
sudo python -m venv /opt/jupyterhub
```

``` {.bash .prefixed}
sudo /opt/jupyterhub/bin/python -m pip install wheel
```

``` {.bash .prefixed}
sudo /opt/jupyterhub/bin/python -m pip install jupyterlab jupyterhub
```

``` {.bash .prefixed}
sudo /opt/jupyterhub/bin/python -m pip install ipywidgets
```

``` {.bash .prefixed}
curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
sudo apt-get install -y nodejs
```

``` {.bash .prefixed}
sudo npm install -g configurable-http-proxy
```

### è¨­å®š JupyterHub

``` {.bash .prefixed}
sudo mkdir -p /opt/jupyterhub/etc/jupyterhub/
```

``` {.bash .prefixed}
cd /opt/jupyterhub/etc/jupyterhub/
```

``` {.bash .prefixed}
sudo /opt/jupyterhub/bin/jupyterhub --generate-config
```

``` {.bash .prefixed}
sudo vim jupyterhub_config.py
```

::: code-label
/opt/jupyterhub/etc/jupyterhub/jupyterhub_config.py
:::

``` python
c.JupyterHub.bind_url = 'http://:8000/jhub'
c.Spawner.default_url = '/lab'
c.Authenticator.admin_users = {'asis'}
c.Spawner.cmd = ['jupyter-labhub']
```

### æ–°å¢é–‹æ©Ÿè‡ªå‹•å•Ÿå‹• JupyterHub çš„æœå‹™

``` {.bash .prefixed}
sudo mkdir -p /opt/jupyterhub/etc/systemd
```

``` {.bash .prefixed}
sudo vim /opt/jupyterhub/etc/systemd/jupyterhub.service
```

::: code-label
/opt/jupyterhub/etc/systemd/jupyterhub.service
:::

``` bash
[Unit]
Description=JupyterHub
After=syslog.target network.target

[Service]
User=root
Environment="PATH=/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/opt/jupyterhub/bin"
ExecStart=/opt/jupyterhub/bin/jupyterhub -f /opt/jupyterhub/etc/jupyterhub/jupyterhub_config.py

[Install]
WantedBy=multi-user.target
```

``` {.bash .prefixed}
sudo ln -s /opt/jupyterhub/etc/systemd/jupyterhub.service \
    /etc/systemd/system/jupyterhub.service
```

``` {.bash .prefixed}
sudo systemctl daemon-reload
```

``` {.bash .prefixed}
sudo systemctl enable jupyterhub.service
```

``` {.bash .prefixed}
sudo systemctl start jupyterhub.service
```

``` {.bash .prefixed}
sudo systemctl status jupyterhub.service
```

## JupyterHub ä¸­çš„é‹ç®—æ ¸å¿ƒ

### Conda çš„ PythonğŸ ç’°å¢ƒ

åˆ°[å®˜æ–¹ä¸‹è¼‰é é¢](https://www.anaconda.com/download#downloads)è¤‡è£½æœ€æ–°çš„å®‰è£ç¨‹å¼çš„é€£çµ

``` {.bash .prefixed}
cd /tmp && \ 
    wget https://repo.anaconda.com/archive/Anaconda3-2023.07-2-Linux-x86_64.sh
```

å°‡ä¸‹è¼‰ä¸‹ä¾†çš„è…³æœ¬åŠ ä¸ŠåŸ·è¡Œæ¬Šé™

``` {.bash .prefixed}
chmod +x  Anaconda3-2023.07-2-Linux-x86_64.sh
```

ä»¥è¶…ç´šä½¿ç”¨è€…åŸ·è¡Œ

``` {.bash .prefixed}
sudo ./Anaconda3-2023.07-2-Linux-x86_64.sh
```

åŸ·è¡Œå¾Œï¼Œæœƒè¦æ±‚ä½ å…ˆé–±è®€ä½¿ç”¨è€…æˆæ¬Šæ¢æ¬¾

``` {.console_output}

Welcome to Anaconda3 2023.07-2

In order to continue the installation process, please review the license
agreement.
Please, press ENTER to continue
>>>
```

é€™è£¡æŒ‰ Enter

``` {.bash .prefixed}
==================================================
End User License Agreement - Anaconda Distribution
==================================================

Copyright 2015-2023, Anaconda, Inc.

All rights reserved under the 3-clause BSD License:

This End User License Agreement (the "Agreement") is a legal agreement between you and Anaconda, Inc. ("Anaconda") and g
overns your use of Anaconda Distribution (which was formerly known as Anaconda Individual Edition).

Subject to the terms of this Agreement, Anaconda hereby grants you a non-exclusive, non-transferable license to:

  * Install and use the Anaconda Distribution (which was formerly known as Anaconda Individual Edition),
  * Modify and create derivative works of sample source code delivered in Anaconda Distribution from Anaconda's reposito
ry, and;
  * Redistribute code files in source (if provided to you by Anaconda as source) and binary forms, with or without modif
ication subject to the requirements set forth below, and;

Anaconda may, at its option, make available patches, workarounds or other updates to Anaconda Distribution. Unless the u
pdates are provided with their separate governing terms, they are deemed part of Anaconda Distribution licensed to you a
s provided in this Agreement.  This Agreement does not entitle you to any support for Anaconda Distribution.

Anaconda reserves all rights not expressly granted to you in this Agreement.

Redistribution and use in source and binary forms, with or without modification, are permitted provided that the followi
ng conditions are met:

  * Redistributions of source code must retain the above copyright notice, this list of conditions and the following dis
--More--
```

é–±è®€å®Œå¾Œéµå…¥ `q` é€€å‡º

``` {.console_output}
Do you accept the license terms? [yes|no]
[no] >>>
```

é€™è£¡è¼¸å…¥ `yes` åŒæ„ä½¿ç”¨è€…æˆæ¬Šåˆç´„

``` {.console_output}
Anaconda3 will now be installed into this location:
/root/anaconda3

  - Press ENTER to confirm the location
  - Press CTRL-C to abort the installation
  - Or specify a different location below

[/root/anaconda3] >>>
```

å°‡ `/opt/conda` æŒ‡å®šç‚ºå®‰è£è·¯å¾‘ï¼Œä¸¦ç­‰å¾…å®‰è£ç¨‹å¼å®‰è£

``` {.bash .prefixed}
sudo mkdir /opt/conda/envs
```

å®Œæˆå¾Œï¼Œæœƒå•ä½ è¦ä¸è¦ç•¶ä½ åŸ·è¡Œ shell ä¹‹å¾Œï¼Œè‡ªå‹•é—œè¯ `conda` çš„æŒ‡ä»¤è‡³çµ‚ç«¯æ©Ÿï¼Œé€™è£¡å¡«å…¥ `no`ã€‚å› ç‚ºä¸¦ä¸æ˜¯æ¯æ¬¡é–‹çµ‚ç«¯æ©Ÿéƒ½æœƒç”¨åˆ° `conda`

``` {.console_output}
done
installation finished.
Do you wish the installer to initialize Anaconda3
by running conda init? [yes|no]
[no] >>>
```

æ¥ä¸‹ä¾†åˆ‡æ›è‡³ `/opt/conda/envs/` è³‡æ–™å¤¾ï¼Œæ–°å¢çµ¦ jupyterhub çš„ python æ ¸å¿ƒ

``` {.bash .prefixed}
cd /opt/conda/envs/ && sudo vim environment.yml
```

å¡«å…¥ä»¥ä¸‹è¨­å®š

::: code-label
/opt/conda/envs/environment.yml
:::

``` yaml
name: python
channels:
  - defaults
dependencies:
  - python=3.10
  - ipykernel
  - pip:
    - ipython-sql
    - PyMySQL
    - matplotlib
    - plotly
    - pandas
prefix: /opt/conda/envs/python
```

ä»¥å‰›æ‰æ–°å¢çš„è¨­å®šæª”å»ºç«‹ python é‹ç®—æ ¸å¿ƒ

``` {.bash .prefixed}
sudo /opt/conda/bin/conda env create -f environment.yml
```


``` {.bash .prefixed}
sudo /opt/conda/envs/python/bin/python -m \
    ipykernel install \
    --prefix=/opt/jupyterhub/ \
    --name 'python3' \
    --display-name "Python (é è¨­)"
```

```{r, fig.cap='jupyterhub ç™»å…¥å¾Œçš„é é¢'}
knitr::include_graphics(path = 'figures/jupyterhub-main-page-kernel-python.png')
```

### R ç’°å¢ƒ

``` {.bash .prefixed}
sudo su - -c "R -e \"install.packages('IRkernel')\""
```

``` {.bash .prefixed}
sudo su - -c "R -e \"
    IRkernel::installspec(
        name='ir43',
        displayname='R 4.3',
        user=FALSE,
        prefix='/opt/jupyterhub'
    )
\""
```

``` console_output
Error in IRkernel::installspec(name = "ir41", displayname = "R 4.1") : 
  jupyter-client has to be installed but â€œjupyter kernelspec --versionâ€ exited with code 127.
In addition: Warning message:
In system2("jupyter", c("kernelspec", "--version"), FALSE, FALSE) :
  error in running command
Execution halted
```

ä¸»è¦åŸå› æ˜¯å› ç‚ºï¼Œç³»çµ±æ‰¾ä¸åˆ° `jupyter` æŒ‡ä»¤ã€‚å¯ä»¥è‡ªå·±åœ¨çµ‚ç«¯æ©Ÿé‡ç¾ä¸€æ¬¡ï¼š

``` {.bash .prefixed}
jupyter kernelspec --version
```

``` console_output
Command 'jupyter' not found, but can be installed with:

sudo snap install jupyter       # version 1.0.0, or
sudo apt  install jupyter-core  # version 4.6.3-3

See 'snap info jupyter' for additional versions.
```

æ‰¾ä¸åˆ°æŒ‡ä»¤ï¼Œå‡ºç¾äº†æ¨è–¦å®‰è£æ–¹å¼ï¼Œä¸éé€™ä¸æ˜¯æˆ‘å€‘è¦çš„ã€‚

é€™è£¡æœƒç”¨ä¸€å€‹æŠ€å·§è®“ç³»çµ±æ‰¾å¾—åˆ°ä½æ–¼ `/opt/jupyter/bin/jupyter` çš„æŒ‡ä»¤ã€‚ è—‰ç”±è»Ÿé€£çµåˆ°ç³»çµ±çš„ `path` è®Šæ•¸ä¸­è®“ R æ‰¾å¾—åˆ°ã€‚\
é¦–å…ˆå…ˆå°å‡º `PATH` è®Šæ•¸ï¼š

``` {.bash .prefixed}
echo $PATH
```

``` console_output
/home/asis/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin
```

æ”¾ç½®æ–¼å…¶ä¸­ä¸€å€‹ä½ç½®å°±è¡Œï¼Œæ³¨æ„ä¸è¦æ”¾ç½®åœ¨ /home åº•ä¸‹ï¼ŒåŸ·è¡Œ R æ™‚äº‹ä½¿ç”¨ root æ¬Šé™ï¼Œç”¨ root æ¬Šé™åŸ·è¡Œæ™‚ï¼Œä¸¦ä¸æœƒç¿» `/home/asis/` åº•ä¸‹çš„è³‡æ–™å¤¾ã€‚ é€™è£¡æˆ‘å€‘é¸ç”¨ `/usr/local/bin` ä½œç‚ºè»Ÿé€£çµæ”¾ç½® jupyter åŸ·è¡Œæª”ã€‚

``` {.bash .prefixed}
sudo ln -s /opt/jupyterhub/bin/jupyter /usr/local/bin
```

æ¥è‘—ç”¨ `which` æŒ‡ä»¤æŸ¥è©¢æŒ‡ä»¤æ˜¯å¦å­˜åœ¨ï¼š

``` {.bash .prefixed}
which jupyter
```

åˆ—å‡ºäºŒé€²åˆ¶åŸ·è¡Œæª”å­˜åœ¨ä½ç½®ï¼š

``` {.bash .prefixed}
ls -al $(which jupyter)
```

``` console_output
lrwxrwxrwx 1 root root 27 Sep 17 16:23 /usr/local/bin/jupyter -> /opt/jupyterhub/bin/jupyter
```

å¯ä»¥çœ‹åˆ°æŒ‡ä»¤ `jupyter` ä¹‹æ‰€ä»¥æœƒå­˜åœ¨æ˜¯å› ç‚ºè»Ÿé€£çµè‡³ `/opt/jupyterhub/bin/jupyter` å¾Œï¼Œå› ç‚º `/usr/local/bin` åœ¨è®Šæ•¸ `path` å…§ï¼Œè®“ç³»çµ±æ‰¾å¾—åˆ°ï¼Œæ‰å¯ä»¥ä½¿ç”¨é€™å€‹æŒ‡ä»¤ã€‚

å†åŸ·è¡Œä¸€æ¬¡å‰›é–‹å§‹çš„æŒ‡ä»¤ï¼š

``` {.bash .prefixed}
sudo su - -c "R -e \"
    IRkernel::installspec(
        name='ir41', 
        displayname='R 4.1',
        user=FALSE,
        prefix='/opt/jupyterhub'
    )
\""
```

``` {.bash .prefixed}
jupyter kernelspec list
```

``` console_output
Available kernels:
  ir43       /opt/jupyterhub/share/jupyter/kernels/ir43
  python3    /opt/jupyterhub/share/jupyter/kernels/python3
```

```{r, fig.cap='jupyterhub å®‰è£å®Œ R æ ¸å¿ƒèˆ‡é è¨­ Python çš„é é¢'}
knitr::include_graphics(path = 'figures/jupyterhub-main-page-kernel-R.png')
```

### SAS ç’°å¢ƒ

``` {.bash .prefixed}
sudo vim /opt/conda/envs/sas.yml
```

::: code-label
/opt/conda/envs/sas.yml
:::

``` yaml
name: sas
channels:
  - defaults
  - conda-forge
  - anaconda
dependencies:
  - sas_kernel
  - python=3.10
  - pip
  - ipykernel
prefix: /opt/conda/envs/sas
```

``` {.bash .prefixed}
sudo /opt/conda/bin/conda env create -f sas.yml
```

``` {.bash .prefixed}
sudo mkdir /opt/conda/envs/sas/share/jupyter/kernels/sas
```

``` {.bash .prefixed}
sudo vim /opt/conda/envs/sas/share/jupyter/kernels/sas/kernel.json
```

::: code-label
/opt/conda/envs/sas/share/jupyter/kernels/sas/kernel.json
:::

``` json
{
    "argv": [
        "/opt/conda/envs/sas/bin/python",
        "-m",
        "sas_kernel",
        "-f",
        "{connection_file}"
    ],
    "display_name": "SAS",
    "codemirror_mode": "sas",
    "language": "sas",
    "name": "sas"
}
```

``` {.bash .prefixed}
sudo cp \
    /opt/conda/envs/sas/lib/python3.10/site-packages/sas_kernel/data/logo-64x64.png \
    /opt/conda/envs/sas/share/jupyter/kernels/sas
```


``` {.bash .prefixed}
sudo jupyter kernelspec install \
    /opt/conda/envs/sas/share/jupyter/kernels/sas --sys-prefix
```

## è¨­ç½® Apache çš„åå‘ä»£ç†

``` {.bash .prefixed}
sudo vim /etc/apache2/sites-available/asis.conf
```

::: code-label
/etc/apache2/sites-available/asis.conf
:::

``` apache
<VirtualHost *:80>
    [...]

    ###
    # JupyterHub Reverse Proxy
    ###
    RedirectMatch permanent ^/jhub$ /jhub/
    RewriteCond %{HTTP:Connection} Upgrade [NC]
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteRule /jhub/(.*) ws://127.0.0.1:8000/jhub/$1 [NE,P,L]
    RewriteRule /jhub/(.*) http://127.0.0.1:8000/jhub/$1 [NE,P,L]

    <Location "/jhub/">
      # preserve Host header to avoid cross-origin problems
      ProxyPreserveHost on
      # proxy to JupyterHub
      ProxyPass         http://127.0.0.1:8000/
      ProxyPassReverse  http://127.0.0.1:8000/
    </Location>
    
</VirtualHost>
```

    http://<è™›æ“¬ä¸»æ©Ÿçš„ ip ä½å€>/jhub

## JupyterHub æ“´å……å¥—ä»¶

-   [jupyterlab-drawio](https://github.com/QuantStack/jupyterlab-drawio)

    ``` {.bash .prefixed}
    sudo /opt/jupyterhub/bin/pip install jupyterlab-drawio
    ```

-   [jupyterlab-git](https://github.com/jupyterlab/jupyterlab-git)

    ``` {.bash .prefixed}
    sudo /opt/jupyterhub/bin/pip \
        install --upgrade jupyterlab jupyterlab-git
    ```

-   [jupyterlab-variable-inspector](https://github.com/lckr/jupyterlab-variableInspector)

    ``` {.bash .prefixed}
    sudo /opt/jupyterhub/bin/pip \
        install lckr_jupyterlab_variableinspector
    ```

    ``` {.bash .prefixed}
    sudo su - -c "R -e \"install.packages('repr')\""
    ```

-   [jupyterext-text-shortcuts](https://github.com/techrah/jupyterext-text-shortcuts)

    ``` {.bash .prefixed}
    sudo jupyter labextension install @techrah/text-shortcuts
    ```

-   [jupyterlab-spreadsheet](https://github.com/quigleyj97/jupyterlab-spreadsheet)

    ``` {.bash .prefixed}
    sudo jupyter labextension install jupyterlab-spreadsheet
    ```

-   [ipympl](https://github.com/matplotlib/ipympl)

    ``` {.bash .prefixed}
    sudo /opt/jupyterhub/bin/pip install ipympl
    ```

-   [jupyter-dash](https://github.com/plotly/jupyter-dash) (å¾…æ›´æ–°ï¼Œç›®å‰ä¸èƒ½ç”¨ 2021.09.18)

    ``` {.bash .prefixed}
    sudo /opt/jupyterhub/bin/pip install jupyter-dash
    ```

-   [jupyterlab-link-share](https://github.com/jupyterlab-contrib/jupyterlab-link-share)

    ``` {.bash .prefixed}
    sudo /opt/jupyterhub/bin/pip install jupyterlab-link-share
    ```

-   [language-packs](https://github.com/jupyterlab/language-packs/tree/master/language-packs/)

    ``` {.bash .prefixed}
    sudo /opt/jupyterhub/bin/pip install jupyterlab-language-pack-zh-TW
    ```

    ``` {.bash .prefixed}
    sudo /opt/jupyterhub/bin/pip install jupyterlab-language-pack-zh-CN
    ```

-   [jupyterlab-lsp](https://github.com/krassowski/jupyterlab-lsp)

    ``` {.bash .prefixed}
    sudo /opt/jupyterhub/bin/pip install 'jupyterlab>=3.0.0,<4.0.0a0' jupyterlab-lsp
    ```

    ``` {.bash .prefixed}
    sudo apt install libcurl4-openssl-dev libxml2-dev --yes
    ```

    ``` {.bash .prefixed}
    sudo su - -c "R -e \"install.packages('languageserver')\"""
    ```

    ``` {.bash .prefixed}
    sudo /opt/jupyterhub/bin/pip install -U jedi-language-server
    ```

-   [nbgitpuller](https://github.com/jupyterhub/nbgitpuller)

    ``` {.bash .prefixed}
    sudo /opt/jupyterhub/bin/pip install nbgitpuller
    ```

``` {.bash .prefixed}
sudo systemctl restart jupyterhub.service
```
