# JupyterLab on JupyterHub

æœ¬ç¯‡æ•™å­¸å®Œå…¨ç…§è‘—[@mangecoeur_elena_vuong_luria_rk_2021]æ‰€å¯«çš„æ•™å­¸æ“ä½œã€‚

## äº‹å‰æº–å‚™

## è¨­ç½® Python 3 ç’°å¢ƒ

``` {.bash .prefixed}
sudo apt update && sudo apt install python3-dev python3-pip --yes
```

``` {.bash .prefixed}
sudo -H python3 -m pip install --upgrade pip
```

``` {.bash .prefixed}
sudo apt install python3-venv
```

å› ç‚º python é€šå¸¸éƒ½æ˜¯æŒ‡ python2ï¼Œæ‰€ä»¥æˆ‘å€‘é‚„è¦å†å¤šè£ä¸€å€‹å«åš `python-is-python3` çš„å¥—ä»¶ï¼Œå°‡ `python` è¨­ç‚º `python3` çš„å¦ä¸€å€‹åå­—ã€‚

``` {.bash .prefixed .sudo .apt .install .python-is-python3}
sudo apt install python-is-python3 --yes
```

## JupyterLab èˆ‡ JupyterHub

### æ–¼è™›æ“¬ç’°å¢ƒä¸­è¨­ç½® JupyterLab èˆ‡ JupyterHub

``` {.bash .prefixed}
sudo python3 -m venv /opt/jupyterhub
```

``` {.bash .prefixed}
sudo /opt/jupyterhub/bin/python -m pip install wheel
```

``` {.bash .prefixed}
sudo /opt/jupyterhub/bin/python -m pip install jupyterlab jupyterhub
```

``` {.bash .prefixed}
sudo /opt/jupyterhub/bin/python -m pip install ipywidgets
```

``` {.bash .prefixed}
curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
sudo apt-get install -y nodejs
```

``` {.bash .prefixed}
sudo npm install -g configurable-http-proxy
```

### è¨­å®š JupyterHub

``` {.bash .prefixed}
sudo mkdir -p /opt/jupyterhub/etc/jupyterhub/
```

``` {.bash .prefixed}
cd /opt/jupyterhub/etc/jupyterhub/
```

``` {.bash .prefixed}
sudo /opt/jupyterhub/bin/jupyterhub --generate-config
```

``` {.bash .prefixed}
sudo vim jupyterhub_config.py
```

``` {.python}
c.JupyterHub.bind_url = 'http://:8000/jhub'
c.Spawner.default_url = '/lab'
c.Authenticator.admin_users = {'asis'}
```

### æ–°å¢é–‹æ©Ÿè‡ªå‹•å•Ÿå‹• JupyterHub çš„æœå‹™

``` {.bash .prefixed}
sudo mkdir -p /opt/jupyterhub/etc/systemd
```

``` {.bash .prefixed}
sudo vim /opt/jupyterhub/etc/systemd/jupyterhub.service
```

``` {.bash .prefixed}
sudo ln -s /opt/jupyterhub/etc/systemd/jupyterhub.service /etc/systemd/system/jupyterhub.service
```

``` {.bash .prefixed}
sudo systemctl daemon-reload
```

``` {.bash .prefixed}
sudo systemctl enable jupyterhub.service
```

``` {.bash .prefixed}
sudo systemctl start jupyterhub.service
```

``` {.bash .prefixed}
sudo systemctl status jupyterhub.service
```

## JupyterHub ä¸­çš„é‹ç®—æ ¸å¿ƒ

### Conda çš„ PythonğŸ ç’°å¢ƒ

``` {.bash .prefixed}
cd ~
```

``` {.bash .prefixed}
curl https://repo.anaconda.com/pkgs/misc/gpgkeys/anaconda.asc | gpg --dearmor > conda.gpg
```

``` {.bash .prefixed}
sudo install -o root -g root -m 644 conda.gpg /etc/apt/trusted.gpg.d/
```

``` {.bash .prefixed}
rm conda.gpg
```

``` {.bash .prefixed}
echo "deb [arch=amd64] https://repo.anaconda.com/pkgs/misc/debrepo/conda stable main" | sudo tee /etc/apt/sources.list.d/conda.list
```

``` {.bash .prefixed}
sudo apt update && sudo apt install conda --yes
```

``` {.bash .prefixed}
sudo mkdir /opt/conda/envs
```

``` {.bash .prefixed}
cd /opt/conda/envs/ && sudo vim environment.yml
```

``` {.yaml .yml}
name: python
channels:
  - defaults
dependencies:
  - python=3.9
  - ipykernel
  - pip:
    - ipython-sql
    - PyMySQL
    - matplotlib
    - plotly
    - dash
    - pandas
prefix: /opt/conda/envs/python
```

``` {.bash .prefixed}
sudo /opt/conda/bin/conda create -f environment.yml
```

``` {.bash .prefixed}
sudo /opt/conda/envs/python/bin/python -m ipykernel install --prefix=/opt/jupyterhub/ --name 'python3' --display-name "Python (default)"
```

![](figures/jupyterhub-main-page-kernel-python.png)

### R ç’°å¢ƒ

``` {.bash .prefixed}
sudo su - -c "R -e \"install.packages('IRkernel')\""
```

``` {.bash .prefixed}
sudo su - -c "R -e \"
    IRkernel::installspec(
        name='ir41', 
        displayname='R 4.1',
        user=FALSE,
        prefix='/opt/jupyterhub'
    )
\""
```

    Error in IRkernel::installspec(name = "ir41", displayname = "R 4.1") : 
      jupyter-client has to be installed but â€œjupyter kernelspec --versionâ€ exited with code 127.
    In addition: Warning message:
    In system2("jupyter", c("kernelspec", "--version"), FALSE, FALSE) :
      error in running command
    Execution halted

ä¸»è¦åŸå› æ˜¯å› ç‚ºï¼Œç³»çµ±æ‰¾ä¸åˆ° `jupyter` æŒ‡ä»¤ã€‚å¯ä»¥è‡ªå·±åœ¨çµ‚ç«¯æ©Ÿé‡ç¾ä¸€æ¬¡ï¼š

``` {.bash .prefixed}
jupyter kernelspec --version
```

``` {.console_output}
Command 'jupyter' not found, but can be installed with:

sudo snap install jupyter       # version 1.0.0, or
sudo apt  install jupyter-core  # version 4.6.3-3

See 'snap info jupyter' for additional versions.
```

æ‰¾ä¸åˆ°æŒ‡ä»¤ï¼Œå‡ºç¾äº†æ¨è–¦å®‰è£æ–¹å¼ï¼Œä¸éé€™ä¸æ˜¯æˆ‘å€‘è¦çš„ã€‚

é€™è£¡æœƒç”¨ä¸€å€‹æŠ€å·§è®“ç³»çµ±æ‰¾å¾—åˆ°ä½æ–¼ `/opt/jupyter/bin/jupyter` çš„æŒ‡ä»¤ã€‚ è—‰ç”±è»Ÿé€£çµåˆ°ç³»çµ±çš„ `path` è®Šæ•¸ä¸­è®“ R æ‰¾å¾—åˆ°ã€‚\
é¦–å…ˆå…ˆå°å‡º `PATH` è®Šæ•¸ï¼š

``` {.bash .prefixed}
echo $PATH
```

``` {.console_output}
/home/asis/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin
```

æ”¾ç½®æ–¼å…¶ä¸­ä¸€å€‹ä½ç½®å°±è¡Œï¼Œæ³¨æ„ä¸è¦æ”¾ç½®åœ¨ /home åº•ä¸‹ï¼ŒåŸ·è¡Œ R æ™‚äº‹ä½¿ç”¨ root æ¬Šé™ï¼Œç”¨ root æ¬Šé™åŸ·è¡Œæ™‚ï¼Œä¸¦ä¸æœƒç¿» `/home/asis/` åº•ä¸‹çš„è³‡æ–™å¤¾ã€‚ é€™è£¡æˆ‘å€‘é¸ç”¨ `/usr/local/bin` ä½œç‚ºè»Ÿé€£çµæ”¾ç½® jupyter åŸ·è¡Œæª”ã€‚

``` {.bash .prefixed}
sudo ln -s /opt/jupyterhub/bin/jupyter /usr/local/bin
```

æ¥è‘—ç”¨ `which` æŒ‡ä»¤æŸ¥è©¢æŒ‡ä»¤æ˜¯å¦å­˜åœ¨ï¼š

``` {.bash .prefixed}
which jupyter
```

åˆ—å‡ºäºŒé€²åˆ¶åŸ·è¡Œæª”å­˜åœ¨ä½ç½®ï¼š

``` {.bash .prefixed}
ls -al $(which jupyter)
```

``` {.console_output}
lrwxrwxrwx 1 root root 27 Sep 17 16:23 /usr/local/bin/jupyter -> /opt/jupyterhub/bin/jupyter*
```

å¯ä»¥çœ‹åˆ°æŒ‡ä»¤ `jupyter` ä¹‹æ‰€ä»¥æœƒå­˜åœ¨æ˜¯å› ç‚ºè»Ÿé€£çµè‡³ `/opt/jupyterhub/bin/jupyter` å¾Œï¼Œå› ç‚º `/usr/local/bin` åœ¨è®Šæ•¸ `path` å…§ï¼Œè®“ç³»çµ±æ‰¾å¾—åˆ°ï¼Œæ‰å¯ä»¥ä½¿ç”¨é€™å€‹æŒ‡ä»¤ã€‚

å†åŸ·è¡Œä¸€æ¬¡å‰›é–‹å§‹çš„æŒ‡ä»¤ï¼š

``` {.bash .prefixed}
sudo su - -c "R -e \"
    IRkernel::installspec(
        name='ir41', 
        displayname='R 4.1',
        user=FALSE,
        prefix='/opt/jupyterhub'
    )
\""
```

``` {.bash .prefixed}
jupyter kernelspec list
```

``` {.console_output}
Available kernels:
  ir41       /opt/jupyterhub/share/jupyter/kernels/ir41
  python3    /opt/jupyterhub/share/jupyter/kernels/python3
```

![](figures/jupyterhub-main-page-kernel-R.png)

## è¨­ç½® Apache çš„ Reverse Proxy

``` {.bash .prefixed}
sudo vim /etc/apache2/sites-available/asis.conf
```

``` {.bash}
<VirtualHost *:80>
    [...]

    ###
    # JupyterHub Reverse Proxy
    ###
    # add trailing slash
    RedirectMatch ^/jhub$ /jhub/
    RewriteCond %{HTTP:Connection} Upgrade [NC]
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteRule /jhub/(.*) ws://127.0.0.1:8000/jhub/$1 [P,L]
    RewriteRule /jhub/(.*) http://127.0.0.1:8000/jhub/$1 [P,L]
    
    <Location /jhub/>
        # preserve Host header to avoid cross-origin problems
  # this setting screws up Rstudio, use for JupyterHub only
        ProxyPreserveHost On
        # proxy to JupyterHub, omit location parameter from ProxyPass etc
        ProxyPass http://127.0.0.1:8000/jhub/
        ProxyPassReverse http://127.0.0.1:8000/jhub/
    </Location>
    
</VirtualHost>
```

    http://<è™›æ“¬ä¸»æ©Ÿçš„ipä½å€>/jhub/

## JupyterHub æ“´å……å¥—ä»¶

-   [jupyterlab-drawio](https://github.com/QuantStack/jupyterlab-drawio)

    ``` {.bash .prefixed}
    sudo /opt/jupyterhub/bin/pip install jupyterlab-drawio
    ```

-   [jupyterlab-git](https://github.com/jupyterlab/jupyterlab-git)

    ``` {.bash .prefixed}
    sudo /opt/jupyterhub/bin/pip \
        install --upgrade jupyterlab jupyterlab-git
    ```

-   [jupyterlab-variable-inspector](https://github.com/lckr/jupyterlab-variableInspector)

    ``` {.bash .prefixed}
    sudo /opt/jupyterhub/bin/pip \
        install lckr_jupyterlab_variableinspector
    ```

    ``` {.bash .prefixed}
    sudo su - -c "R -e \"install.packages('repr')\""
    ```

-   [jupyterext-text-shortcuts](https://github.com/techrah/jupyterext-text-shortcuts)

    ``` {.bash .prefixed}
    sudo jupyter labextension install @techrah/text-shortcuts
    ```

-   [jupyterlab-spreadsheet](https://github.com/quigleyj97/jupyterlab-spreadsheet)

    ``` {.bash .prefixed}
    sudo jupyter labextension install jupyterlab-spreadsheet
    ```

-   [ipympl](https://github.com/matplotlib/ipympl)

    ``` {.bash .prefixed}
    sudo /opt/jupyterhub/bin/pip install ipympl
    ```

-   [jupyter-dash](https://github.com/plotly/jupyter-dash) (å¾…æ›´æ–°ï¼Œç›®å‰ä¸èƒ½ç”¨ 2021.09.18)

    ``` {.bash .prefixed}
    sudo /opt/jupyterhub/bin/pip install jupyter-dash
    ```

-   [jupyterlab-link-share](https://github.com/jupyterlab-contrib/jupyterlab-link-share)

    ``` {.bash .prefixed}
    sudo /opt/jupyterhub/bin/pip install jupyterlab-link-share
    ```

-   [language-packs](https://github.com/jupyterlab/language-packs/tree/master/language-packs/)

    ``` {.bash .prefixed}
    sudo /opt/jupyterhub/bin/pip install jupyterlab-language-pack-zh-TW
    ```

    ``` {.bash .prefixed}
    sudo /opt/jupyterhub/bin/pip install jupyterlab-language-pack-zh-CN
    ```

-   [jupyterlab-lsp](https://github.com/krassowski/jupyterlab-lsp)

    ``` {.bash .prefixed}
    sudo /opt/jupyterhub/bin/pip install 'jupyterlab>=3.0.0,<4.0.0a0' jupyterlab-lsp
    ```

    ``` {.bash .prefixed}
    sudo apt install libcurl4-openssl-dev libxml2-dev --yes
    ```

    ``` {.bash .prefixed}
    sudo su - -c "R -e \"install.packages('languageserver')\"""
    ```

    ``` {.bash .prefixed}
    sudo /opt/jupyterhub/bin/pip install -U jedi-language-server
    ```

-   [nbgitpuller](https://github.com/jupyterhub/nbgitpuller)

    ``` {.bash .prefixed}
    sudo /opt/jupyterhub/bin/pip install nbgitpuller
    ```

``` {.bash .prefixed}
sudo systemctl restart jupyterhub.service
```
