# JupyterHub {#jupyterhub}

æœ¬ç¯‡æ•™å­¸å®Œå…¨ç…§è‘—[@mangecoeur_elena_vuong_luria_rk_2021]æ‰€å¯«çš„æ•™å­¸æ“ä½œã€‚æ—¨åœ¨å»ºç«‹ Jupyterhub ç’°å¢ƒã€‚

## äº‹å‰æº–å‚™ {#jupyterhub-preparation}

å…ˆç¢ºèªç›®å‰çš„ä½¿ç”¨è€… `asis` æ“æœ‰ `sudo` çš„æ¬Šé™ã€‚

## è¨­ç½® Python 3 ç’°å¢ƒ {#setup-python-3-environment}

é¦–å…ˆï¼Œä¸€æ¨£åœ°ï¼Œåªè¦å®‰è£å¥—ä»¶éƒ½éœ€è¦å…ˆæ›´æ–°å¥—ä»¶ä¾†æºã€‚é€™è£¡æˆ‘å€‘ç”¨ `&&` é€£æ¥å…©å€‹æŒ‡ä»¤ï¼Œè®“æ›´æ–°èˆ‡å®‰è£ä¾åºåŸ·è¡Œã€‚

``` {.bash .prefixed}
sudo apt update && sudo apt install python3-pip --yes
```

å®‰è£ `python3-venv` ï¼Œå¾ŒçºŒå»ºç«‹ python è™›æ“¬ç’°å¢ƒæ™‚æœƒç”¨åˆ°

``` {.bash .prefixed}
sudo apt install python3-venv --yes
```

ç›®å‰ Ubuntu 22.04 ç³»çµ±å…§å»ºçš„ Python ç‚º Python 3.10ï¼Œæˆ‘å€‘é‚„æ˜¯å¯ä»¥å¤šè£ä¸€å€‹å«åš `python-is-python3` çš„å¥—ä»¶ï¼Œå°‡ `python` è¨­ç‚º `python3` çš„åˆ¥åï¼Œæ‰“æŒ‡ä»¤æ™‚ä¸ç”¨å¤šæ‰“ä¸€å€‹ 3ã€‚

``` {.bash .prefixed}
sudo apt install python-is-python3 --yes
```

## JupyterLab èˆ‡ JupyterHub {#jupyterlab-and-jupyterhub}

### æ¦‚è¿° {#jupyterhub-overview}

### æ–¼è™›æ“¬ç’°å¢ƒä¸­è¨­ç½® JupyterLab èˆ‡ JupyterHub {#setup-jupyterlab-and-jupyterhub-in-virtual-environment}

åˆ©ç”¨ Python çš„ `venv` æ’ä»¶å»ºç«‹ Python è™›æ“¬ç’°å¢ƒ

``` {.bash .prefixed}
sudo python -m venv /opt/jupyterhub
```

wheel æ˜¯ä¸€ç¨® Python å®‰è£å¥—ä»¶çš„æ ¼å¼ï¼Œæ¯”å‚³çµ±çš„å®‰è£æ ¼å¼ï¼›tar.gz å¿«è¨±å¤šï¼Œä»¥åˆ©æ¸›å°‘å®‰è£æ™‚é–“

``` {.bash .prefixed}
sudo /opt/jupyterhub/bin/python -m pip install wheel
```

é€™è£¡å°‡ jupyterhub å®‰è£è‡³ `/opt/jupyterhub` çš„è™›æ“¬ç’°å¢ƒä¸­

``` {.bash .prefixed}
sudo /opt/jupyterhub/bin/python -m pip install jupyterlab jupyterhub
```

å¥—ä»¶ `ipywidget` é©ç”¨æ–¼ jupyterã€jupyterhub ä¸­ï¼Œå‰µå»ºäº’å‹•å¼å·¥å…·ï¼Œè®“ä½¿ç”¨è€…æ›´æ–¹ä¾¿çš„ä»¥ä¸‹æ‹‰å¼é¸å–®ã€æŒ‰éˆ•ç­‰ç­‰èˆ‡ç¨‹å¼ç¢¼äº’å‹•ã€‚

``` {.bash .prefixed}
sudo /opt/jupyterhub/bin/python -m pip install ipywidgets
```

é€™è£¡å®‰è£ `nodejs`ã€‚é¦–å…ˆå°‡ Nodesource GPG é‡‘é‘°å®‰è£è‡³ç³»çµ±ä¸Š

``` {.bash .prefixed}
sudo apt-get update && \
  sudo apt-get install -y ca-certificates curl gnupg && \
  sudo mkdir -p /etc/apt/keyrings && \
  curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
```

æ·»åŠ è»Ÿé«”ä¾†æº

``` {.bash .prefixed}
NODE_MAJOR=20 && \
  echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_$NODE_MAJOR.x nodistro main" | sudo tee /etc/apt/sources.list.d/nodesource.list
```

æ›´æ–°ä¸¦é€é APT å®‰è£ `nodejs`

``` {.bash .prefixed}
sudo apt-get update && \
  sudo apt-get install nodejs -y
```

æœ€å¾Œï¼Œä»¥å…¨åŸŸçš„æ–¹å¼å®‰è£ `configurable-http-proxy`ï¼Œä½¿ jupyter å¯ä»¥é †åˆ©æ‰¾åˆ°ç¨‹å¼

``` {.bash .prefixed}
sudo npm install -g configurable-http-proxy
```

### è¨­å®š JupyterHub {#configure-jupyterhub}

æ–¼ `/opt/jupyterhub/etc/` è³‡æ–™å¤¾å»ºç«‹ jupyterhub è³‡æ–™å¤¾å­˜æ”¾è¨­å®šã€‚

``` {.bash .prefixed}
sudo mkdir -p /opt/jupyterhub/etc/jupyterhub/
```

åˆ‡æ›è‡³è¨­å®š `jupyterhub` è³‡æ–™å¤¾

``` {.bash .prefixed}
cd /opt/jupyterhub/etc/jupyterhub/
```

ç”¢ç”Ÿé è¨­çš„è¨­å®šæª”æ¡ˆ

``` {.bash .prefixed}
sudo /opt/jupyterhub/bin/jupyterhub --generate-config
```

ç”¨ç·¨è¼¯å™¨ç·¨è¼¯å‰›æ‰ç”¢ç”Ÿçš„è¨­å®šæª”æ¡ˆ

``` {.bash .prefixed}
sudo vim jupyterhub_config.py
```

::: code-label
/opt/jupyterhub/etc/jupyterhub/jupyterhub_config.py
:::

``` python
c.JupyterHub.bind_url = 'http://:8000/jhub'
c.Spawner.default_url = '/lab'
c.Authenticator.admin_users = {'asis'}
c.Spawner.cmd = ['jupyter-labhub']
```

### æ–°å¢é–‹æ©Ÿè‡ªå‹•å•Ÿå‹• JupyterHub çš„æœå‹™ {#add-service-to-automatically-start-jupyterhub-on-boot}

åœ¨å‰›æ‰çš„è¨­å®šè³‡æ–™å¤¾è£¡é¢æ–°å¢ `systemd` è³‡æ–™å¤¾

``` {.bash .prefixed}
sudo mkdir -p /opt/jupyterhub/etc/systemd
```

å¯«å…¥ JupyterHub çš„æœå‹™è¨­å®š

``` {.bash .prefixed}
sudo vim /opt/jupyterhub/etc/systemd/jupyterhub.service
```

::: code-label
/opt/jupyterhub/etc/systemd/jupyterhub.service
:::

``` bash
[Unit]
Description=JupyterHub
After=syslog.target network.target

[Service]
User=root
Environment="PATH=/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/opt/jupyterhub/bin"
ExecStart=/opt/jupyterhub/bin/jupyterhub -f /opt/jupyterhub/etc/jupyterhub/jupyterhub_config.py

[Install]
WantedBy=multi-user.target
```

æœ€å¾Œè»Ÿé€£çµè‡³ç³»çµ±æœå‹™è¨­å®šä¸­

``` {.bash .prefixed}
sudo ln -s /opt/jupyterhub/etc/systemd/jupyterhub.service \
    /etc/systemd/system/jupyterhub.service
```

ä½¿ systemd é‡æ–°è®€å–è¨­å®šï¼Œè€Œä¸ç”¨é‡æ–°å•Ÿå‹•æ•´å€‹ç³»çµ±

``` {.bash .prefixed}
sudo systemctl daemon-reload
```

å°‡ JupyterHub æœå‹™è¨­ç‚ºåœ¨ç³»çµ±å•Ÿå‹•æ™‚è‡ªå‹•é‹è¡Œ

``` {.bash .prefixed}
sudo systemctl enable jupyterhub.service
```

æ‰‹å‹•ç«‹å³å•Ÿå‹• Jupyterhub æœå‹™

``` {.bash .prefixed}
sudo systemctl start jupyterhub.service
```

ç”¨ `status` æŒ‡ä»¤æŸ¥è©¢é‹è¡Œç‹€æ…‹æ˜¯å¦æ­£å¸¸

``` {.bash .prefixed}
sudo systemctl status jupyterhub.service
```

``` {.console_output}
â— jupyterhub.service - JupyterHub
     Loaded: loaded (/etc/systemd/system/jupyterhub.service; enabled; vendor preset: enabled)
     Active: active (running) since Sun 2023-08-27 05:23:20 UTC; 2s ago
   Main PID: 109122 (jupyterhub)
      Tasks: 9 (limit: 2218)
     Memory: 78.2M
        CPU: 728ms
     CGroup: /system.slice/jupyterhub.service
             â”œâ”€109122 /opt/jupyterhub/bin/python3 /opt/jupyterhub/bin/jupyterhub -f /opt/jupyterhub/etc/jupyterhub/jupy>
             â””â”€109126 node /bin/configurable-http-proxy --ip "" --port 8000 --api-ip 127.0.0.1 --api-port 8001 --error->
Aug 27 05:23:21 asis0721 jupyterhub[109126]: 05:23:21.532 [ConfigProxy] info: Proxying http://*:8000 to (no default)
Aug 27 05:23:21 asis0721 jupyterhub[109126]: 05:23:21.534 [ConfigProxy] info: Proxy API at http://127.0.0.1:8001/api/ro>
Aug 27 05:23:21 asis0721 jupyterhub[109122]: [I 2023-08-27 05:23:21.794 JupyterHub app:3178] Hub API listening on http:>
Aug 27 05:23:21 asis0721 jupyterhub[109126]: 05:23:21.794 [ConfigProxy] info: 200 GET /api/routes
Aug 27 05:23:21 asis0721 jupyterhub[109126]: 05:23:21.796 [ConfigProxy] info: 200 GET /api/routes
Aug 27 05:23:21 asis0721 jupyterhub[109122]: [I 2023-08-27 05:23:21.798 JupyterHub proxy:477] Adding route for Hub: /jh>
Aug 27 05:23:21 asis0721 jupyterhub[109126]: 05:23:21.801 [ConfigProxy] info: Adding route /jhub -> http://127.0.0.1:80>
Aug 27 05:23:21 asis0721 jupyterhub[109126]: 05:23:21.801 [ConfigProxy] info: Route added /jhub -> http://127.0.0.1:8081
Aug 27 05:23:21 asis0721 jupyterhub[109126]: 05:23:21.802 [ConfigProxy] info: 201 POST /api/routes/jhub
Aug 27 05:23:21 asis0721 jupyterhub[109122]: [I 2023-08-27 05:23:21.803 JupyterHub app:3245] JupyterHub is now running >
lines 1-21/21 (END)
```

## JupyterHub ä¸­çš„é‹ç®—æ ¸å¿ƒ {#kernels-in-jupyterhub}

### Conda çš„ PythonğŸ ç’°å¢ƒ {#conda-python-environment}

åˆ°[å®˜æ–¹ä¸‹è¼‰é é¢](https://www.anaconda.com/download#downloads)è¤‡è£½æœ€æ–°çš„å®‰è£ç¨‹å¼çš„é€£çµ

``` {.bash .prefixed}
cd /tmp && \ 
    wget https://repo.anaconda.com/archive/Anaconda3-2023.07-2-Linux-x86_64.sh
```

å°‡ä¸‹è¼‰ä¸‹ä¾†çš„è…³æœ¬åŠ ä¸ŠåŸ·è¡Œæ¬Šé™

``` {.bash .prefixed}
chmod +x  Anaconda3-2023.07-2-Linux-x86_64.sh
```

ä»¥è¶…ç´šä½¿ç”¨è€…åŸ·è¡Œ

``` {.bash .prefixed}
sudo ./Anaconda3-2023.07-2-Linux-x86_64.sh
```

åŸ·è¡Œå¾Œï¼Œæœƒè¦æ±‚ä½ å…ˆé–±è®€ä½¿ç”¨è€…æˆæ¬Šæ¢æ¬¾

``` {.console_output}

Welcome to Anaconda3 2023.07-2

In order to continue the installation process, please review the license
agreement.
Please, press ENTER to continue
>>>
```

é€™è£¡æŒ‰ Enter

``` {.console_output}
==================================================
End User License Agreement - Anaconda Distribution
==================================================

Copyright 2015-2023, Anaconda, Inc.

All rights reserved under the 3-clause BSD License:

This End User License Agreement (the "Agreement") is a legal agreement between you and Anaconda, Inc. ("Anaconda") and g
overns your use of Anaconda Distribution (which was formerly known as Anaconda Individual Edition).

Subject to the terms of this Agreement, Anaconda hereby grants you a non-exclusive, non-transferable license to:

  * Install and use the Anaconda Distribution (which was formerly known as Anaconda Individual Edition),
  * Modify and create derivative works of sample source code delivered in Anaconda Distribution from Anaconda's reposito
ry, and;
  * Redistribute code files in source (if provided to you by Anaconda as source) and binary forms, with or without modif
ication subject to the requirements set forth below, and;

Anaconda may, at its option, make available patches, workarounds or other updates to Anaconda Distribution. Unless the u
pdates are provided with their separate governing terms, they are deemed part of Anaconda Distribution licensed to you a
s provided in this Agreement.  This Agreement does not entitle you to any support for Anaconda Distribution.

Anaconda reserves all rights not expressly granted to you in this Agreement.

Redistribution and use in source and binary forms, with or without modification, are permitted provided that the followi
ng conditions are met:

  * Redistributions of source code must retain the above copyright notice, this list of conditions and the following dis
--More--
```

é–±è®€å®Œå¾Œéµå…¥ `q` é€€å‡º

``` {.console_output}
Do you accept the license terms? [yes|no]
[no] >>>
```

é€™è£¡è¼¸å…¥ `yes` åŒæ„ä½¿ç”¨è€…æˆæ¬Šåˆç´„

æ¥ä¸‹ä¾† Anaconda å®‰è£ç¨‹å¼æœƒæç¤ºè¦å®‰è£åœ¨é è¨­çš„å®‰è£ç›®éŒ„ `/root/anaconda3`ã€‚é€™è£¡ä¸æ¡ç”¨é è¨­çš„å®‰è£ç›®éŒ„ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯å°‡ `/opt/conda` æŒ‡å®šç‚ºå®‰è£è·¯å¾‘ï¼Œä¸¦ç­‰å¾…å®‰è£ç¨‹å¼å®‰è£

``` {.console_output}
Anaconda3 will now be installed into this location:
/root/anaconda3

  - Press ENTER to confirm the location
  - Press CTRL-C to abort the installation
  - Or specify a different location below

[/root/anaconda3] >>>
```

å®Œæˆå¾Œï¼Œæœƒå•ä½ è¦ä¸è¦ç•¶ä½ åŸ·è¡Œ shell ä¹‹å¾Œï¼Œè‡ªå‹•é—œè¯ `conda` çš„æŒ‡ä»¤è‡³çµ‚ç«¯æ©Ÿï¼Œé€™è£¡å¡«å…¥ `no`ã€‚å› ç‚ºä¸¦ä¸æ˜¯æ¯æ¬¡é–‹çµ‚ç«¯æ©Ÿéƒ½æœƒç”¨åˆ° `conda`

``` {.console_output}
done
installation finished.
Do you wish the installer to initialize Anaconda3
by running conda init? [yes|no]
[no] >>>
```

å»ºç«‹ conda æ”¾ç½®è™›æ“¬ç’°å¢ƒçš„è³‡æ–™å¤¾

``` {.bash .prefixed}
sudo mkdir /opt/conda/envs
```

æ¥ä¸‹ä¾†åˆ‡æ›è‡³ `/opt/conda/envs/` è³‡æ–™å¤¾ï¼Œæ–°å¢çµ¦ jupyterhub çš„ python æ ¸å¿ƒ

``` {.bash .prefixed}
cd /opt/conda/envs/ && sudo vim environment.yml
```

å¡«å…¥ä»¥ä¸‹è¨­å®š

::: code-label
/opt/conda/envs/environment.yml
:::

``` yaml
name: python
channels:
  - defaults
dependencies:
  - python=3.10
  - ipykernel
  - pip:
    - ipython-sql
    - PyMySQL
    - matplotlib
    - plotly
    - pandas
prefix: /opt/conda/envs/python
```

ä»¥å‰›æ‰æ–°å¢çš„è¨­å®šæª”å»ºç«‹ python é‹ç®—æ ¸å¿ƒ

``` {.bash .prefixed}
sudo /opt/conda/bin/conda env create -f environment.yml
```


``` {.bash .prefixed}
sudo /opt/conda/envs/python/bin/python -m \
    ipykernel install \
    --prefix=/opt/jupyterhub/ \
    --name 'python3' \
    --display-name "Python (é è¨­)"
```

å®Œæˆå¾Œï¼Œæ¸¬è©¦ JupyterHub çš„æœå‹™æ˜¯å¦æ­£å¸¸ã€‚JupyterHub é è¨­çš„åŸ è™Ÿæœƒé–‹åœ¨ 8000ï¼Œæ‰€ä»¥å¦‚æœè¦æ¸¬è©¦ JupyterHub æœå‹™ï¼Œéœ€è¦è¨­å®šé˜²ç«ç‰†ä½¿å¤–éƒ¨å¯ä»¥å­˜å–åŸ è™Ÿ 8000 çš„ JupyterHubã€‚

``` {.bash .prefixed}
sudo ufw allow 8000
```

æœ€å¾Œé€éç¶²å€è¨ªå• JupyterHub

    http://<è™›æ“¬æ©Ÿå™¨çš„ ip åœ°å€>:8000

```{r, fig.cap='jupyterhub ç™»å…¥å¾Œçš„é é¢'}
knitr::include_graphics(path = 'figures/jupyterhub-main-page-kernel-python.png')
```

### R ç’°å¢ƒ {#r-environment}

ç”¨ root çš„èº«ä»½ç‚º R å®‰è£å¥—ä»¶ `IRkernel`

``` {.bash .prefixed}
sudo su - -c "R -e \"install.packages('IRkernel')\""
```

``` {.bash .prefixed}
sudo su - -c "R -e \"
    IRkernel::installspec(
        name='ir43',
        displayname='R 4.3',
        user=FALSE,
        prefix='/opt/jupyterhub'
    )
\""
```

``` {.console_output}
Error in IRkernel::installspec(name = "ir41", displayname = "R 4.1") : 
  jupyter-client has to be installed but â€œjupyter kernelspec --versionâ€ exited with code 127.
In addition: Warning message:
In system2("jupyter", c("kernelspec", "--version"), FALSE, FALSE) :
  error in running command
Execution halted
```

ä¸»è¦åŸå› æ˜¯å› ç‚ºï¼Œç³»çµ±æ‰¾ä¸åˆ° `jupyter` æŒ‡ä»¤ã€‚å¯ä»¥è‡ªå·±åœ¨çµ‚ç«¯æ©Ÿé‡ç¾ä¸€æ¬¡ï¼š

``` {.bash .prefixed}
jupyter kernelspec --version
```

``` {.console_output}
Command 'jupyter' not found, but can be installed with:

sudo snap install jupyter       # version 1.0.0, or
sudo apt  install jupyter-core  # version 4.6.3-3

See 'snap info jupyter' for additional versions.
```

æ‰¾ä¸åˆ°æŒ‡ä»¤ï¼Œå‡ºç¾äº†æ¨è–¦å®‰è£æ–¹å¼ï¼Œä¸éé€™ä¸æ˜¯æˆ‘å€‘è¦çš„ã€‚

é€™è£¡æœƒç”¨ä¸€å€‹æŠ€å·§è®“ç³»çµ±æ‰¾å¾—åˆ°ä½æ–¼ `/opt/jupyter/bin/jupyter` çš„æŒ‡ä»¤ã€‚ è—‰ç”±è»Ÿé€£çµåˆ°ç³»çµ±çš„ `path` è®Šæ•¸ä¸­è®“ R æ‰¾å¾—åˆ°ã€‚\
é¦–å…ˆå…ˆå°å‡º `PATH` è®Šæ•¸ï¼š

``` {.bash .prefixed}
echo $PATH
```

``` {.console_output}
/home/asis/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin
```

æ”¾ç½®æ–¼å…¶ä¸­ä¸€å€‹ä½ç½®å°±è¡Œï¼Œæ³¨æ„ä¸è¦æ”¾ç½®åœ¨ /home åº•ä¸‹ï¼ŒåŸ·è¡Œ R æ™‚äº‹ä½¿ç”¨ root æ¬Šé™ï¼Œç”¨ root æ¬Šé™åŸ·è¡Œæ™‚ï¼Œä¸¦ä¸æœƒç¿» `/home/asis/` åº•ä¸‹çš„è³‡æ–™å¤¾ã€‚ é€™è£¡æˆ‘å€‘é¸ç”¨ `/usr/local/bin` ä½œç‚ºè»Ÿé€£çµæ”¾ç½® jupyter åŸ·è¡Œæª”ã€‚

``` {.bash .prefixed}
sudo ln -s /opt/jupyterhub/bin/jupyter /usr/local/bin
```

æ¥è‘—ç”¨ `which` æŒ‡ä»¤æŸ¥è©¢æŒ‡ä»¤æ˜¯å¦å­˜åœ¨ï¼š

``` {.bash .prefixed}
which jupyter
```

åˆ—å‡ºäºŒé€²åˆ¶åŸ·è¡Œæª”å­˜åœ¨ä½ç½®ï¼š

``` {.bash .prefixed}
ls -al $(which jupyter)
```

``` {.console_output}
lrwxrwxrwx 1 root root 27 Sep 17 16:23 /usr/local/bin/jupyter -> /opt/jupyterhub/bin/jupyter
```

å¯ä»¥çœ‹åˆ°æŒ‡ä»¤ `jupyter` ä¹‹æ‰€ä»¥æœƒå­˜åœ¨æ˜¯å› ç‚ºè»Ÿé€£çµè‡³ `/opt/jupyterhub/bin/jupyter` å¾Œï¼Œå› ç‚º `/usr/local/bin` åœ¨è®Šæ•¸ `path` å…§ï¼Œè®“ç³»çµ±æ‰¾å¾—åˆ°ï¼Œæ‰å¯ä»¥ä½¿ç”¨é€™å€‹æŒ‡ä»¤ã€‚

å†åŸ·è¡Œä¸€æ¬¡å‰›é–‹å§‹çš„æŒ‡ä»¤ï¼š

``` {.bash .prefixed}
sudo su - -c "R -e \"
    IRkernel::installspec(
        name='ir41', 
        displayname='R 4.1',
        user=FALSE,
        prefix='/opt/jupyterhub'
    )
\""
```

åˆ—å‡ºç›®å‰çš„æ ¸å¿ƒï¼Œç¢ºå®šæ˜¯å¦æ­£å¸¸å®‰è£

``` {.bash .prefixed}
jupyter kernelspec list
```

``` {.console_output}
Available kernels:
  ir43       /opt/jupyterhub/share/jupyter/kernels/ir43
  python3    /opt/jupyterhub/share/jupyter/kernels/python3
```

```{r, fig.cap='jupyterhub å®‰è£å®Œ R æ ¸å¿ƒèˆ‡é è¨­ Python çš„é é¢'}
knitr::include_graphics(path = 'figures/jupyterhub-main-page-kernel-R.png')
```

### SAS ç’°å¢ƒ {#sas-environment}

åœ¨ conda çš„ `envs` è³‡æ–™å¤¾æ–°å¢ä¸€å€‹ `sas.yml` è¨­å®š

``` {.bash .prefixed}
sudo vim /opt/conda/envs/sas.yml
```

::: {.code-label}
/opt/conda/envs/sas.yml
:::

``` yaml
name: sas
channels:
  - defaults
  - conda-forge
  - anaconda
dependencies:
  - sas_kernel
  - python=3.10
  - pip
  - ipykernel
prefix: /opt/conda/envs/sas
```

è®“ conda ä»¥ `sas.yml` å»ºç«‹è™›æ“¬ç’°å¢ƒ

``` {.bash .prefixed}
sudo /opt/conda/bin/conda env create -f sas.yml
```

åœ¨ sas çš„è™›æ“¬ç’°å¢ƒä¸­å»ºç«‹ sas çš„è³‡æ–™å¤¾

``` {.bash .prefixed}
sudo mkdir /opt/conda/envs/sas/share/jupyter/kernels/sas
```

ç·¨è¼¯ kernel çš„ json è¨­å®šæª”æ¡ˆï¼Œå°‡ä¸‹åˆ— json å­˜å…¥æª”æ¡ˆ

``` {.bash .prefixed}
sudo vim /opt/conda/envs/sas/share/jupyter/kernels/sas/kernel.json
```

::: code-label
/opt/conda/envs/sas/share/jupyter/kernels/sas/kernel.json
:::

``` json
{
    "argv": [
        "/opt/conda/envs/sas/bin/python",
        "-m",
        "sas_kernel",
        "-f",
        "{connection_file}"
    ],
    "display_name": "SAS",
    "codemirror_mode": "sas",
    "language": "sas",
    "name": "sas"
}
```

æŠŠ sas æ ¸å¿ƒ Logo è¤‡è£½éå»

``` {.bash .prefixed}
sudo cp \
    /opt/conda/envs/sas/lib/python3.10/site-packages/sas_kernel/data/logo-64x64.png \
    /opt/conda/envs/sas/share/jupyter/kernels/sas
```

æœ€å¾Œç”¨ jupyter æŒ‡ä»¤å®‰è£æ ¸å¿ƒ

``` {.bash .prefixed}
sudo jupyter kernelspec install \
    /opt/conda/envs/sas/share/jupyter/kernels/sas --sys-prefix
```

## è¨­ç½® Apache çš„åå‘ä»£ç† {#configure-apache-reverse-proxy}

æ›´æ–°æˆ‘å€‘ç¶²ç«™çš„è¨­å®š

``` {.bash .prefixed}
sudo vim /etc/apache2/sites-available/asis.conf
```

::: {.code-label}
/etc/apache2/sites-available/asis.conf
:::

``` {.apache}
<VirtualHost *:80>
    [...]

    ###
    # JupyterHub Reverse Proxy
    ###
    RedirectMatch permanent ^/jhub$ /jhub/
    RewriteCond %{HTTP:Connection} Upgrade [NC]
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteRule /jhub/(.*) ws://127.0.0.1:8000/jhub/$1 [NE,P,L]
    RewriteRule /jhub/(.*) http://127.0.0.1:8000/jhub/$1 [NE,P,L]

    <Location "/jhub/">
      # preserve Host header to avoid cross-origin problems
      ProxyPreserveHost on
      # proxy to JupyterHub
      ProxyPass         http://127.0.0.1:8000/
      ProxyPassReverse  http://127.0.0.1:8000/
    </Location>
    
</VirtualHost>
```

é‡æ–°å•Ÿå‹• Apache ä»¥å¥—ç”¨æ–°çš„è¨­å®š

``` {.prefixed bash}
sudo systemctl restart apache2
```

æœ€å¾Œç”¨ç¶²å€ `http://<è™›æ“¬æ©Ÿå™¨çš„ ip ä½ç½®>/jhub` è¨ªå•é¦–é 

```{r, fig.cap='é€é http://<è™›æ“¬æ©Ÿå™¨çš„ ip ä½ç½®>/jhub è¨ªå•çš„é¦–é '}
knitr::include_graphics(path = './figures/apache2-main-page-proxy-test.png')
```

ç¢ºèªæ²’å•é¡Œå¾Œï¼Œè¨˜å¾—å°‡é˜²ç«ç‰†çš„åŸ è™Ÿ `8000` è¦å‰‡åˆªé™¤

``` {.bash .prefixed}
sudo ufw delete <è¦å‰‡ç·¨è™Ÿ>
```

## å…¶ä»– JupyterHub æ“´å……å¥—ä»¶ {#other-jupyterhub-extensions}

å®‰è£èªè¨€å¥—ä»¶

-   [language-packs](https://github.com/jupyterlab/language-packs/tree/master/language-packs/)

    ç”¨ JupyterHub å…§å»ºçš„ Python å®‰è£èªè¨€æ“´å……å¥—ä»¶

    ``` {.bash .prefixed}
    sudo /opt/jupyterhub/bin/pip install jupyterlab-language-pack-zh-TW
    ```

    é †ä¾¿ç°¡é«”ä¸­æ–‡ä¹Ÿä¸€èµ·è£

    ``` {.bash .prefixed}
    sudo /opt/jupyterhub/bin/pip install jupyterlab-language-pack-zh-CN
    ```

    æœ€å¾Œé‡æ–°å•Ÿå‹• JupyterHub

    ``` {.bash .prefixed}
    sudo systemctl restart jupyterhub
    ```
    
    å›åˆ° JupyterLab å¾Œï¼Œå¯ä»¥ç”±ã€Œsettingsã€â†’ã€ŒLanguageã€åˆ‡æ› JupyterLab é¡¯ç¤ºèªè¨€ã€‚

    ```{r, fig.cap='jupyterhub ç™»å…¥å¾Œçš„é é¢'}
    knitr::include_graphics(path = 'figures/jupyterlab-change-language.png')
    ```

    

å…¶ä»–æ¨è–¦å®‰è£çš„æ’ä»¶

-   [jupyterlab-drawio](https://github.com/QuantStack/jupyterlab-drawio)
-   [jupyterlab-git](https://github.com/jupyterlab/jupyterlab-git)
-   [jupyterlab-variable-inspector](https://github.com/lckr/jupyterlab-variableInspector)
-   [jupyterext-text-shortcuts](https://github.com/techrah/jupyterext-text-shortcuts)
-   [jupyterlab-spreadsheet](https://github.com/quigleyj97/jupyterlab-spreadsheet)
-   [ipympl](https://github.com/matplotlib/ipympl)
-   [jupyter-dash](https://github.com/plotly/jupyter-dash)
-   [jupyterlab-link-share](https://github.com/jupyterlab-contrib/jupyterlab-link-share)
-   [jupyterlab-lsp](https://github.com/krassowski/jupyterlab-lsp)
-   [nbgitpuller](https://github.com/jupyterhub/nbgitpuller)
