# RStudio & RShiny Server

## 事前準備

## R base

``` {.bash .prefixed}
sudo apt update
```

``` {.bash .prefixed}
sudo apt install software-properties-common dirmngr --yes
```

``` {.bash .prefixed}
wget -qO- https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc | sudo tee -a /etc/apt/trusted.gpg.d/cran_ubuntu_key.asc
```

``` {.bash .prefixed}
add-apt-repository "deb https://cloud.r-project.org/bin/linux/ubuntu $(lsb_release -cs)-cran40/"
```

``` {.bash .prefixed}
sudo apt install r-base --yes
```

## RStudio Server

### Step 1 --- 安裝 RStudio Server 伺服器

``` {.bash .prefixed}
sudo apt install gdebi-core
```

``` {.bash .prefixed}
cd /tmp && \
wget https://download2.rstudio.org/server/bionic/amd64/rstudio-server-1.4.1717-amd64.deb
```

``` {.bash .prefixed}
gpg --keyserver keyserver.ubuntu.com --recv-keys 3F32EE77E331692F
```

``` {.bash .prefixed}
sudo apt install dpkg-sig --yes
```

``` {.bash .prefixed}
dpkg-sig --verify rstudio-server-1.4.1717-amd64.deb
```

``` {.console_output}
Processing rstudio-server-1.4.1717-amd64.deb...
GOODSIG _gpgbuilder FE8564CFF1AB93F1728645193F32EE77E331692F 1621900692
```

``` {.bash .prefixed}
sudo gdebi rstudio-server-1.4.1717-amd64.deb
```

``` {.bash .prefixed}
sudo ufw allow 8787
```

``` {.bash .prefixed}
http://<虛擬主機的 ip 地址>:8787
```

### Step 2 --- 設定 Apache 的 Proxy

``` {.bash .prefixed}
sudo a2enmod proxy
sudo a2enmod proxy_http
sudo a2enmod proxy_wstunnel
```

``` {.bash .prefixed}
sudo vim /etc/apache2/sites-available/asis.conf
```

``` {.bash}
<VirtualHost *:80>
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/asis
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

    ###
    # RStudio Proxy
    ###
    <proxy *>
    Allow from localhost
    </proxy>
    RedirectMatch permanent ^/rstudio$ /rstudio/
  
    RewriteEngine on
    RewriteCond %{HTTP:Upgrade} =websocket
    RewriteRule /rstudio/(.*)     ws://localhost:8787/$1  [P,L]
    RewriteCond %{HTTP:Upgrade} !=websocket
    RewriteRule /rstudio/(.*)     http://localhost:8787/$1 [P,L]
    ProxyPass /rstudio/ http://localhost:8787/
    ProxyPassReverse /rstudio/ http://localhost:8787/
    ProxyRequests Off
</VirtualHost>
```

``` {.bash .prefixed}
sudo systemctl restart apache2
```

    http://<虛擬主機的 ip 地址>/rstudio/

![](figures/apache2-rstudio-server-login-page.png)

``` {.bash .prefixed}
sudo ufw status numbered
```

    Status: active

         To                         Action      From
         --                         ------      ----
    [ 1] 60000                      ALLOW IN    Anywhere                  
    [ 2] mosh                       ALLOW IN    Anywhere                  
    [ 3] Apache                     ALLOW IN    Anywhere                  
    [ 4] Apache Secure              ALLOW IN    Anywhere                  
    [ 5] 8787                       ALLOW IN    Anywhere                  
    [ 6] 60000 (v6)                 ALLOW IN    Anywhere (v6)             
    [ 7] mosh (v6)                  ALLOW IN    Anywhere (v6)             
    [ 8] Apache (v6)                ALLOW IN    Anywhere (v6)             
    [ 9] Apache Secure (v6)         ALLOW IN    Anywhere (v6)             
    [10] 8787 (v6)                  ALLOW IN    Anywhere (v6)

``` {.bash .prefixed}
sudo ufw delete 5
```

``` {.bash .prefixed}
sudo ufw delete 9
```

    Status: active

    To                         Action      From
    --                         ------      ----
    60000                      ALLOW       Anywhere                  
    mosh                       ALLOW       Anywhere                  
    Apache                     ALLOW       Anywhere                  
    Apache Secure              ALLOW       Anywhere                  
    60000 (v6)                 ALLOW       Anywhere (v6)             
    mosh (v6)                  ALLOW       Anywhere (v6)             
    Apache (v6)                ALLOW       Anywhere (v6)             
    Apache Secure (v6)         ALLOW       Anywhere (v6)

## RShiny Server

### Step 1 --- 安裝 RShiny Server

``` {.bash .prefixed}
sudo su - \
-c "R -e \"install.packages('shiny', repos='https://cran.rstudio.com/')\""
```

``` {.bash .prefixed}
cd /tmp && \
wget https://download3.rstudio.org/ubuntu-14.04/x86_64/shiny-server-1.5.16.958-amd64.deb
```

``` {.bash .prefixed}
sha256sum shiny-server-1.5.16.958-amd64.deb 
```

``` {.bash .prefixed}
sudo gdebi shiny-server-1.5.16.958-amd64.deb
```

::: {.infobox .info}
版本
:::

![](figures/apache2-shiny-server-main-page.png)

::: {.infobox .info}
右下角 blablabla 沒裝 rmarkdown package
:::

### Step 2 --- 設定 Apache 的 Proxy

``` {.bash .prefixed}
sudo vim /etc/apache2/sites-available/asis.conf
```

``` {.bash}
<VirtualHost *:80>
    [...]

    ###
    # RStudio Proxy
    ###
    [...]
    
    ###
    # RShiny Server Proxy
    ###
    RedirectMatch permanent ^/shiny$ /shiny/
    
    RewriteCond %{HTTP:Upgrade} =websocket
    RewriteRule /shiny/(.*) ws://localhost:3838/$1 [P,L]
    RewriteCond %{HTTP:Upgrade} !=websocket
    RewriteRule /shiny/(.*) http://localhost:3838/$1 [P,L]
    ProxyPass /shiny/ http://localhost:3838/
    ProxyPassReverse /shiny/ http://localhost:3838/
</VirtualHost>
```

    http://<虛擬主機的 ip 地址>/shiny/

### Step 3 --- Shiny Server 進階設定

``` {.bash .prefixed}
sudo vim /etc/shiny-server/shiny-server.conf
```

    run_as :HOME_USER: shiny; # 以個別使用者執行 shinyapp
                              # shiny 為 fallback 使用者

    # Define a server that listens on port 3838
    server {
      listen 3838;

      # http://localhost/depts/
      location /depts { 

        # http://localhost/depts/asis/
        location /asis { 
          user_dirs;
          
          # 只允許使用者群組為 'asis' 的使用者連結 App
          members_of asis;
          directory_index on;
        }

        # http://localhost/depts/asis/
        location /fin {
          user_dirs;
          
          # 只允許使用者群組為 'fin' 的使用者連結 App
          members_of fin;
          directory_index on;
        }

      } 

      # Define a location at the base URL
      location /apps { # 將 shiny 位置 http://localhost/shiny/
                       # 變更為 http://localhost/shiny/apps/

        [...]

      }
      
    }

``` {.bash .prefixed}
sudo systemctl restart shiny-server
```

### Step 4 --- 使用使用者測試設定是否有效

``` {.bash .prefixed}
sudo groupadd asis
```

``` {.bash .prefixed}
sudo groupadd fin
```

``` {.bash .prefixed}
sudo vim /etc/default/useradd
```

``` {.bash}
# Default values for useradd(8)
#
# The SHELL variable specifies the default login shell on your
# system.
# Similar to DSHELL in adduser. However, we use "sh" here because
# useradd is a low level utility and should be as general
# as possible
SHELL=/usr/bin/bash # 變更這裡
```

``` {.bash .prefixed}
sudo mkdir /etc/skel/ShinyApps/
```

``` {.bash .prefixed}
sudo ln -s /srv/shiny-server/sample-apps \
/etc/skel/ShinyApps/example
```

``` {.bash .prefixed}
sudo useradd --badnames -N -g asis -m 08170875
```

-   `--badnames`:

-   `-N, --no-user-group`:

-   `-g, --gid GROUP`:

-   `-m, --create-home`:

``` {.bash prefixed}
sudo useradd --badnames -N -g fin -m 08220000
```

![](figures/shiny-server-group-test-successed.png)

![](figures/shiny-server-group-test-failed.png)
