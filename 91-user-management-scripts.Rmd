# ä½¿ç”¨è€…ç®¡ç†è…³æœ¬ {#user-management-scripts}

å¸³è™Ÿç®¡ç†åˆ†ç‚ºå…©å€‹éƒ¨åˆ†ï¼Œä¸€å€‹éƒ¨åˆ†æ˜¯ç³»çµ±çš„å¸³è™Ÿç®¡ç†ï¼Œå¦ä¸€å€‹éƒ¨åˆ†æ˜¯ MySQL è³‡æ–™åº«çš„å¸³è™Ÿç®¡ç†ã€‚

## ç³»çµ±å¸³è™Ÿ {#system-user-management}

é€™å€‹å°ç¯€æœƒèªªæ˜ç”¨ä¾†ç®¡ç†å¸³è™Ÿçš„è…³æœ¬çš„é‹ä½œæµç¨‹çš„æ´»å‹•åœ–ã€è…³æœ¬é‹è¡Œï¼Œæ¥è‘—æ‰æ˜¯æŒ‡ä»¤èªªæ˜ã€‚å¦‚æœè¦ç›´æ¥åŸ·è¡Œè…³æœ¬è«‹åˆ° [è…³æœ¬é‹è¡Œ](#è…³æœ¬é‹è¡Œ) çš„éƒ¨åˆ†ã€‚

### æ¦‚è¿° {#overview}

æœ¬è…³æœ¬ï¼ˆBash Scriptï¼‰çš„æ´»å‹•åœ–ï¼Œå¦‚åœ– \@ref(fig:manage-users-sh) æ‰€ç¤ºã€‚ä¸€é–‹å§‹æœƒæ ¹æ“šä½¿ç”¨è€…è¨­å®šçš„é¸é …çš„è¨­å®šç’°å¢ƒï¼Œæ¥è‘—æ‰æœƒé€²åˆ°ä¸»è¦æ–¹æ³•çš„éƒ¨åˆ†ã€‚ä¸»è¦æ–¹æ³•æœ‰å…©ç¨®ï¼Œåˆ†åˆ¥æ˜¯å»ºç«‹å¸³è™Ÿï¼ˆ`create`ï¼‰èˆ‡åˆªé™¤å¸³è™Ÿï¼ˆ`delete`ï¼‰ï¼Œé€™å…©å€‹æ–¹æ³•éš¨å¾Œæœƒå¦å¤–èªªæ˜ã€‚

```{r manage-users-sh, fig.cap='manage-users.sh', out.width='40%'}
knitr::include_graphics(path = './figures/manage-users.sh.svg')
```

### è…³æœ¬é‹è¡Œ {#script-execution}

é€™å€‹éƒ¨åˆ†æœƒèªªæ˜æ€éº¼åŸ·è¡Œè…³æœ¬ã€‚

é¦–å…ˆå…ˆåˆ‡æ›ä½¿ç”¨è€…ç›®éŒ„åˆ°å®¶ç›®éŒ„åº•ä¸‹çš„ `~/bin`

``` {.bash .prefixed}
cd ~/bin
```

å†ä¾†ç”¨ä½ å–œæ„›çš„ç·¨è¼¯å™¨åœ¨é€™å€‹ç›®éŒ„åº•ä¸‹æ–°å¢ä¸€å€‹å«åš `manage-users.sh` çš„è…³æœ¬ï¼ˆBash Scriptï¼‰

``` {.bash .prefixed}
vim manage-users.sh
```

å°‡è—åœ¨ â–¶ è£¡é¢çš„è…³æœ¬å…§å®¹æ”¾åˆ°è…³æœ¬å…§å¾Œå„²å­˜

```{=html}
<details>
  <summary>
    ç®¡ç†ä½¿ç”¨è€…çš„è…³æœ¬
  </summary>
  <p>
```
::: code-label
\~/bin/manage-users.sh
:::

``` bash
#!/bin/bash
# author: kuaz
# created date: 2022.02.24
# last modified: 2022.07.11
# 
# This script is used to:
# 1. Create user accounts from /depts/dept.txt files (one student ID per line).

# ç’°å¢ƒè®Šæ•¸
depts_dir='depts'       # æ”¾ç½®ç”¨ä¾†å»ºç½® linux å¸³è™Ÿçš„ç³»è³‡æ–™å¤¾
# pass_dir='passwd'       # æ”¾ç½®å»ºç½®å®Œæˆçš„ linux å¸³è™Ÿå¯†ç¢¼çš„è³‡æ–™å¤¾
gp=false                # æ˜¯å¦ç”¢ç”Ÿæ–°å¯†ç¢¼
new=true                # æ˜¯å¦æ˜¯æ–°ç‰ˆçš„ shiny app é€£çµæ–¹å¼ï¼›å¦‚æœè¨­ç‚º trueï¼Œ
                        # å°‡ä¸æœƒä½¿ç”¨ systemetic link çš„æ–¹å¼é€£çµ
dryrun=false            # è©¦é‹è¡Œï¼›å¦‚æœè¨­ç‚º trueï¼Œå°‡ä¸æœƒå‰µç«‹å¸³è™Ÿ
                        # useradd æ˜¯å¦æ”¯æ´ badname
badname_supported=$(useradd 2>&1 | grep -q "badname"; echo $?)    

check_permission() {
    if [ ${dryrun} == true ]; then
        :
    else
        if [ $(id -u) -ne 0 ]; then
            echo "å¿…é ˆä»¥ root æ¬Šé™åŸ·è¡Œæ­¤è…³æœ¬ï¼";
            exit 1;
        fi
    fi
}

user_exists() { 
    id "$1" &> /dev/null 
}

check_depts_dir() {
    if [ -d ${depts_dir} ]; then
        grps="$(ls ./${depts_dir} | grep ".txt" | cut -d "." -f 1)"
        for grp in ${grps}
        do
            # https://stackoverflow.com/questions/28038633/wc-l-is-not-counting-last-of-the-file-if-it-does-not-have-end-of-line-character
            count=$(awk 'END{print NR}' ./${depts_dir}/${grp}.txt)
            file=$(realpath ./${depts_dir}/${grp}.txt)
            if [ $count -lt 1 ]; then
                echo "è«‹å†æª¢æŸ¥ä¸€æ¬¡ ${depts_dir} å…§æ˜¯å¦å«æœ‰æ­£ç¢ºæ ¼å¼çš„å­¸è™Ÿæª”æ¡ˆï¼"
                echo "æœ‰å•é¡Œçš„æª”æ¡ˆ: $file"
                exit 1
            else
                echo "æ–¼ $file ç™¼ç¾äº† $count å€‹å­¸ç”Ÿ"
            fi
        done
    else
        echo "ç³»è³‡æ–™å¤¾ ${depts_dir} ä¸å­˜åœ¨ï¼è«‹å…ˆæ‰‹å‹•å‰µå»ºæˆ–æ˜¯ç”±é¸é … -c, --generate-configuration å»ºç«‹ã€‚"
        exit 1;
    fi
}

# create_pass_dir() {
#     if [ ! -d ${pass_dir} ]; then
#         echo "å­˜æ”¾å¯†ç¢¼çš„ ${pass_dir} è³‡æ–™å¤¾ä¸å­˜åœ¨ï¼Œå°‡å»ºç«‹ ${pass_dir} è³‡æ–™å¤¾"
#         mkdir ${pass_dir}
#     else
#         read -p "å­˜æ”¾å¯†ç¢¼çš„ ${pass_dir} è³‡æ–™å¤¾å·²å­˜åœ¨ï¼æ˜¯å¦è¦å°‡å…¶ç§»é™¤å¾Œç¹¼çºŒå»ºç«‹å¸³è™Ÿ? (yes/No)" yn
#         case $yn in
#             [Yy]* ) 
#                 rm -rf ${pass_dir}
#                 make_pass_dir
#             ;;
#             [Nn]* ) exit 1;;
#         esac
#     fi
# }

create_users() {
    # å¦‚æœæœ‰ç”¢ç”Ÿå¯†ç¢¼çš„éœ€æ±‚
    # if [ ${gp} = true ]; then
    #     create_pass_dir
    # fi

    for grp in ${grps}
    do
        # ç¢ºèªä½¿ç”¨è€…ç¾¤çµ„æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å°‡è‡ªå‹•å»ºç«‹
        if $(grep -q "^${grp}:" /etc/group); then
            :
        else
            # éè©¦é‹è¡Œ
            if [ ${dryrun} = false ]; then
                groupadd ${grp}
            fi
            echo "å·²å»ºç«‹ ${grp} ä½¿ç”¨è€…ç¾¤çµ„"
        fi
    done

    for grp in ${grps}
    do 
        # ä½¿ç”¨èˆŠæ–¹æ³•é€£çµ ShinyApps
        if [ ${new} = false ] && [ ! -d /srv/shiny-server/${grp} ]; then
            echo "/srv/shiny-server/${grp} è³‡æ–™å¤¾ä¸å­˜åœ¨ï¼Œå°‡å»ºç«‹ç¾¤çµ„è³‡æ–™å¤¾"
            # éè©¦é‹è¡Œ
            if [ ${dryrun} = false ]; then
                mkdir /srv/shiny-server/${grp}
            fi
        fi

        created=0
        skip=0

        # é€è¡Œè®€å–å­¸è™Ÿ
        while IFS= read -r stu || [ -n "$stu" ];
        do
            cur_user=${stu}

            if user_exists "${cur_user}"; then
                (( skip += 1 ))
            
            elif [ ${dryrun} = false ]; then
                # å¦‚æœä¸æ”¯æ´ badname
                if [ ${badname_supported} == false ]; then
                    useradd -N -g stu -G ${grp} -m ${cur_user}
                else
                    useradd --badnames -N -g stu -G ${grp} -m ${cur_user}
                fi

                # ç”¢ç”Ÿéš¨æ©Ÿå¯†ç¢¼
                # if [ ${gp} = false ]; then
                cur_user_password=${cur_user}
                # else
                #     cur_user_password=$(openssl rand -base64 6)
                # fi
                
                # ä»¥ root æ¬Šé™å‰µç«‹ä½¿ç”¨è€…å¸³è™Ÿï¼Œä¸¦è¨­å®šå¯†ç¢¼
                echo "${cur_user}:${cur_user_password}" | chpasswd

                # å°‡è¨­å®šçš„å¸³è™Ÿå¯†ç¢¼å„²å­˜ä¸€ä»½åˆ°è³‡æ–™å¤¾ä¸­
                # echo "${cur_user},${cur_user_password}"| tee -a ./${pass_dir}/${grp}.csv > /dev/null 2>&1

                # å°‡ ShinyApp è»Ÿé€£çµè‡³ä½¿ç”¨è€…è³‡æ–™å¤¾
                if [ ${new} = false ]; then
                    # éœ€è¦å…ˆåœ¨ /etc/skel/ å»ºç«‹ ShinyApps è³‡æ–™å¤¾ï¼Œæ‰å¯æˆåŠŸé€£çµ
                    ln -s /home/${cur_user}/ShinyApps /srv/shiny-server/${grp}/${cur_user}
                fi

                (( created += 1 ))
            else
                # å¦‚æœç‚ºè©¦é‹è¡Œæ¨¡å¼
                (( created += 1 ))
            fi

        done < ./${depts_dir}/${grp}.txt

        echo "æˆåŠŸå¾ç¾¤çµ„ ${grp} å»ºç«‹äº† ${created} å€‹å¸³è™Ÿï¼Œå¿½ç•¥äº† ${skip} å€‹å·²å­˜åœ¨å¸³è™Ÿã€‚"
    done
}

delete_users() {
    for grp in ${grps}
    do 
        skip=0
        deleted=0
        while IFS= read -r stu || [ -n "$stu" ];
        do
            cur_user=${stu}
            if user_exists "${cur_user}"; then
                userdel -r ${cur_user} > /dev/null 2>&1
                if [ ${new} = false ]; then
                    rm -rf /srv/shiny-server/${grp}/${stu}
                fi
                (( deleted += 1 ))
            else
                (( skip += 1 ))
            fi
        done < ./${depts_dir}/${grp}.txt
        echo "æˆåŠŸå¾ç¾¤çµ„ ${grp} ç§»é™¤äº† ${deleted} å€‹å¸³è™Ÿï¼Œå…¶ä¸­å…±æœ‰ ${skip} å€‹å¸³è™Ÿä¸å­˜åœ¨ã€‚"
    done
    # read -p "ä½¿ç”¨è€…å·²ç§»é™¤ï¼Œæ˜¯å¦è¦é †ä¾¿ç§»é™¤å­˜æ”¾å¯†ç¢¼çš„è³‡æ–™å¤¾ ${pass_dir}? (yes/No)" yn

    # case $yn in
    #     [Yy]* ) 
    #         rm -rf ${pass_dir}
    #     ;;
    #     [No]* ) exit 0;;
    # esac
}

create_prompt() {
    read -p "å³å°‡å»ºç«‹ä½¿ç”¨è€…å¸³æˆ¶ï¼Œç¢ºèªä½¿ç”¨è€…è³‡æ–™æ˜¯å¦ç„¡èª¤?ï¼ˆYes/Noï¼‰" yn
    echo 

    case $yn in
        [Yy]* ) create_users;;
        [Nn]* ) exit 0;;
    esac
}

delete_prompt() {
    read -p "å³å°‡ 'åˆªé™¤' ä½¿ç”¨è€…å¸³æˆ¶ï¼Œæ–¼ /home/<ä½¿ç”¨è€…> çš„è³‡æ–™å°‡æœƒæ¶ˆå¤±ï¼Œæ˜¯å¦åŸ·è¡Œ?ï¼ˆYes/Noï¼‰" yn
    case $yn in
        [Yy]* ) delete_users;;
        [Nn]* ) exit 0;;
    esac
}

generate_configuration() {
    if [ -d ${depts_dir} ]; then
        echo "è³‡æ–™å¤¾å·²å­˜åœ¨ï¼è«‹å…ˆåˆªé™¤ ${depts_dir} è³‡æ–™å¤¾"
    else
        mkdir ${depts_dir}
        touch ${depts_dir}/asis.txt
        touch ${depts_dir}/eco.txt
        echo 08170875 > ${depts_dir}/asis.txt
        echo 08220855 > ${depts_dir}/eco.txt
        echo "è¨­å®šæª”æ¡ˆå»ºç«‹å®Œæˆ"
    fi
    exit 0;
}

display_help() {
    cat << EOF
ä½¿ç”¨æ–¹æ³•: $0 [ é¸é …... ] < create | delete >

é¸é …: 
    -h, --help                      ç”¢ç”Ÿæ­¤èªªæ˜æ–‡å­—
    -d, --dry-run                   è©¦é‹è¡Œè…³æœ¬ï¼Œä¸å¯¦éš›åŸ·è¡Œ
    -c, --generate-configuration    ç”¢ç”Ÿç¯„ä¾‹è¨­å®š
    -o, --old-shiny-server          ShinyApps å°‡ä½¿ç”¨è»Ÿé€£çµçš„æ–¹å¼é€£çµï¼ˆä¸æ¨è–¦ï¼‰
EOF
}

while :
do
    case "$1" in
        -h | --help)
            display_help
            exit 0
        ;;
        -d | --dry-run)
            dryrun=true
            shift 1
            break
        ;;
        # -p | --generate-password)
        #     gp=true
        #     shift 1
        #     break
        # ;;
        -c | --generate-configuration)
            generate_configuration
            exit 0
        ;;
        -o | --old-shiny-server)
            new=false
            shift 1
            break
        ;;
        -*)
            echo "éŒ¯èª¤ï¼šæœªçŸ¥çš„é¸é …ï¼š$1"
            display_help
            exit 1
        ;;
        *)
            break
        ;;
    esac
done

case "$1" in
    create)
        check_permission
        check_depts_dir
        create_prompt
    ;;
    delete)
        check_permission
        check_depts_dir
        delete_prompt
    ;;
    *)
        echo "éŒ¯èª¤ï¼Œè«‹åƒè€ƒä¸‹åˆ—æŒ‡ä»¤èªªæ˜ï¼š"
        echo 
        display_help
        exit 1
    ;;
esac
```

```{=html}
  </p>
</details>
```
æ¥è‘—ä½¿ç”¨ `chmod` æŒ‡ä»¤ç‚ºè…³æœ¬åŠ ä¸Šå¯åŸ·è¡Œçš„æ¬Šé™

``` {.bash .prefixed}
chmod +x manage-users.sh
```

ä½¿ç”¨è…³æœ¬åç¨±åŠ ä¸Š `-h` æˆ–æ˜¯ `--help` é¸é …å¯ä»¥é¡¯ç¤ºä½¿ç”¨è…³æœ¬çš„èªªæ˜å“¦ï½

``` {.bash .prefixed}
./manage-users.sh --help
```

``` console_output
ä½¿ç”¨æ–¹æ³•: ./manage-users.sh [é¸é …...] <create | delete>

é¸é …:
    -h, --help                      ç”¢ç”Ÿæ­¤èªªæ˜æ–‡å­—
    -d, --dry-run                   è©¦é‹è¡Œè…³æœ¬ï¼Œä¸å¯¦éš›åŸ·è¡Œ
    -c, --generate-configuration    ç”¢ç”Ÿç¯„ä¾‹è¨­å®š
    -o, --old-shiny-server          ShinyApps å°‡ä½¿ç”¨è»Ÿé€£çµçš„æ–¹å¼é€£çµï¼ˆä¸æ¨è–¦ï¼‰
```

å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨æ­¤è…³æœ¬ï¼Œå¯ä»¥ä½¿ç”¨ `-c` é¸é …ç”¢ç”Ÿç¯„ä¾‹è¨­å®š

``` {.bash .prefixed}
./manage-users.sh -c
```

``` console.output
â”œâ”€â”€ depts
â”‚Â Â  â”œâ”€â”€ asis.txt
â”‚Â Â  â””â”€â”€ eco.txt
â””â”€â”€ manage-users.sh
```

é€™å€‹è…³æœ¬æœƒæ ¹æ“šæ‰€è¨­å®šçš„ç³»è³‡æ–™å¤¾æ–°å¢å¸³è™Ÿï¼Œæ–°å¢çš„ä½¿ç”¨è€…å¸³è™Ÿçš„ä¸»è¦ä½¿ç”¨è€…ç¾¤çµ„æ˜¯ `stu`ï¼Œå‰¯ä½¿ç”¨è€…ç¾¤çµ„ç‚º `.txt` çš„åç¨±ï¼Œé€™ä¸€é»è¦å¤šåŠ æ³¨æ„ã€‚

é è¨­è…³æœ¬ç”¢ç”Ÿçš„è³‡æ–™æœ‰å…©å€‹å¸³è™Ÿï¼Œåˆ†åˆ¥æ˜¯å±¬æ–¼ä½¿ç”¨è€…ç¾¤çµ„ `asis` çš„ `08170875` èˆ‡å±¬æ–¼ä½¿ç”¨è€…ç¾¤çµ„ `eco` çš„ `08220855`ã€‚

æ¥è‘—ä½¿ç”¨ `sudo` æ¬Šé™å»ºç«‹ä½¿ç”¨è€…å¸³è™Ÿ

``` {.bash .prefixed}
sudo ./manage-users.sh create
```

``` console_output
æ–¼ /home/kuaz/Downloads/depts/asis.txt ç™¼ç¾äº† 1 å€‹å­¸ç”Ÿ
æ–¼ /home/kuaz/Downloads/depts/eco.txt ç™¼ç¾äº† 1 å€‹å­¸ç”Ÿ
å³å°‡å»ºç«‹ä½¿ç”¨è€…å¸³æˆ¶ï¼Œç¢ºèªä½¿ç”¨è€…è³‡æ–™æ˜¯å¦ç„¡èª¤?ï¼ˆYes/Noï¼‰
```

é€™æ™‚å€™æœƒé è¦½åœ¨æª”æ¡ˆä¸­ç™¼ç¾çš„ä½¿ç”¨è€…æ•¸ç›®ï¼Œæ­¤æ™‚è¼¸å…¥ Yes/No å¯ä»¥ç¹¼çºŒæˆ–æ˜¯ä¸­æ–·è…³æœ¬ï¼Œé€™è£¡é¸æ“‡ç¹¼çºŒæ‰€ä»¥è¼¸å…¥ `Y` å¾ŒæŒ‰ Enterâ†©ã€‚

å®Œæˆå¾Œä¹Ÿæœƒæç¤ºå»ºç«‹å¸³è™Ÿçš„èªªæ˜

``` console_output
æˆåŠŸå¾ç¾¤çµ„ asis å»ºç«‹äº† 1 å€‹å¸³è™Ÿï¼Œå¿½ç•¥äº† 0 å€‹å·²å­˜åœ¨å¸³è™Ÿã€‚
æˆåŠŸå¾ç¾¤çµ„ eco å»ºç«‹äº† 1 å€‹å¸³è™Ÿï¼Œå¿½ç•¥äº† 0 å€‹å·²å­˜åœ¨å¸³è™Ÿã€‚
```

å®Œæˆå¾Œå¯ä»¥ç”¨æŒ‡ä»¤ `id` ç¢ºèªä½¿ç”¨è€…æœ‰ç„¡æˆåŠŸå»ºç«‹

``` {.bash .prefixed}
id 08170875; id 08220855
```

``` console_output
uid=1026(08170875) gid=1006(stu) groups=1006(stu),1007(asis)
uid=1027(08220855) gid=1006(stu) groups=1006(stu),1005(eco)
```

æ¸¬è©¦å®Œå¾Œå¯ä»¥ç”¨è…³æœ¬é™„å¸¶çš„ `detele` æ–¹æ³•åˆªé™¤å¸³è™Ÿ

``` {.bash .prefixed}
sudo ./manage-users.sh delete
```

èˆ‡å»ºç«‹å¸³è™Ÿç›¸åŒï¼Œåˆªé™¤å¸³è™Ÿä¸€æ¨£æœƒæœ‰æç¤ºï¼Œé€™è£¡ä¹Ÿæ˜¯è¼¸å…¥ `Y` å¾Œç¹¼çºŒåˆªé™¤å¸³è™Ÿçš„æ–¹æ³•

``` console_output
æ–¼ /home/kuaz/Downloads/depts/asis.txt ç™¼ç¾äº† 1 å€‹å­¸ç”Ÿ
æ–¼ /home/kuaz/Downloads/depts/eco.txt ç™¼ç¾äº† 1 å€‹å­¸ç”Ÿ
å³å°‡ 'åˆªé™¤' ä½¿ç”¨è€…å¸³æˆ¶ï¼Œæ–¼ /home/<ä½¿ç”¨è€…> çš„è³‡æ–™å°‡æœƒæ¶ˆå¤±ï¼Œæ˜¯å¦åŸ·è¡Œ?ï¼ˆYes/Noï¼‰
```

``` console_output
æˆåŠŸå¾ç¾¤çµ„ asis ç§»é™¤äº† 1 å€‹å¸³è™Ÿï¼Œå…¶ä¸­å…±æœ‰ 0 å€‹å¸³è™Ÿä¸å­˜åœ¨ã€‚
æˆåŠŸå¾ç¾¤çµ„ eco ç§»é™¤äº† 1 å€‹å¸³è™Ÿï¼Œå…¶ä¸­å…±æœ‰ 0 å€‹å¸³è™Ÿä¸å­˜åœ¨ã€‚
```

å†ç”¨ç›¸åŒçš„æŒ‡ä»¤ç¢ºèªä½¿ç”¨è€…æ˜¯å¦å­˜åœ¨

``` {.bash .prefixed}
id 08170875; id 08220855
```

æç¤ºä½¿ç”¨è€…ä¸å­˜åœ¨

``` console_output
id: â€˜08170875â€™: no such user
id: â€˜08220855â€™: no such user
```

### æŒ‡ä»¤èªªæ˜ {#command-description}

#### è®€å–é¸é …çš„è¿´åœˆ

é¦–å…ˆæ˜¯ç¬¬ä¸€å€‹è¿´åœˆï¼Œç¬¬ä¸€å€‹è¿´åœˆæ˜¯æª¢æŸ¥é¸é …ç”¨çš„ï¼Œé€™è£¡ä½¿ç”¨çš„æ˜¯ Bash Script çš„ Case èªæ³•ï¼ˆé¡ä¼¼ Switch çš„æ¦‚å¿µï¼‰ã€‚

``` bash
while :
do
    case "$1" in
        -h | --help)
            display_help
            exit 0
        ;;
        -d | --dry-run)
            dryrun=true
            shift 1
            break
        ;;
        # -p | --generate-password)
        #     gp=true
        #     shift 1
        #     break
        # ;;
        -c | --generate-configuration)
            generate_configuration
            exit 0
        ;;
        -o | --old-shiny-server)
            new=false
            shift 1
            break
        ;;
        -*)
            echo "éŒ¯èª¤ï¼šæœªçŸ¥çš„é¸é …ï¼š$1"
            display_help
            exit 1
        ;;
        *)
            break
        ;;
    esac
done
```

é¦–å…ˆ `while :` çš„æ„æ€åœ¨ Bash Script è£¡é¢å°±æ˜¯ `while true` çš„æ„æ€ã€‚è€Œ **do-done** æ˜¯æ¥çºŒ while çš„èªå¥ã€‚æ¥è‘—æœƒç¢°åˆ° `$1`ï¼Œ`$1` ä»£è¡¨çš„æ˜¯æŒ‡ä»¤ä»¥ç©ºç™½å€éš”ï¼Œç¬¬ä¸€å€‹ä½ç½®çš„åƒæ•¸åœ¨ Bash Script è£¡é¢å°±æœƒè¢«è¨­ç‚º `$1`ï¼Œä¾‹å¦‚ï¼š

``` {.bash .prefixed}
./manage-users.sh -c
```

æ‰€ä»¥é€™è£¡çš„ `$1` å°±ä»£è¡¨è‘—ç¬¬ä¸€å€‹åƒæ•¸ä½ç½®ï¼Œ`-c`ã€‚æ‰€ä»¥ç•¶è…³æœ¬ç¢°åˆ° `-` é–‹é ­çš„é¸é …æ™‚ï¼Œå°±æœƒè½åˆ° Case çš„ Pattern è£¡é¢å»åŒ¹é…é¸é …ã€‚é‚£ç‚ºä»€éº¼è…³æœ¬ä¸Ÿåˆ° Case è£¡é¢çš„è®Šæ•¸ä¸€ç›´éƒ½æ˜¯ `$1` ä¹Ÿå¯ä»¥è·‘ï¼Ÿæ˜¯å› ç‚ºæ­é…äº† `shift 1` æŒ‡ä»¤ï¼Œç•¶è…³æœ¬ç¢°åˆ° `shift 1`ï¼Œå®ƒæœƒå°‡ `$1` ä¸Ÿæ£„ï¼Œ`$2` éè£œä¸Šä¾†è®Šç‚º `$1`ï¼Œç›´åˆ°é‡åˆ°å…¶ä»–çµ‚æ­¢çš„æ¢ä»¶ï¼Œåƒæ˜¯ `break` æˆ–æ˜¯ `exit`ã€‚

#### è®€å–æ–¹æ³•çš„ Switch Case

ä¸€æ¨£çš„ï¼Œé€™è£¡æœƒç”¨åˆ°ç›¸åŒçš„ Switch Case æ¦‚å¿µï¼Œå‡å¦‚ä¸Šä¸€å€‹è¿´åœˆè¢« `break` çµ‚æ­¢å¾Œï¼Œä¸” `$1` è¢«åŒ…å«åœ¨ Switch Case çš„é¸é …ä¸­å°±æœƒè§¸ç™¼å°æ‡‰çš„æ–¹æ³•ã€‚é€™è£¡æˆ‘é‡å° `create` èˆ‡ `delete` è¨­å®šäº†ä¸åŒçš„æ–¹æ³•ã€‚

``` bash
case "$1" in
    create)
        check_permission
        check_depts_dir
        create_prompt
    ;;
    delete)
        check_permission
        check_depts_dir
        delete_prompt
    ;;
    *)
        echo "éŒ¯èª¤ï¼Œè«‹åƒè€ƒä¸‹åˆ—æŒ‡ä»¤èªªæ˜ï¼š"
        echo 
        display_help
        exit 1
    ;;
esac
```

å»ºç«‹ä½¿ç”¨è€…æœƒä¾åºå‘¼å« 3 å€‹æ–¹æ³•ï¼Œåˆ†åˆ¥æ˜¯ `check_permission`ï¼ˆæª¢æŸ¥æ¬Šé™æ˜¯å¦ç‚º rootï¼‰ã€`check_depts_dir`ï¼ˆæª¢æŸ¥ç³»è³‡æ–™å¤¾æ˜¯å¦ç¬¦åˆè¦ç¯„ï¼‰æœ€å¾Œæ‰æ˜¯ `create_prompt` ï¼ˆå»ºç«‹ä½¿ç”¨è€…æç¤ºï¼‰ã€‚

<!--# TODO: é€™è£¡å¯ä»¥å†å¢åŠ ç¯„ä¾‹ -->

#### å»ºç«‹ä½¿ç”¨è€…

å»ºç«‹ä½¿ç”¨è€…çš„æµç¨‹å¦‚ä¸‹åœ–ï¼Œåœ– \@ref(fig:create-users) æ´»å‹•åœ–æ‰€ç¤ºï¼š

```{r create-users, fig.cap='å»ºç«‹ä½¿ç”¨è€…', out.width='80%'}
knitr::include_graphics(path = './figures/create-users.svg')
```

é€™è£¡ç”¨åˆ°éå¸¸å¤šçš„ if åˆ¤æ–·ç’°å¢ƒï¼Œæ‰€ä»¥æœ¬è…³æœ¬é‚„æœ‰å¾ˆå¤šæ”¹å–„çš„ç©ºé–“ã€‚

##### æª¢æŸ¥æ¬Šé™ï¼ˆ`check_permission`ï¼‰æ–¹æ³•ï¼š

``` {.bash .numberLines}
check_permission() {
    if [ ${dryrun} == true ]; then
        :
    else
        if [ $(id -u) -ne 0 ]; then
            echo "å¿…é ˆä»¥ root æ¬Šé™åŸ·è¡Œæ­¤è…³æœ¬ï¼";
            exit 1;
        fi
    fi
}
```

é€™æ®µç¨‹å¼ç¢¼åšäº†ï¼š

-   ç¬¬ **1** è¡Œï¼Œæ–¹æ³•åç¨±

-   ç¬¬ **2** è¡Œï¼Œæª¢æŸ¥è®Šæ•¸ `dryrun`ï¼ˆè©¦é‹è¡Œï¼‰æ˜¯å¦ç‚º `true`ã€‚å¦‚æœè©¦é‹è¡Œé¸é …æœ‰è¨­å®šæ™‚ï¼Œæœƒç›´æ¥ç•¥éé€™å€‹ **if** èªå¥ã€‚

-   ç¬¬ **3** è¡Œï¼Œ`:` åœ¨è…³æœ¬ä¸­ä»£è¡¨çš„æ˜¯ `true` çš„åˆ¥åï¼Œå› ç‚º if èˆ‡å¥ä¸èƒ½ç‚ºç©ºï¼Œæ‰€ä»¥é€™è£¡æ”¾ä¸€å€‹ `:`ã€‚è©³ç´°èªªæ˜å¯ä»¥åƒè€ƒ[é€™è£¡](https://stackoverflow.com/questions/3224878/what-is-the-purpose-of-the-colon-gnu-bash-builtin/3224910#3224910)

-   ç¬¬ **5** è¡Œï¼Œæª¢æŸ¥ç•¶å‰çš„ä½¿ç”¨è€…ç·¨è™Ÿæ˜¯å¦ç‚º `0`ï¼Œé€™è£¡çš„ `0` æ˜¯ä»£è¡¨ `root`ã€‚

-   ç¬¬ **6** è¡Œï¼Œè¼¸å‡ºè¨Šæ¯

-   ç¬¬ **7** è¡Œï¼ŒçµæŸç¨‹å¼ï¼ŒéŒ¯èª¤ä»£ç¢¼ç‚º `1`

##### æª¢æŸ¥ç³»è³‡æ–™å¤¾æ˜¯å¦ç¬¦åˆè¦ç¯„ï¼ˆ`check_depts_dir`ï¼‰

``` {.bash .numberLines}
check_depts_dir() {
    if [ -d ${depts_dir} ]; then
        grps="$(ls ./${depts_dir} | grep ".txt" | cut -d "." -f 1)"
        for grp in ${grps}
        do
            count=$(awk 'END{print NR}' ./${depts_dir}/${grp}.txt)
            file=$(realpath ./${depts_dir}/${grp}.txt)
            if [ $count -lt 1 ]; then
                echo "è«‹å†æª¢æŸ¥ä¸€æ¬¡ ${depts_dir} å…§æ˜¯å¦å«æœ‰æ­£ç¢ºæ ¼å¼çš„å­¸è™Ÿæª”æ¡ˆï¼"
                echo "æœ‰å•é¡Œçš„æª”æ¡ˆ: $file"
                exit 1
            else
                echo "æ–¼ $file ç™¼ç¾äº† $count å€‹å­¸ç”Ÿ"
            fi
        done
    else
        echo "ç³»è³‡æ–™å¤¾ ${depts_dir} ä¸å­˜åœ¨ï¼è«‹å…ˆæ‰‹å‹•å‰µå»ºæˆ–æ˜¯ç”±é¸é … -c, --generate-configuration å»ºç«‹ã€‚"
        exit 1;
    fi
}
```

é€™æ®µç¨‹å¼ç¢¼åšäº†ï¼š

-   ç¬¬ **1** è¡Œï¼Œæ–¹æ³•åç¨±

-   ç¬¬ **2** è¡Œï¼Œæª¢æŸ¥è³‡æ–™å¤¾ `depts` æ˜¯å¦å­˜åœ¨

-   ç¬¬ **3** è¡Œï¼Œ`ls` æœƒåˆ—å‡ºæ–¼ `depts` è³‡æ–™å¤¾ä¸­æ‰€æœ‰çš„æª”æ¡ˆï¼Œ`|` æœƒå°‡å‰ä¸€å€‹æŒ‡ä»¤çš„çµæœå‚³åˆ°ä¸‹ä¸€å€‹æŒ‡ä»¤è£¡é¢ï¼Œ`grep ".txt"` æœƒæŠ“å‡ºå«æœ‰ .txt çš„æª”æ¡ˆï¼Œæ¥è‘—æœ€å¾Œçš„ `cut -d "." -f 1` æœƒå°‡è³‡æ–™ä»¥ . ä½œç‚ºåˆ†éš”ç¬¦è™Ÿåˆ‡å‰²ï¼Œå–å‡ºç¬¬ä¸€å€‹çµæœã€‚ä¾‹å¦‚è³‡æ–™å¤¾ä¸­æœ‰è‘—ä¸‰å€‹ .txt çš„æª”æ¡ˆï¼Œ`asis.txt`ã€`eco.txt`èˆ‡ `fin.txt`ï¼Œæœ€å¾Œè¼¸å‡ºçš„çµæœç‚ºï¼š`asis`ã€`eco` èˆ‡ `fin`ã€‚

-   ç¬¬ **4-5** è¡Œï¼Œå°‡å‰ä¸€å€‹çµæœæ”¾åˆ° For è¿´åœˆä¸­ã€‚

-   ç¬¬ **6** è¡Œï¼Œ`awk` æ˜¯ä¸€ç¨®æ–‡å­—è™•ç†å·¥å…·ï¼Œé€™è£¡çš„åŠŸç”¨æ˜¯è¨ˆç®—ç³»è³‡æ–™ä¸­çš„æª”æ¡ˆæœ‰å¹¾åˆ—ï¼ˆä¸åŒ…å«ç©ºè¡Œï¼‰ï¼Œä¼°ç®—è¦å»ºç«‹çš„ä½¿ç”¨è€…æ•¸ç›®ã€‚

-   ç¬¬ **7** è¡Œï¼Œ`realpath` æœƒå°‡æª”æ¡ˆå®Œæ•´çš„è·¯é€²å°å‡ºä¾†ï¼Œä¸¦å„²å­˜åœ¨è®Šæ•¸ `file` ä¸­

-   ç¬¬ **8** è¡Œï¼Œ**if** èªå¥ï¼Œå¦‚æœæ•¸é‡å°‘æ–¼ 1

-   ç¬¬ **9-11** è¡Œï¼Œè¼¸å‡ºè¨Šæ¯ä¸¦ä¸­æ­¢

-   ç¬¬ **13** è¡Œï¼Œè¼¸å‡ºè¨Šæ¯

-   ç¬¬ **17-18** è¡Œï¼Œè¼¸å‡ºè¨Šæ¯ä¸¦ä¸­æ­¢

##### å»ºç«‹ä½¿ç”¨è€…æç¤ºï¼ˆ`create_prompt`ï¼‰

``` {.bash .numberLines}
create_prompt() {
    read -p "å³å°‡å»ºç«‹ä½¿ç”¨è€…å¸³æˆ¶ï¼Œç¢ºèªä½¿ç”¨è€…è³‡æ–™æ˜¯å¦ç„¡èª¤?ï¼ˆYes/Noï¼‰" yn
    echo 

    case $yn in
        [Yy]* ) create_users;;
        [Nn]* ) exit 0;;
    esac
}
```

é€™æ®µç¨‹å¼ç¢¼åšäº†ï¼š

-   ç¬¬ **1** è¡Œï¼Œæ–¹æ³•åç¨±

-   ç¬¬ **2** è¡Œï¼Œè®€å–ä½¿ç”¨è€…è¼¸å…¥ï¼Œä¸¦å„²å­˜åˆ°è®Šæ•¸ `yn` ä¸­

-   ç¬¬ **5** è¡Œï¼ŒSwitch Case èªå¥

-   ç¬¬ **6** è¡Œï¼Œç•¶ç¬¬ä¸€å€‹å­—æ¯ç‚º `Y` æˆ–æ˜¯ `y` æœƒè½åˆ°æ­¤èªå¥ï¼Œä¸¦åŸ·è¡Œ `create_users` æ–¹æ³•

-   ç¬¬ **7** è¡Œï¼Œç•¶ç¬¬ä¸€å€‹å­—æ¯ç‚º `N` æˆ–æ˜¯ `n` æœƒè½åˆ°æ­¤èªå¥ï¼Œç›´æ¥é€€å‡ºç¨‹å¼

##### å»ºç«‹ä½¿ç”¨è€…ï¼ˆ`create_users`ï¼‰

``` {.bash .numberLines}
create_users() {
    # å¦‚æœæœ‰ç”¢ç”Ÿå¯†ç¢¼çš„éœ€æ±‚
    # if [ ${gp} = true ]; then
    #     create_pass_dir
    # fi

    for grp in ${grps}
    do
        # ç¢ºèªä½¿ç”¨è€…ç¾¤çµ„æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å°‡è‡ªå‹•å»ºç«‹
        if $(grep -q "^${grp}:" /etc/group); then
            :
        else
            # éè©¦é‹è¡Œ
            if [ ${dryrun} = false ]; then
                groupadd ${grp}
            fi
            echo "å·²å»ºç«‹ ${grp} ä½¿ç”¨è€…ç¾¤çµ„"
        fi
    done

    for grp in ${grps}
    do 
        # ä½¿ç”¨èˆŠæ–¹æ³•é€£çµ ShinyApps
        if [ ${new} = false ] && [ ! -d /srv/shiny-server/${grp} ]; then
            echo "/srv/shiny-server/${grp} è³‡æ–™å¤¾ä¸å­˜åœ¨ï¼Œå°‡å»ºç«‹ç¾¤çµ„è³‡æ–™å¤¾"
            # éè©¦é‹è¡Œ
            if [ ${dryrun} = false ]; then
                mkdir /srv/shiny-server/${grp}
            fi
        fi

        created=0
        skip=0

        # é€è¡Œè®€å–å­¸è™Ÿ
        while IFS= read -r stu || [ -n "$stu" ];
        do
            cur_user=${stu}

            if user_exists "${cur_user}"; then
                (( skip += 1 ))
            
            elif [ ${dryrun} = false ]; then
                # å¦‚æœä¸æ”¯æ´ badname
                if [ ${badname_supported} == false ]; then
                    useradd -N -g stu -G ${grp} -m ${cur_user}
                else
                    useradd --badnames -N -g stu -G ${grp} -m ${cur_user}
                fi

                # ç”¢ç”Ÿéš¨æ©Ÿå¯†ç¢¼
                # if [ ${gp} = false ]; then
                cur_user_password=${cur_user}
                # else
                #     cur_user_password=$(openssl rand -base64 6)
                # fi
                
                # ä»¥ root æ¬Šé™å‰µç«‹ä½¿ç”¨è€…å¸³è™Ÿï¼Œä¸¦è¨­å®šå¯†ç¢¼
                echo "${cur_user}:${cur_user_password}" | chpasswd

                # å°‡è¨­å®šçš„å¸³è™Ÿå¯†ç¢¼å„²å­˜ä¸€ä»½åˆ°è³‡æ–™å¤¾ä¸­
                # echo "${cur_user},${cur_user_password}"| tee -a ./${pass_dir}/${grp}.csv > /dev/null 2>&1

                # å°‡ ShinyApp è»Ÿé€£çµè‡³ä½¿ç”¨è€…è³‡æ–™å¤¾
                if [ ${new} = false ]; then
                    # éœ€è¦å…ˆåœ¨ /etc/skel/ å»ºç«‹ ShinyApps è³‡æ–™å¤¾ï¼Œæ‰å¯æˆåŠŸé€£çµ
                    ln -s /home/${cur_user}/ShinyApps /srv/shiny-server/${grp}/${cur_user}
                fi

                (( created += 1 ))
            else
                # å¦‚æœç‚ºè©¦é‹è¡Œæ¨¡å¼
                (( created += 1 ))
            fi

        done < ./${depts_dir}/${grp}.txt

        echo "æˆåŠŸå¾ç¾¤çµ„ ${grp} å»ºç«‹äº† ${created} å€‹å¸³è™Ÿï¼Œå¿½ç•¥äº† ${skip} å€‹å·²å­˜åœ¨å¸³è™Ÿã€‚"
    done
}
```

é€™æ®µç¨‹å¼ç¢¼åšäº†ï¼š

-   ç¬¬ **1** è¡Œï¼Œæ–¹æ³•åç¨±

-   ç¬¬ **7** è¡Œï¼Œæ ¹æ“š `check_depts_dir` ç”¢ç”Ÿçš„è®Šæ•¸ `grps` åš **For** è¿´åœˆ

-   ç¬¬ **10** è¡Œï¼Œæª¢æŸ¥ç•¶å‰ **For** è¿´åœˆç¾¤çµ„ä½¿å¦å­˜åœ¨

-   ç¬¬ **11** è¡Œï¼Œ`:` åœ¨è…³æœ¬ä¸­ä»£è¡¨çš„æ˜¯ `true` çš„åˆ¥åï¼Œå› ç‚º if èˆ‡å¥ä¸èƒ½ç‚ºç©ºï¼Œæ‰€ä»¥é€™è£¡æ”¾ä¸€å€‹ `:`ã€‚è©³ç´°èªªæ˜å¯ä»¥åƒè€ƒ[é€™è£¡](https://stackoverflow.com/questions/3224878/what-is-the-purpose-of-the-colon-gnu-bash-builtin/3224910#3224910)

-   ç¬¬ **14** è¡Œï¼Œæª¢æŸ¥ `dryrun`ï¼ˆè©¦é‹è¡Œï¼‰è®Šæ•¸

-   ç¬¬ **15** è¡Œï¼Œæ–°å¢ä½¿ç”¨è€…ç¾¤çµ„

-   ç¬¬ **21** è¡Œï¼Œæ ¹æ“š `check_depts_dir` ç”¢ç”Ÿçš„è®Šæ•¸ `grps` åš **For** è¿´åœˆ

-   ç¬¬ **24** è¡Œï¼Œæª¢æŸ¥ `new`ï¼ˆæ˜¯å¦ä½¿ç”¨æ–°æ–¹æ³•å‰µå»º ShinyApps è³‡æ–™å¤¾ï¼‰èˆ‡ `/srv/shiny-server/ç¾¤çµ„åç¨±`

-   ç¬¬ **25** è¡Œï¼Œè¼¸å‡ºè¨Šæ¯

-   ç¬¬ **27** è¡Œï¼Œæª¢æŸ¥ `dryrun`ï¼ˆè©¦é‹è¡Œï¼‰è®Šæ•¸

-   ç¬¬ **28** è¡Œï¼Œå»ºç«‹ä½¿ç”¨è€…ç¾¤çµ„

-   ç¬¬ **32-33** è¡Œï¼Œåˆå§‹åŒ–è®Šæ•¸ï¼Œ`created` ç”¨ä¾†è¨ˆç®—æˆåŠŸå»ºç«‹çš„ä½¿ç”¨è€…ï¼Œ`skip` æ˜¯ç”¨ä¾†è¨ˆç®—å·²ç¶“å­˜åœ¨çš„ä½¿ç”¨è€…ã€‚

-   ç¬¬ **36-37ã€76** è¡Œï¼Œé€è¡Œè®€å…¥æŒ‡å®šçš„æª”æ¡ˆï¼Œ`< ./${depts_dir}/${grp}.txt`ï¼Œé€™è£¡æœƒé€è¡Œè®€å…¥ä¿‚æª”æ¡ˆçš„å­¸è™Ÿï¼Œæ¯è¡Œä»£è¡¨ä¸€å€‹è¦å»ºç«‹çš„ä½¿ç”¨è€…ï¼Œä¸¦å„²å­˜åˆ° `stu` è®Šæ•¸ä¸­ã€‚

    ``` bash
    while IFS= read -r stu || [ -n "$stu" ];
    do
        [ çœç•¥... ]
    done < ./${depts_dir}/${grp}.txt
    ```

-   ç¬¬ **38** è¡Œï¼Œè¤‡è£½ä¸€å€‹ `stu` è®Šæ•¸å„²å­˜åˆ° `cur_stu` è®Šæ•¸ä¸­

-   ç¬¬ **40** è¡Œï¼Œç”¨æ–¹æ³• `user_exists` åˆ¤æ–·ä½¿ç”¨è€…æ˜¯å¦å­˜åœ¨ï¼Œéš¨å¾Œçš„æ˜¯æ–¹æ³•æ˜¯è¼¸å…¥è®Šæ•¸

-   ç¬¬ **41** è¡Œï¼Œè®Šæ•¸ `skip` åŠ  1

-   ç¬¬ **43** è¡Œï¼Œæª¢æŸ¥ `dryrun`ï¼ˆè©¦é‹è¡Œï¼‰è®Šæ•¸

-   ç¬¬ **45** è¡Œï¼Œæª¢æŸ¥ `badname_supported` è®Šæ•¸

-   ç¬¬ **46** è¡Œï¼Œä½¿ç”¨ `useradd` æŒ‡ä»¤å»ºç«‹ä½¿ç”¨è€…ï¼Œåƒæ•¸èªªæ˜å¦‚ä¸‹ï¼š

    -   `-N, --no-user-group`ï¼šä¸å»ºç«‹ä½¿ç”¨è€…çš„å€‹äººä½¿ç”¨è€…ç¾¤çµ„ï¼Œé ˆèˆ‡ `-g` åŒæ™‚ä½¿ç”¨

    -   `-g, --gid ç¾¤çµ„`ï¼šæŒ‡å®šä½¿ç”¨è€…çš„ä¸»è¦ç¾¤çµ„

    -   `-G, --groups ç¾¤çµ„1[, ç¾¤çµ„2, ...[,ç¾¤çµ„N]]`ï¼šæŒ‡å®šä½¿ç”¨è€…çš„å‰¯ç¾¤çµ„

    -   `-m, --create-home`ï¼šå»ºç«‹ä½¿ç”¨è€…çš„å®¶ç›®éŒ„

-   ç¬¬ **48** è¡Œï¼Œå¤šäº† `--badnames` é¸é …ï¼Œç‚ºäº†ä½¿ä¸å®‰å…¨å‘½åæ–¹å¼çš„ä½¿ç”¨è€…æˆåŠŸå»ºç«‹ï¼Œä¾‹å¦‚æ•¸å­—é–‹é ­çš„ä½¿ç”¨è€…ã€‚

-   ç¬¬ **53** è¡Œï¼Œè¨­å®š `cur_user_password`ï¼ˆä½¿ç”¨è€…å¯†ç¢¼ï¼‰è®Šæ•¸ç‚º `cur_user`ï¼ˆç›®å‰çš„ä½¿ç”¨è€…ï¼‰è®Šæ•¸

-   ç¬¬ **59** è¡Œï¼Œä½¿ç”¨ `chpasswd` è®Šæ›´ `cur_user`ï¼ˆç›®å‰çš„ä½¿ç”¨è€…ï¼‰çš„ä½¿ç”¨è€…å¯†ç¢¼

-   ç¬¬ **65** è¡Œï¼Œæª¢æŸ¥ `new`ï¼ˆæ˜¯å¦ä½¿ç”¨æ–°æ–¹æ³•å‰µå»º ShinyApps è³‡æ–™å¤¾ï¼‰

-   ç¬¬ **67** è¡Œï¼Œå°‡ ShinyApp è»Ÿé€£çµè‡³ä½¿ç”¨è€…è³‡æ–™å¤¾

-   ç¬¬ **70ã€73** è¡Œï¼Œè®Šæ•¸ `created` åŠ  1

-   ç¬¬ **78** è¡Œï¼Œè¼¸å‡ºè¨Šæ¯

<!-- ## è³‡æ–™åº«ï¼ˆMySQLï¼‰å¸³è™Ÿ -->

<!-- ### æ¦‚è¿° -->

<!-- ``` bash -->
<!-- #!/bin/bash -->
<!-- # author: kuaz -->
<!-- # last modified: 2021.09.13 -->
<!-- #  -->
<!-- # é€™å€‹è…³æœ¬è¢«ç”¨ä¾†: -->
<!-- # 1. æ ¹æ“šå·²çŸ¥çš„å¸³è™Ÿå¯†ç¢¼å»ºç«‹ MySQL å¸³æˆ¶ -->
<!-- # 2. æ ¹æ“šå¸³è™Ÿå»ºç«‹è³‡æ–™åº«ï¼Œç·¨ç¢¼ç‚º 'utf8mb4' -->
<!-- # 3. ä»¥ä¸ŠæŒ‡ä»¤æœƒå„²å­˜åœ¨ç•¶å‰è³‡æ–™å¤¾çš„ create-account.sql è£¡é¢ -->
<!-- # 4. æ ¹æ“šå·²çŸ¥çš„å¸³è™Ÿåˆªé™¤è©² MySQL å¸³æˆ¶èˆ‡è³‡æ–™åº« -->
<!-- # 5. è‹¥åŠ ä¸Š -r, --run å³å¯é †ä¾¿åŸ·è¡Œè©²è…³æœ¬ -->


<!-- # ç’°å¢ƒè®Šæ•¸ -->
<!-- pass_dir='passwd'       # æ”¾ç½®å¯†ç¢¼çš„è³‡æ–™å¤¾ï¼Œç”±å¦ä¸€å€‹è…³æœ¬ ./create-users.sh ç”¢ç”Ÿ -->
<!-- filename='-accounts.sql'  # create/drop-accounts.sql æª”æ¡ˆå‰ç¶´æœƒæ ¹æ“šé¸é …è®ŠåŒ– -->
<!-- run=false           # é è¨­ç”¢ç”Ÿè…³æœ¬å¾Œä¸æœƒåŸ·è¡Œ -->

<!-- check_pass_dir() { -->
<!--   if [ -d ${pass_dir} ]; then -->
<!--         grps="$(ls ${pass_dir} | grep ".csv" | cut -d "." -f 1)" -->
<!--   else -->
<!--         echo "å¯†ç¢¼è³‡æ–™å¤¾ ${pass_dir} ä¸å­˜åœ¨ï¼è«‹å…ˆåŸ·è¡Œéå»ºç«‹å¸³è™Ÿè…³æœ¬ï¼ˆcreate-users.shï¼‰å¾Œï¼Œå†åŸ·è¡Œä¸€æ¬¡æ­¤è…³æœ¬ã€‚" -->
<!--         exit 1; -->
<!--   fi -->
<!-- } -->

<!-- write_to_mysql_db() { -->
<!--   if [ ${run} = true ]; then -->
<!--         echo "è«‹è¼¸å…¥ MySQL å¸³æˆ¶ root çš„å¯†ç¢¼: ğŸ‘‡" -->
<!--         mysql -u root -p < ${filename} -->
<!--         clean_sql_script -->
<!--   else -->
<!--         echo "å·²æ–¼ $(pwd) ç”¢ç”Ÿ ${filename} ğŸ‰" -->
<!--   fi -->
<!-- } -->

<!-- create_users_and_databases() { -->
<!--   echo "set global validate_password.policy=LOW;" | tee -a ${filename} > /dev/null 2>&1; -->
<!--   for grp in ${grps} -->
<!--     do  -->
<!--         while read line; -->
<!--         do -->
<!--             stu="$(echo ${line} | cut -d ',' -f 1)" -->
<!--             pass="$(echo ${line} | cut -d ',' -f 2)" -->
<!--             echo "create user '${stu}'@'localhost' identified by '${pass}';" \ -->
<!--                 | tee -a ${filename} > /dev/null 2>&1 -->
<!--             echo "create database \`${stu}\` character set utf8mb4 collate utf8mb4_unicode_ci;" \ -->
<!--                 | tee -a ${filename} > /dev/null 2>&1 -->
<!--             echo "grant all privileges on \`${stu}\`.* to '${stu}'@'localhost';" \ -->
<!--                 | tee -a ${filename} > /dev/null 2>&1 -->
<!--         done < ${pass_dir}/${grp}.csv -->
<!--   done -->
<!--   echo "flush privileges;" | tee -a ${filename} > /dev/null 2>&1; -->
<!--   write_to_mysql_db -->
<!-- } -->

<!-- drop_users_and_databases() { -->
<!--   for grp in ${grps} -->
<!--     do  -->
<!--         while read line; -->
<!--         do -->
<!--             stu="$(echo ${line} | cut -d ',' -f 1)" -->
<!--             echo "drop user '${stu}'@'localhost';" \ -->
<!--                 | tee -a ${filename} > /dev/null 2>&1 -->
<!--             echo "drop database \`${stu}\`;" \ -->
<!--                 | tee -a ${filename} > /dev/null 2>&1 -->
<!--         done < ${pass_dir}/${grp}.csv -->
<!--   done -->
<!--   write_to_mysql_db -->
<!-- } -->

<!-- display_help() { -->
<!--   echo "é€™å€‹è…³æœ¬è¢«ç”¨ä¾†:" -->
<!--   echo "1. æ ¹æ“šå·²çŸ¥çš„å¸³è™Ÿå¯†ç¢¼å»ºç«‹ MySQL å¸³æˆ¶" -->
<!--   echo "2. æ ¹æ“šå¸³è™Ÿå»ºç«‹è³‡æ–™åº«ï¼Œç·¨ç¢¼ç‚º 'utf8mb4'" -->
<!--   echo "3. ä»¥ä¸ŠæŒ‡ä»¤æœƒå„²å­˜åœ¨ç•¶å‰è³‡æ–™å¤¾çš„ create-account.sql è£¡é¢" -->
<!--   echo "4. æ ¹æ“šå·²çŸ¥çš„å¸³è™Ÿåˆªé™¤è©² MySQL å¸³æˆ¶èˆ‡è³‡æ–™åº«" -->
<!--   echo "5. è‹¥åŠ ä¸Š -r, --run å³å¯é †ä¾¿åŸ·è¡Œè©²è…³æœ¬" -->
<!--   echo -->
<!--   echo "ä½¿ç”¨æ–¹æ³•: $0 [option...] {create|drop}" -->
<!--   echo -->
<!--   echo "options: " -->
<!--   echo "  -r, --run  åŸ·è¡Œè…³æœ¬" -->
<!--   echo "  -h, --help  é¡¯ç¤ºèªªæ˜" -->
<!--   echo "  æ²’æœ‰åŠ ä»»ä½•é¸é …: åƒ…ç”¢ç”Ÿ .sql è…³æœ¬" -->
<!--   echo -->
<!--   exit 0 -->
<!-- } -->

<!-- clean_sql_script() { -->
<!--   read -p "æ˜¯å¦è¦æ¸…é™¤ ${filename}? (Yes/No)" yn -->
<!--   case $yn in -->
<!--         [Yy]* ) rm ${filename} ;; -->
<!--         [Nn]* ) exit 0;; -->
<!--   esac -->
<!--   echo "DONE ğŸ‰" -->
<!-- } -->

<!-- while : -->
<!-- do -->
<!--   case "$1" in -->
<!--         -r | --run) -->
<!--             run=true -->
<!--             shift 1 -->
<!--             ;; -->
<!--         -h | --help) -->
<!--             display_help -->
<!--             exit 0 -->
<!--             ;; -->
<!--         --) -->
<!--             shift -->
<!--             break -->
<!--             ;; -->
<!--         -*) -->
<!--             echo "éŒ¯èª¤: æœªçŸ¥çš„é¸é …: $1" >&2 -->
<!--             display_help -->
<!--             exit 1 -->
<!--             ;; -->
<!--         *) -->
<!--             break -->
<!--             ;; -->
<!--     esac -->
<!-- done -->
<!-- case "$1" in -->
<!--   create) -->
<!--         check_pass_dir -->
<!--         if [ $? -ne 1 ]; then -->
<!--             filename="$1$filename" -->
<!--             create_users_and_databases -->
<!--         fi -->
<!--         ;; -->
<!--     drop) -->
<!--         check_pass_dir -->
<!--         if [ $? -ne 1 ]; then -->
<!--             filename="$1$filename" -->
<!--             drop_users_and_databases -->
<!--         fi -->
<!--         ;; -->
<!--     *) -->
<!--         display_help -->
<!--         exit 0 -->
<!--         ;; -->
<!-- esac -->
<!-- ``` -->