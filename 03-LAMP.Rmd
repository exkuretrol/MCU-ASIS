# (PART) è»Ÿé«”å®‰è£ {-}

# LAMP ç¨‹å¼é›†

LAMP æ˜¯ç”± 4 å€‹å–®å­—é–‹é ­çš„å­—çµ„æˆçš„è©ã€‚ LAMP è®“ä½ å¯ä»¥åœ¨ä¸€å°ç³»çµ±ç‚º **L**inux çš„é›»è…¦ä¸Šï¼Œç”¨ **A**pache æ¶è¨­ç¶²ç«™ä¼ºæœå™¨ï¼Œå…¶ä¸­è³‡æ–™å„²å­˜åœ¨ **M**ySQL è£¡é¢ï¼Œæœ€å¾Œç”¨ **P**HP åŸ·è¡Œå‹•æ…‹çš„ç¶²ç«™ã€‚

é€™ç« æœƒæ•™ä½ æ€éº¼å®‰è£ LAMP ç¨‹å¼é›†ã€‚

## äº‹å‰æº–å‚™

åœ¨å®‰è£è»Ÿé«”ä¹‹å‰ï¼Œä½ éœ€è¦æœ‰ä¸€å€‹å¯ä»¥åŸ·è¡Œ `sudo` æŒ‡ä»¤çš„ä½¿ç”¨è€…ã€‚ å¦‚æœä½ æ˜¯ç…§è‘—å…ˆå‰çš„æ•™å­¸åšçš„è©±ï¼Œé€™å€‹ä½¿ç”¨è€…ç‚ºå®‰è£æ™‚çš„é è¨­ä½¿ç”¨è€… `asis`ã€‚

## Apache

Apache HTTP Serverï¼ˆç°¡ç¨± Apacheï¼‰ï¼Œæ˜¯ä¸€å€‹é–‹æ”¾åŸå§‹ç¢¼çš„ç¨‹å¼ï¼Œè¢«ç”¨ä¾†ç•¶ä½œç¶²é çš„ä¼ºæœå™¨ï¼Œæ˜¯ç›®å‰æµè¡Œçš„ç¶²é ä¼ºæœå™¨ä¹‹ä¸€ã€‚

### æ¦‚è¿°

æœ¬ç« ç¯€æœƒè¬›è¿° Apache ç¶²é ä¼ºæœå™¨çš„å®‰è£èˆ‡é˜²ç«ç‰†çš„å®‰å…¨æ€§è¨­å®šã€‚

### å®‰è£ Apache

é¦–å…ˆå…ˆæ›´æ–°å¥—ä»¶ç®¡ç†ç¨‹å¼ï¼ˆAPTï¼‰çš„ä¾†æºï¼š

``` {.bash .prefixed}
sudo apt update
```

ç¢ºèªæ˜¯å¦æ˜¯æˆ‘å€‘è¦å®‰è£çš„ Apache ç‰ˆæœ¬

``` {.bash .prefixed}
sudo apt info apache2
```

``` {.console_output}
Package: apache2
Version: 2.4.52-1ubuntu4.6
Priority: optional
Section: web
Origin: Ubuntu
Maintainer: Ubuntu Developers <ubuntu-devel-discuss@lists.ubuntu.com>
Original-Maintainer: Debian Apache Maintainers <debian-apache@lists.debian.org>
Bugs: https://bugs.launchpad.net/ubuntu/+filebug
Installed-Size: 546 kB
Provides: httpd, httpd-cgi
Pre-Depends: init-system-helpers (>= 1.54~)
Depends: apache2-bin (= 2.4.52-1ubuntu4.6), apache2-data (= 2.4.52-1ubuntu4.6), apache2-utils (= 2.4.52-1ubuntu4.6), lsb-base, mime-support, perl:any, procps
Recommends: ssl-cert
Suggests: apache2-doc, apache2-suexec-pristine | apache2-suexec-custom, www-browser, ufw
Conflicts: apache2.2-bin, apache2.2-common
Replaces: apache2.2-bin, apache2.2-common
Homepage: https://httpd.apache.org/
Task: lamp-server
Download-Size: 97.8 kB
APT-Sources: http://tw.archive.ubuntu.com/ubuntu jammy-updates/main amd64 Packages
Description: Apache HTTP Server
 The Apache HTTP Server Project's goal is to build a secure, efficient and
 extensible HTTP server as standards-compliant open source software. The
 result has long been the number one web server on the Internet.
 .
 Installing this package results in a full installation, including the
 configuration files, init scripts and support scripts.

N: There are 2 additional records. Please use the '-a' switch to see them.
```

å¯ä»¥å¾å¥—ä»¶çš„æè¿°çœ‹åˆ°ï¼Œç¢ºå¯¦æ˜¯æˆ‘å€‘è¦çš„ Apache HTTP Serverã€‚æ¥è‘—é€²è¡Œå®‰è£ Apache2ã€‚

``` {.bash .prefixed}
sudo apt install apache2
```

``` console_output
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following additional packages will be installed:
  apache2-bin apache2-data apache2-utils libapr1 libaprutil1 libaprutil1-dbd-sqlite3 libaprutil1-ldap
  libjansson4 liblua5.2-0 ssl-cert
Suggested packages:
  apache2-doc apache2-suexec-pristine | apache2-suexec-custom www-browser openssl-blacklist
The following NEW packages will be installed:
  apache2 apache2-bin apache2-data apache2-utils libapr1 libaprutil1 libaprutil1-dbd-sqlite3
  libaprutil1-ldap libjansson4 liblua5.2-0 ssl-cert
0 upgraded, 11 newly installed, 0 to remove and 0 not upgraded.
Need to get 1,865 kB of archives.
After this operation, 8,083 kB of additional disk space will be used.
Do you want to continue? [Y/n] 
```

é€™è£¡ç”¨éµç›¤è¼¸å…¥ y å¾ŒæŒ‰ Enterâ†© é€å‡ºã€‚

::: {.rmdnote .infobox}
ä¹Ÿå¯ä»¥åœ¨å®‰è£æ™‚åŠ ä¸Š `--yes` æˆ–æ˜¯ `-y` ç•¥éç¢ºèªå®‰è£æç¤ºã€‚

``` {.bash .console_output}
sudo apt install apache2 -y
```
:::

### èª¿æ•´é˜²ç«ç‰†è¨­å®š

æœ‰äº›ç¨‹å¼æœƒè‡ªå‹•æŠŠè¨­å®šæª”åŠ å…¥ UFW ä¸­ï¼Œé€™æ¨£å°±å¯ä»¥é€éè¨­å®šæª”å•Ÿç”¨/é—œé–‰è¨­å®šé˜²ç«ç‰†å…è¨±çš„åŸ è™Ÿï¼Œä¸ç”¨å†ç‰¹åˆ¥è¨˜ä¸‹è©²è»Ÿé«”çš„è¨­å®šï¼Œåƒæ˜¯ Apache å°±æ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚

é€éæŒ‡ä»¤é¡¯ç¤ºæœ‰ä»€éº¼å¯ç”¨çš„æ‡‰ç”¨ç¨‹å¼è¨­å®šæª”ã€‚

``` {.bash .prefixed}
sudo ufw app list
```

ä¸‹åˆ—æ˜¯ç›®å‰å¯ç”¨çš„è¨­å®šæª”ï¼š

``` {.console_output}
Available applications:
  Apache
  Apache Full
  Apache Secure
  OpenSSH
```

-   **Apache**ï¼šæœƒåœ¨é˜²ç«ç‰†æ–°å¢ä¸€å€‹å…è¨±å¾ä»»ä½•åœ°æ–¹é€£ç·šè‡³åŸ è™Ÿ `80` çš„è¦å‰‡ã€‚

-   **Apache Full**ï¼šæœƒåœ¨é˜²ç«ç‰†æ–°å¢ä¸€å€‹å…è¨±å¾ä»»ä½•åœ°æ–¹é€£ç·šè‡³åŸ è™Ÿ `80` èˆ‡åŸ è™Ÿ `443` çš„è¦å‰‡ã€‚

-   **Apache Secure**ï¼šåœ¨é˜²ç«ç‰†æ–°å¢ä¸€å€‹å…è¨±å¾ä»»ä½•åœ°æ–¹é€£ç·šè‡³åŸ è™Ÿ `443` çš„è¦å‰‡ã€‚\

ä½¿ç”¨æ–¹å¼å¾ˆç°¡å–®ï¼Œè·Ÿå…è¨±åŸ è™Ÿæ™‚çš„æŒ‡ä»¤ä¸€æ¨£ï¼ŒæŠŠåŸ è™Ÿæ”¹æˆè¨­å®šæª”åç¨±å³å¯ã€‚

``` {.bash .prefixed}
sudo ufw allow "Apache"
```

``` {.console_output}
Rule added
Rule added (v6)
```

ç¢ºèªå‰›æ‰æœ‰æ²’æœ‰æ–°å¢æˆåŠŸï¼š

``` {.bash .prefixed}
sudo ufw status
```

``` {.console_output}
Status: active

To                         Action      From
--                         ------      ----
60000                      ALLOW       Anywhere                  
Apache                     ALLOW       Anywhere                  
60000 (v6)                 ALLOW       Anywhere (v6)             
Apache (v6)                ALLOW       Anywhere (v6) 
```

æ¥è‘—å¯ä»¥é€éç€è¦½å™¨é€£ç·šåˆ°ä¸‹åˆ—ç¶²å€ï¼š

    http://<è™›æ“¬ä¸»æ©Ÿçš„ ip ä½å€>/

å°±æ˜¯å‰ä¸€ç« è¨˜ä¸‹ä¾†çš„ `192.168.56.1`

```{r, fig.cap='Apache å®‰è£å¾Œï¼Œé è¨­çš„é¦–é '}
knitr::include_graphics(path = 'figures/apache-main-page.png')
```

::: {.infobox .rmdnote}
å¿˜è¨˜æ€éº¼æ‰¾ ip å¯ä»¥ç”¨ä¸‹åˆ—çš„æ–¹æ³•æ‰¾åˆ°ï¼š

1.  `ip addr show | grep -B 2 "inet "`

``` {.console_output}
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
--
2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:d3:c8:05 brd ff:ff:ff:ff:ff:ff
    inet 10.0.2.15/24 metric 100 brd 10.0.2.255 scope global dynamic enp0s3
--
3: enp0s8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:59:b3:11 brd ff:ff:ff:ff:ff:ff
    inet 192.168.56.101/24 metric 100 brd 192.168.56.255 scope global dynamic enp0s8
```

ç¶²è·¯ä»‹é¢å¡ `enp0s8` ä¸Šé¢çš„ `inet` å¾Œé¢çš„æ•¸å­—å°±æ˜¯ IPã€‚å¦ä¸€å¼µç¶²å¡ `enp0s3` æ˜¯ NAT ç¶²è·¯çš„ IPã€‚é€™è£¡æˆ‘å€‘æ‡‰è©²ç”¨å‰è€…çš„ IP ä½œç‚ºç¶²å€ã€‚

2.  `hostname -I`

``` {.console_output}
10.0.2.15 192.168.56.1
```

:::

åŒæ¨£åœ°ï¼Œ`192.168.56.1` æ‰æ˜¯æˆ‘å€‘éœ€è¦çš„ IPã€‚

## MySQL

MySQLï¼ˆè®€ä½œ My-S-Q-Lï¼‰å› ç‚ºå…¶æ•ˆèƒ½é«˜ã€æˆæœ¬ä½ã€å¯ä¿¡è³´çš„åŸå› ï¼Œè¢«å»£å¤§ä¼æ¥­æ‰€ä½¿ç”¨ï¼Œç›®å‰ä¹Ÿæ˜¯å—æ­¡è¿çš„é–‹æ”¾åŸå§‹ç¢¼è³‡æ–™åº«ç³»çµ±ä¹‹ä¸€ã€‚

### æ¦‚è¿°

é€™å€‹å°ç¯€æœƒèªªæ˜æ€éº¼å®‰è£ MySQLï¼Œèˆ‡åšç°¡æ˜“çš„å®‰è£å¾Œè¨­å®šã€‚

### å®‰è£ MySQL

``` {.bash .prefixed}
sudo apt info mysql-server
```

``` {.console_output}
Package: mysql-server
Version: 8.0.34-0ubuntu0.22.04.1
Priority: optional
Section: database
Source: mysql-8.0
Origin: Ubuntu
Maintainer: Ubuntu Developers <ubuntu-devel-discuss@lists.ubuntu.com>
Original-Maintainer: Debian MySQL Maintainers <pkg-mysql-maint@lists.alioth.debian.org>
Bugs: https://bugs.launchpad.net/ubuntu/+filebug
Installed-Size: 35.8 kB
Depends: mysql-server-8.0
Homepage: http://dev.mysql.com/
Task: lamp-server
Download-Size: 9,460 B
APT-Sources: http://tw.archive.ubuntu.com/ubuntu jammy-updates/main amd64 Packages
Description: MySQL database server (metapackage depending on the latest version)
 This is an empty package that depends on the current "best" version of
 mysql-server (currently mysql-server-8.0), as determined by the MySQL
 maintainers. Install this package if in doubt about which MySQL
 version you need. That will install the version recommended by the
 package maintainers.
 .
 MySQL is a fast, stable and true multi-user, multi-threaded SQL database
 server. SQL (Structured Query Language) is the most popular database query
 language in the world. The main goals of MySQL are speed, robustness and
 ease of use.

N: There is 1 additional record. Please use the '-a' switch to see it
```

é¦–å…ˆï¼Œé€é Apt å®‰è£ MySQLï¼š

``` {.bash .prefixed}
sudo apt install mysql-server -y
```

### è¨­å®š MySQL

æŒ‡ä»¤ `mysql_secure_installation` æœƒåšä»¥ä¸‹å¹¾ä»¶äº‹ï¼ˆè©³ç´°çš„èªªæ˜å¯ä»¥åœ¨[é€™è£¡](https://dev.mysql.com/doc/refman/8.0/en/mysql-secure-installation.html)æ‰¾åˆ°ï¼‰ï¼š

-   ä½ å¯ä»¥è¨­å®š `root` å¸³è™Ÿçš„å¯†ç¢¼ã€‚

-   ä½ å¯ä»¥ç§»é™¤ `root` å¸³è™Ÿé è¨­å¯ä»¥å¾ä»»ä½•åœ°æ–¹é€£ç·šè‡³æœ¬æ©Ÿçš„è¨­å®šã€‚

-   ä½ å¯ä»¥ç§»é™¤æ²’æœ‰åç¨±çš„åŒ¿åå¸³è™Ÿï¼ˆanonymous-userï¼‰è©³ç´°èªªæ˜å¯ä»¥å¾[é€™è£¡](https://dev.mysql.com/doc/refman/5.6/en/default-privileges.html)æ‰¾åˆ°ã€‚

-   ä½ å¯ä»¥ç§»é™¤é è¨­çš„ `test` è³‡æ–™åº«ï¼ˆé€™å€‹è³‡æ–™åº«ä»»ä½•äººéƒ½å¯ä»¥å­˜å–ï¼Œç”šè‡³æ˜¯åŒ¿åå¸³è™Ÿï¼‰ï¼Œå’Œä»»ä½•ä½¿ç”¨è€…åç¨±æ˜¯ `test_` é–‹é ­çš„ä½¿ç”¨è€…å¸³è™Ÿå¯ä»¥å­˜å–ä»»ä½•è³‡æ–™åº«çš„æ¬Šé™ã€‚

å®‰è£å®Œæˆå¾Œï¼Œæ‰“ä¸‹é¢é€™æ®µæŒ‡ä»¤å•Ÿå‹• MySQL å®‰å…¨å®‰è£ç¨‹åºã€‚

``` {.bash .prefixed}
sudo mysql_secure_installation
```

å»ºè­°é€™è£¡é¸ `No`ã€‚å¦‚æœé€™è£¡é¸äº† `Yes`ï¼Œé‚£ä¹‹å¾Œåªè¦æ˜¯å‰µå»ºä½¿ç”¨è€…éƒ½æœƒè¦æ±‚ä½ ä½¿ç”¨å¯†ç¢¼å¼·åº¦å¾ˆé«˜çš„å¯†ç¢¼ï¼Œå› ç‚ºè¦è¨­å®šè¤‡é›œçš„å¯†ç¢¼ï¼Œæ‰€ä»¥ä¸é©åˆçµ¦å­¸ç”Ÿä½¿ç”¨ã€‚

``` console_output
Securing the MySQL server deployment.

Connecting to MySQL using a blank password.

VALIDATE PASSWORD COMPONENT can be used to test passwords
and improve security. It checks the strength of password
and allows the users to set only those passwords which are
secure enough. Would you like to setup VALIDATE PASSWORD component?

Press y|Y for Yes, any other key for No:
```

é€™å€‹ç‰ˆæœ¬é è¨­æ˜¯ä½¿ç”¨ `auth_socket` æ’ä»¶é©—è­‰ï¼Œå¦‚æœç³»çµ±æª¢æ¸¬åˆ°ä½ çš„ä½¿ç”¨è€…åç¨±èˆ‡ MySQL ä¸­çš„ä½¿ç”¨è€…åç¨±ç›¸åŒï¼Œå‰‡å…è¨±ç™»å…¥ã€‚ä¾‹å¦‚ï¼š`sudo mysql` æœƒä»¥ root çš„ä½¿ç”¨è€…åŸ·è¡ŒæŒ‡ä»¤ï¼Œæ­¤æ™‚ä½¿ç”¨è€…æœƒæ˜¯ rootï¼Œä¸” root åœ¨è³‡æ–™åº«ä¸­æœ‰å¸³è™Ÿï¼Œæœ€çµ‚æœƒå…è¨± root ç™»å…¥è³‡æ–™åº«ã€‚

``` console_output
Skipping password set for root as authentication with auth_socket is used by default.
If you would like to use password authentication instead, this can be done with the "ALTER_USER" command.
See https://dev.mysql.com/doc/refman/8.0/en/alter-user.html#alter-user-password-management for more information.
```

é€™å€‹éšæ®µæ˜¯å•ä½ è¦ä¸è¦åˆªé™¤åŒ¿åå¸³è™Ÿï¼Œè¼¸å…¥ `Yes`

``` console_output
By default, a MySQL installation has an anonymous user,
allowing anyone to log into MySQL without having to have
a user account created for them. This is intended only for
testing, and to make the installation go a bit smoother.
You should remove them before moving into a production
environment.

Remove anonymous users? (Press y|Y for Yes, any other key for No) : y
```

é€™è£æ˜¯å•ä½ è¦ä¸è¦è®“ `root` å¸³è™Ÿå¯ä»¥å¾ä»»ä½•åœ°æ–¹é€£å…¥ï¼Œé€™è£¡ç•¶ç„¶æ˜¯é¸ `No`

``` console_output
Normally, root should only be allowed to connect from
'localhost'. This ensures that someone cannot guess at
the root password from the network.

Disallow root login remotely? (Press y|Y for Yes, any other key for No) :
```

::: {.infobox .rmdnote}
å¦‚æœé¸æ“‡`Yes`ï¼Œæœƒå°‡ä½¿ç”¨è€…å¸³è™Ÿçš„å¯é€£ç·šç¶²åŸŸè¨­ç‚º `ï¼…`ï¼Œä»£è¡¨ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥é€£å…¥çš„æ„æ€
:::

MySQL å®‰è£å¾Œï¼Œæœ‰å…§å»ºä¸€å€‹å«åš `test` çš„è³‡æ–™åº«ï¼Œç”¨æ–¼å­¸ç¿’æ€éº¼ä½¿ç”¨ MySQLã€‚é€™è£¡å¯ä»¥é¸æ“‡å°‡å®ƒç§»é™¤æˆ–æ˜¯ä¿ç•™ã€‚

``` {.console_output}
By default, MySQL comes with a database named 'test' that
anyone can access. This is also intended only for testing,
and should be removed before moving into a production
environment.


Remove test database and access to it? (Press y|Y for Yes, any other key for No) :
```

é€™è£¡æœƒè©¢å•è¦ä¸è¦é‡æ–°è®€å–æ¬Šé™è¡¨ï¼Œé¸ `Y` å³å¯ã€‚

``` {.console_output}
 - Dropping test database...
Success.

 - Removing privileges on test database...
Success.

Reloading the privilege tables will ensure that all changes
made so far will take effect immediately.

Reload privilege tables now? (Press y|Y for Yes, any other key for No) :
```

å®Œæˆï¼

``` {.console_output}
Success.

All done!
```

æœ€å¾Œä½¿ç”¨æŒ‡ä»¤æ¸¬è©¦ MySQL é€£ç·šï¼š

``` {.bash .prefixed}
sudo mysql -u root
```

-   `--user, -u`ï¼šä½¿ç”¨è€…å¸³è™Ÿ

## PHP

PHPï¼ˆHypertext PreProcessorï¼Œè¶…æ–‡å­—é è™•ç†å™¨ï¼‰ï¼Œå…è¨±ç¶²é é–‹ç™¼äººå“¡é–‹ç™¼å‹•æ…‹ç¶²é ï¼Œæˆªè‡³2021å¹´è¢«ä¸–ç•Œä¸Šè‡³å°‘70%ä»¥ä¸Šçš„ç¶²é æ‰€ä½¿ç”¨ã€‚

### å®‰è£ PHP

é™¤äº† `php` å¥—ä»¶ä¹‹å¤–ï¼Œ`libapache2-mod-php` å¥—ä»¶æ˜¯è®“ apache2 èªè­˜ php é€™å€‹æª”æ¡ˆï¼Œè€Œ `php-mysql` æ˜¯è®“ PHP èˆ‡ MySQL æºé€šçš„å¥—ä»¶ã€‚
<!--# TODO: é€£çµè‡³ç¬¬äº”ç«  python èªªæ˜ which -A æŒ‡ä»¤ -->

``` {.bash .prefixed}
sudo apt install php libapache2-mod-php php-mysql
```

### å»ºç«‹è™›æ“¬ç¶²ç«™

è™›æ“¬ç¶²ç«™ï¼ˆVirtual Hostï¼‰å¯ä»¥è®“ä½ åœ¨ä¸€å°é›»è…¦åŒæ™‚æ¶è¨­å¤šå€‹ç¶²ç«™ï¼Œæ“æœ‰ä¸åŒçš„åŸŸåã€‚åœ¨é€™è£¡çš„ç”¨è™•å°±æ˜¯å»ºç«‹ä¸€å€‹æ–°çš„ç¶²ç«™ã€‚

é¦–å…ˆï¼Œæ–¼ apache2 çš„è¨­å®šè³‡æ–™å¤¾ä¸­ï¼Œæ–°å»ºä¸€å€‹å«åš asis.conf çš„è¨­å®šæª”ï¼š

``` {.bash .prefixed}
sudo vim /etc/apache2/sites-available/asis.conf
```

å¯«å…¥æ¸¬è©¦ç”¨çš„è¨­å®š

::: {.code-label}
/etc/apache2/sites-available/asis.conf
:::

``` apache
<VirtualHost *:80>
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/asis
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
```

-   `ServerAdmin`ï¼šç¾åœ¨é€™å€‹è®Šæ•¸å·²ç¶“è¢«æ£„ç”¨äº†ï¼Œåœ¨ Apache å…ˆå‰çš„ç‰ˆæœ¬ç•¶ä¼ºæœå™¨å‡ºéŒ¯æ™‚æœƒé¡¯ç¤ºè¯çµ¡ç®¡ç†å“¡çš„æ–¹å¼ã€‚è€Œç¾éšæ®µç‰ˆæœ¬é‚„æ˜¯æœ‰é»ç”¨çš„ï¼Œä½ å¯ä»¥åœ¨ PHP ä¸­å‘¼å« `$_SERVER['SERVER_ADMIN']` è®Šæ•¸æœƒé¡¯ç¤º `ServerAdmin` æ‰€è¨­å®šçš„ Emailã€‚

-   `DocumentRoot`ï¼šç¶²ç«™çš„æ ¹ç›®éŒ„

-   `ErrorLog`ï¼šéŒ¯èª¤è¨Šæ¯è·¯å¾‘

-   `CustomLog`ï¼šè¨­å®š Log çš„æª”æ¡ˆåç¨±èˆ‡æ ¼å¼ï¼Œè©³ç´°èªªæ˜[åœ¨æ­¤](https://httpd.apache.org/docs/2.4/mod/mod_log_config.html#logformat)

é€é list æŒ‡ä»¤å¯ä»¥çœ‹åˆ°ï¼Œè³‡æ–™å¤¾çš„æ“æœ‰è€…æ˜¯ rootã€‚ æˆ‘å€‘åœ¨å®‰è£ Apache2 çš„éƒ¨åˆ†å¾ `http://<è™›æ“¬ä¸»æ©Ÿçš„ ip åœ°å€>/` çœ‹åˆ°çš„å°±æ˜¯ä½æ–¼ `/var/www/html/` ä¸­çš„é¦–é ï¼Œæ¥ä¸‹ä¾†æˆ‘å€‘è¦åˆªé™¤ Apache2 é è¨­çš„è¨­å®šï¼Œä¸¦æ¸¬è©¦è‡ªå·±å»ºç«‹çš„è™›æ“¬ç¶²ç«™ï¼ˆVirtualHostï¼‰ã€‚

``` {.bash .prefixed}
ls -al /var/www/
```

``` console_output
total 16
drwxr-xr-x  4 root root 4096 Aug 22 02:50 .
drwxr-xr-x 14 root root 4096 Aug 21 05:16 ..
drwxr-xr-x  2 root root 4096 Aug 21 05:16 html
```

ä¸€æ¨£åœ°ï¼Œä»¥åŒæ¨£åœ°æ–¹æ³•å»ºç«‹ `asis` è³‡æ–™å¤¾

``` {.bash .prefixed}
sudo mkdir /var/www/asis
```

ç”¢ç”Ÿä¸€å€‹æ¸¬è©¦ç”¨çš„é¦–é 

``` {.bash .prefixed}
sudo vim /var/www/asis/index.html
```

::: {.code-label}
/var/www/asis/index.html
:::

``` html
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apache VirtualHost config test</title>
</head>
<body>
  <h1>æˆåŠŸ!</h1>
  <p>æ‚¨çš„ Apache2 è™›æ“¬ç¶²ç«™çš„è¨­å®šé †åˆ©é‹ä½œä¸­ã€‚</p>
</body>
</html>
```

ä½¿ç”¨ `a2dissite` æŒ‡ä»¤é—œé–‰é è¨­çš„è¨­å®šæª”ã€‚
<!-- ï¼ˆæœ‰èˆˆè¶£å¯ä»¥çœ‹ä¸€ä¸‹é è¨­çš„è¨­å®šæª” 000-default.confï¼Œæœ‰åŠ©æ–¼äº†è§£è¨­å®šæª”æ¡ˆæ€éº¼ç·¨å¯«ï¼‰-->

``` {.bash .prefixed}
sudo a2dissite 000-default.conf
```

``` console_output
Site 000-default disabled.
To activate the new configuration, you need to run:
  systemctl reload apache2
```

æ¥è‘—ï¼Œå•Ÿç”¨å‰›æ‰å‰µç«‹çš„è¨­å®šæª” `asis.conf`

``` {.bash .prefixed}
sudo a2ensite asis.conf
```

é‡æ–°è®€å–å‰›æ‰è®Šæ›´çš„è¨­å®šï¼Œä½¿æ–°çš„è¨­å®šç”Ÿæ•ˆ

``` {.bash .prefixed}
sudo systemctl reload apache2
```

æ¥è‘—è‡³ç€è¦½å™¨æ‰“ä¸Šè™›æ“¬æ©Ÿå™¨çš„ ip ä½å€

    http://<è™›æ“¬ä¸»æ©Ÿçš„ ip åœ°å€>/

```{r, fig.cap='Apache2 æ¸¬è©¦è™›æ“¬ç¶²ç«™è¨­å®š'}
knitr::include_graphics(path = 'figures/apache2-test-virtualhost-conf.png')
```

æˆ–æ˜¯ç›´æ¥åœ¨çµ‚ç«¯æ©Ÿä¸­ä½¿ç”¨æŒ‡ä»¤ `curl` æ¸¬è©¦ `asis.conf` è¨­å®šæª”ï¼š

``` {.bash .prefixed}
curl http://<è™›æ“¬ä¸»æ©Ÿçš„ ip åœ°å€>/
```

``` .{console_output}
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apache VirtualHost config test</title>
</head>
<body>
  <h1>æˆåŠŸ!</h1>
  <p>æ‚¨çš„ Apache2 è™›æ“¬ç¶²ç«™çš„è¨­å®šé †åˆ©é‹ä½œä¸­ã€‚</p>
</body>
</html>
```

### æ¸¬è©¦ PHP

åœ¨ç¶²ç«™è³‡æ–™å¤¾ä¸­æ–°å¢ä¸€å€‹ `info.php` æª”æ¡ˆ

``` {.bash .prefixed}
sudo vim /var/www/asis/info.php
```

è²¼å…¥ä»¥ä¸‹ç¨‹å¼ç¢¼

::: {.code-label}
/var/www/asis/info.php
:::

``` {.console_output}
<?php
phpinfo();

```

é€²åˆ°ç¶²ç«™ `http://192.168.56.101/info.php`

```{r, fig.cap='Apache2 æ¸¬è©¦ PHP'}
knitr::include_graphics(path = 'figures/apache2-test-php.png')
```

æˆåŠŸé¡¯ç¤ºç›®å‰ PHP çš„æ‰€æœ‰è¨­å®šã€‚æ¸¬è©¦å®Œå¾Œè¨˜å¾—è¦åˆªé™¤ `info.php`ã€‚

``` {.bash .prefixed}
sudo rm /var/www/asis/info.php
```


### ä½¿ç”¨è€…ç›®éŒ„ç¶²ç«™

è¦é–‹å•Ÿ apache2 çš„ä½¿ç”¨è€…ç›®éŒ„åŠŸèƒ½éœ€è¦å…ˆç¢ºèª `userdir` æ¨¡çµ„æœ‰æ²’æœ‰æ‰“é–‹

``` {.bash .prefixed}
apachectl -M | grep userdir
```

å¦‚æœåƒä¸‹åœ–ä¸€æ¨£æ²’æœ‰æ‰¾åˆ° `userdir_module` å°±æ˜¯æ²’æœ‰é–‹å•Ÿä½¿ç”¨è€…ç›®éŒ„çš„åŠŸèƒ½

``` {.console_output}
AH00558: apache2: Could not reliably determine the server's fully qualified domain name, using 127.0.1.1. Set the 'ServerName' directive globally to suppress this message
 authz_user_module (shared)
```

é€éæŒ‡ä»¤å°‡ä½¿ç”¨è€…ç›®éŒ„æ¨¡çµ„å•Ÿå‹•

``` {.bash .prefixed}
sudo a2enmod userdir
```

å•Ÿå‹•å¾Œï¼Œé‚„è¦ç¢ºå®š `userdir` æ¨¡çµ„çš„ `UserDir` æœ‰ç„¡æ­£ç¢ºè¨­å®š

``` {.bash .prefixed}
sudo vim /etc/apache2/mods-available/userdir.conf
```

::: {.code-label}
/etc/apache2/mods-available/userdir.conf
:::

``` {.apache}
<IfModule mod_userdir.c>
        # ç¢ºèª UserDir æ˜¯å¦æœ‰å–æ¶ˆè¨»è§£
        UserDir public_html
        UserDir disabled root

        <Directory /home/*/public_html>
                AllowOverride FileInfo AuthConfig Limit Indexes
                Options MultiViews Indexes SymLinksIfOwnerMatch IncludesNoExec
                Require method GET POST OPTIONS
        </Directory>
</IfModule>
```

è®Šæ›´ç›®éŒ„æ¬Šé™ï¼Œä½¿ apache2 æœ‰æ¬Šé™å¯ä»¥é€²å…¥ä½¿ç”¨è€…å®¶ç›®éŒ„

``` {.bash .prefixed}
sudo chmod 711 /home/<ä½¿ç”¨è€…åç¨±>
sudo chmod 755 /home/<ä½¿ç”¨è€…åç¨±>/public_html
```

å¦‚æœè¦ä½¿ä½¿ç”¨è€…å®¶ç›®éŒ„é‹è¡Œ `.php` é¡å‹çš„æª”æ¡ˆï¼Œé‚„éœ€è¦å°‡ `php_admin_flag engine Off` è¨»è§£

``` {.bash .prefixed}
sudo vim /etc/apache2/mods-available/php8.1.conf
```

::: {.code-label}
/etc/apache2/mods-available/php8.1.conf
:::

``` {.apache}
[...]

# Running PHP scripts in user directories is disabled by default
#
# To re-enable PHP in user directories comment the following lines
# (from <IfModule ...> to </IfModule>.) Do NOT set it to On as it
# prevents .htaccess files from disabling it.
<IfModule mod_userdir.c>
    <Directory /home/*/public_html>
        # php_admin_flag engine Off
    </Directory>
</IfModule>
```

è®Šæ›´ç©è¨­å®šå¾Œï¼Œé‡æ–°å•Ÿå‹• apache2 ä¼ºæœå™¨

``` {.bash .prefixed}
sudo systemctl restart apache2
```

## phpMyAdmin

phpMyAdmin æ˜¯ä¸€å€‹ä»¥ PHP ç‚ºåŸºç¤æ’°å¯«çš„ä¸€å€‹è»Ÿé«”ï¼Œå¯ä»¥è®“ä½¿ç”¨è€…ä»¥ç°¡æ˜“çš„æ–¹å¼æ–°å¢ã€æŸ¥è©¢ã€ä¿®æ”¹æˆ–æ˜¯åˆªé™¤è³‡æ–™åº«è£¡é¢çš„ç´€éŒ„ã€‚

### æ¦‚è¿°

æœ¬å°ç¯€æœƒèªªæ˜æ€éº¼å®‰è£ phpMyAdmin èˆ‡åŸºç¤çš„å®‰å…¨æ€§è¨­å®šã€‚

### å®‰è£ phpMyAdmin

ä¸€æ¨£åœ°ï¼Œç¢ºèª `phpmyadmin` çš„ç‰ˆæœ¬

``` {.bash .prefixed}
sudo apt info phpmyadmin
```

``` {.console_output}
Package: phpmyadmin
Version: 4:5.1.1+dfsg1-5ubuntu1
Priority: optional
Section: universe/web
Origin: Ubuntu
Maintainer: Ubuntu Developers <ubuntu-devel-discuss@lists.ubuntu.com>
Original-Maintainer: phpMyAdmin Packaging Team <team+phpmyadmin@tracker.debian.org>
Bugs: https://bugs.launchpad.net/ubuntu/+filebug
Installed-Size: 36.5 MB
[...]
```

ç¢ºèªå®Œç•¢å¾Œå®‰è£

``` {.bash .prefixed}
sudo apt install phpmyadmin --yes
```

é€™è£ç”¨ç©ºç™½éµå‹¾é¸ `apache2` ä½¿ä¸­æ‹¬è™Ÿä¸­è®Šæˆæ˜Ÿè™Ÿ `*`

```{r, fig.cap='phpMyAdmin å®‰è£å°è¦½'}
knitr::include_graphics(path = 'figures/phpmyadmin-installation_0.png')
```

é€™è£é¸æ“‡ `Yes` å³å¯é™¤éä½ æƒ³å° `phpmyadmin` åšæ›´è©³ç´°çš„è¨­å®š

```{r, fig.cap='phpMyAdmin å®‰è£å°è¦½'}
knitr::include_graphics(path = 'figures/phpmyadmin-installation_1.png')
```

ç•™ç©ºæœƒè‡ªå‹•ç”¢ç”Ÿä¾› `phpmyadmin` é€£ç·šè‡³ MySQL ç”¨çš„å¯†ç¢¼ï¼Œæ‰€ä»¥é€™è£¡ç›´æ¥æŒ‰ `Ok`

```{r, fig.cap='phpMyAdmin å®‰è£å°è¦½'}
knitr::include_graphics(path = 'figures/phpmyadmin-installation_2.png')
```

::: {.infobox .rmdnote}
ç•¶å‡ºç¾æ­¤éŒ¯èª¤æ™‚ä¸ç”¨å¤ªæ…Œå¼µï¼Œæ˜¯å› ç‚ºå®‰è£ MySQL æ™‚ï¼Œæœ‰é–‹å•Ÿ `Validate Password` æ’ä»¶å°è‡´çš„ï¼Œåªéœ€è¦é€éä¸‹åˆ—æŒ‡ä»¤æš«æ™‚é—œé–‰å³å¯ã€‚

```{r, fig.cap='phpMyAdmin å®‰è£å°è¦½ï¼ŒéŒ¯èª¤è¨Šæ¯'}
knitr::include_graphics(path = 'figures/phpmyadmin-installation-error.png')
```

ä»¥ root ç™»å…¥è³‡æ–™åº«

``` {.bash .prefixed}
mysql -u root -p
```

è§£é™¤å®‰è£æ’ä»¶ valid password

``` {.sqlmysql .prefixed_mysql}
uninstall component 'file://component_valid_password';
```

``` {.sqlmysql .prefixed_mysql}
exit;
```

åœ¨å®‰è£ä¸€æ¬¡ `phpmyadmin`

``` {.bash .prefixed}
sudo apt install phpmyadmin --yes
```

``` {.bash .prefixed}
mysql -u root -p
```

å°‡ valid password è£å›å»

``` {.sqlmysql .prefixed_mysql}
install component 'file://component_valid_password'
```

``` {.sqlmysql .prefixed_mysql}
exit;
```
:::

é‡æ–°å•Ÿå‹• Apache2

``` {.bash .prefixed}
sudo systemctl restart apache2
```

å¾ç¶²ç«™é€²å…¥ phpMyAdmin æ“ä½œä»‹é¢

    http://<è™›æ“¬ä¸»æ©Ÿçš„ ip åœ°å€>/phpmyadmin/

å¦‚æœæ‰¾ä¸åˆ°æ˜¯æ­£å¸¸çš„ï¼ˆå¦‚ä¸‹åœ–ï¼‰ï¼Œåœ¨ Ubuntu 20.04 å®‰è£ phpMyAdmin æ™‚ï¼Œæ²’æœ‰æ­£ç¢ºçš„è¨­å®šåˆ° phpMyAdminã€‚ å¯ä»¥åƒè€ƒ[é€™è£¡](https://askubuntu.com/questions/387062/how-to-solve-the-phpmyadmin-not-found-issue-after-upgrading-php-and-apache)ä¸‰æ¨“çš„è§£æ³•ï¼š

```{r, fig.cap='phpMyAdmin æ²’æœ‰æˆåŠŸè¨­å®šçš„é é¢'}
knitr::include_graphics(path = 'figures/phpmyadmin-main-page-failed.png')
```

æ‰‹å‹•è»Ÿé€£çµåˆ° Apache2 çš„è¨­å®šè³‡æ–™å¤¾

``` {.bash .prefixed}
sudo ln -s /etc/phpmyadmin/apache.conf /etc/apache2/conf-available/phpmyadmin.conf
```

æ¥è‘—å•Ÿå‹• phpMyAdmin çš„è¨­å®šæª”

``` {.bash .prefixed}
sudo a2enconf phpmyadmin
```

é‡æ–°å•Ÿå‹• Apache2

``` {.bash .prefixed}
sudo systemctl restart apache2
```

å†å¾ç€è¦½å™¨å˜—è©¦ä¸€æ¬¡é€£ç·š

    http://<è™›æ“¬ä¸»æ©Ÿçš„ ip åœ°å€>/phpmyadmin/

æˆåŠŸï½ ğŸŠ

```{r, fig.cap='phpMyAdmin é é¢'}
knitr::include_graphics(path = 'figures/phpmyadmin-main-page-successed.png')
```

å› ç‚ºç›®å‰ MySQL çš„ç‰ˆæœ¬ root å¸³è™Ÿé©—è­‰æ–¹å¼æ˜¯ä½¿ç”¨ socket_authã€‚ä½†æ˜¯ï¼ŒphpMyAdmin é è¨­å¸³æˆ¶éœ€è¦æœ‰å¯†ç¢¼ç•¶å…¥ï¼Œæ‰€ä»¥é€™è£¡æœ‰å…©å€‹åšæ³•ï¼š

1. å‰µå»ºä¸€å€‹æ–°çš„æ“æœ‰æ‰€æœ‰æ¬Šé™çš„ä½¿ç”¨è€…

ç”¨ root æ¬Šé™é€²å…¥ MySQL æŒ‡ä»¤ä»‹é¢

``` {.bash .prefixed}
sudo mysql
```

å»ºç«‹ä¸€å€‹ä½¿ç”¨å¯†ç¢¼ `asis0721` é©—è­‰çš„ä½¿ç”¨è€… `asis`

``` {.bash .prefixed_mysql}
CREATE USER 'asis'@'localhost' IDENTIFIED BY 'asis0721';
```

è³¦äºˆæ‰€æœ‰æ¬Šé™åœ¨ `asis` ä½¿ç”¨è€…ä¸Š

``` {.sqlmysql .prefixed_mysql}
GRANT ALL PRIVILEGES ON *.* TO 'asis'@'localhost';
```

ç«‹åˆ»åˆ·æ–°æ¬Šé™ï¼Œä½¿æ¬Šé™ç«‹å³ç”Ÿæ•ˆ

``` {.sqlmysql .prefixed_mysql}
FLUSH PRIVILEGES;
```

2. å°‡åŸæœ¬çš„å¸³è™Ÿèªè­‰æ–¹å¼æ”¹æ‰

ç”¨ root æ¬Šé™é€²å…¥ MySQL æŒ‡ä»¤ä»‹é¢

``` {.bash .prefixed}
sudo mysql
```

å°‡ root ä½¿ç”¨è€…æ”¹ç‚ºä½¿ç”¨å¯†ç¢¼ `notSecureChangeMe` é©—è­‰

``` {.sqlmysql .prefixed_mysql}
ALTER USER 'root'@'localhost' IDENTIFIED WITH caching_sha2_password BY 'notSecureChangeMe';
```

::: {.rmdwarning .infobox}
ä¸€æ—¦å°‡ root ä½¿ç”¨è€…çš„é©—è­‰æ–¹å¼æ”¹æˆç”¨å¯†ç¢¼é©—è­‰ï¼Œé‚£å¾€å¾Œç™»å…¥ MySQL çš„æŒ‡ä»¤ä»‹é¢éƒ½éœ€è¦åŠ ä¸Šæä¾›å¯†ç¢¼åƒæ•¸ `-p`

``` {.bash .prefixed}
mysql -u root -p
```

:::


### è¨­å®š phpMyAdmin

é è¨­çš„ç¶²å€ `http://<è™›æ“¬æ©Ÿå™¨çš„ ip ä½ç½®>/phpmyadmin` å¯¦åœ¨æ˜¯å¤ªå±éšªäº†ï¼Œå¦‚æœæœ‰äººæœ‰æ„ç ´å£ï¼Œåˆè¢«çŒœåˆ°ç®¡ç†å“¡çš„å¯†ç¢¼ï¼Œé‚£å°‡æœƒä¸€ç™¼ä¸å¯æ”¶æ‹¾ï¼Œæ‰€ä»¥æ¥ä¸‹ä¾†è¦æ”¹çš„æ˜¯ phpMyAdmin åœ¨ Apache2 ä¸­çš„è¨­å®šï¼Œå°‡é è¨­çš„ä½ç½®æ”¹æ‰è‡³å°‘æœƒå®‰å…¨ä¸€é»ã€‚

``` {.bash .prefixed}
sudo vim /etc/phpmyadmin/apache.conf
```

::: {.code-label}
/etc/phpmyadmin/apache.conf
:::

``` bash
# phpMyAdmin default Apache configuration

Alias /sql /usr/share/phpmyadmin # è®Šæ›´é€™è£¡

<Directory /usr/share/phpmyadmin>
    Options SymLinksIfOwnerMatch
    DirectoryIndex index.php
    AllowOverride All # æ–°å¢é€™è¡Œ

    [...]

</Directory>

[...]
```

::: {.infobox .info}
å› ç‚º `/etc/phpmyadmin/apache.conf` å·²è»Ÿé€£çµï¼ˆsoft-linkï¼‰è‡³ `/etc/apache2/conf-available/phpmyadmin.conf` æ‰€ä»¥è®Šæ›´`apache.conf` æ™‚ï¼Œä½æ–¼ Apache2 ä¸­çš„è¨­å®šæª”ä¹Ÿæœƒè·Ÿè‘—è®Šæ›´ã€‚
:::

é‡æ–°å•Ÿå‹• Apache2

``` {.bash .prefixed}
sudo systemctl restart apache2
```

å¾æ–°çš„ ip ä½å€é€²å…¥

    http://<è™›æ“¬æ©Ÿå™¨çš„ ip ä½å€>/sql/

```{r, fig.cap='å‰›æ‰æ›´æ–°çš„è·¯ç”±'}
knitr::include_graphics(path = "figures/phpmyadmin-main-page-successed.png")
```

<!-- ### Step 3 --- å†å¤šä¸€å±¤å­˜å–çš„å¯†ç¢¼ä¿è­· [å¯è·³é]

æ–°å¢ä¸€å€‹å«åš `.htaccess` çš„æª”æ¡ˆ

``` {.bash .prefixed}
sudo vim /usr/share/phpmyadmin/.htaccess
```

æ”¾å…¥è¨­å®š

``` bash
AuthType Basic
AuthName "é™åˆ¶å­˜å–çš„æª”æ¡ˆ"
AuthUserFile /etc/phpmyadmin/.htpasswd
Require valid-user
```

ç”¨ `htpasswd` æŒ‡ä»¤ä»¥ `.htpasswd` ç”Ÿæˆå¸³è™Ÿï¼Œé€™å€‹å¸³è™Ÿå«åš asisï¼Œæ­¤æ™‚æœƒæç¤ºä½ è¼¸å…¥å¯†ç¢¼ã€‚

``` {.bash .prefixed}
sudo htpasswd -c /etc/phpmyadmin/.htpasswd asis
```

::: {.infobox .info}
å¦‚æœè¦æ–°å¢å…¶ä»–ä½¿ç”¨è€…ï¼Œè«‹å°‡ `-c` åƒæ•¸ç§»é™¤

``` {.bash .prefixed}
sudo htpasswd /etc/phpmyadmin/.htpasswd otheruser
```
:::

å†é€²å…¥ä¸€æ¬¡ phpMyAdmin çš„ä½å€å˜—è©¦ï¼š

```{r, fig.cap='phpMyAdmin ç™»å…¥æç¤º'}
knitr::include_graphics(path = "figures/htaccess-prompt-login-panel.png")
```

æ­¤æ™‚æœƒè·³å‡ºä¸€å€‹ç™»å…¥ä»‹é¢ï¼Œéœ€è¦è¼¸å…¥å¯†ç¢¼æ‰èƒ½é€²å…¥ phpMyAdmin çš„é é¢ã€‚ å¦‚æœä¸éœ€è¦æ­¤è¨­å®šï¼Œç›´æ¥åˆªé™¤ä½æ–¼ `/etc/phpmyadmin/.htpasswd` çš„æª”æ¡ˆå³å¯ã€‚
-->